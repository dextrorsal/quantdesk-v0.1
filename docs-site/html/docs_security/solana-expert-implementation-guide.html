<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solana-Expert-Implementation-Guide - QuantDesk Documentation</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <style>
        body {
            font-family: 'JetBrains Mono', 'Monaco', 'Consolas', monospace;
            line-height: 1.6;
            color: #ffffff;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #000000;
            font-size: 14px;
        }
        .container {
            background: #000000;
            padding: 30px;
            border-radius: 8px;
            border: 1px solid #333333;
        }
        .back-link {
            margin-bottom: 20px;
        }
        .back-link a {
            color: #3b82f6;
            text-decoration: none;
            font-weight: bold;
            transition: color 0.3s ease;
        }
        .back-link a:hover {
            color: #60a5fa;
            text-decoration: underline;
        }
        h1, h2, h3, h4, h5, h6 {
            color: #ffffff;
            margin-top: 30px;
            margin-bottom: 15px;
            font-weight: 600;
        }
        h1 {
            border-bottom: 2px solid #333333;
            padding-bottom: 10px;
        }
        h2 {
            border-bottom: 1px solid #333333;
            padding-bottom: 8px;
        }
        code {
            background: #1a1a1a;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'JetBrains Mono', 'Monaco', 'Consolas', monospace;
            color: #ffffff;
            border: 1px solid #333333;
        }
        pre {
            background: #0a0a0a;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            border: 1px solid #333333;
            margin: 20px 0;
        }
        pre code {
            background: none;
            padding: 0;
            color: #ffffff;
            border: none;
        }
        blockquote {
            border-left: 4px solid #3b82f6;
            margin: 0;
            padding-left: 20px;
            color: #d9d9d9;
            background: #1a1a1a;
            padding: 15px 20px;
            border-radius: 0 8px 8px 0;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
            border: 1px solid #333333;
        }
        th, td {
            border: 1px solid #333333;
            padding: 12px;
            text-align: left;
        }
        th {
            background: #1a1a1a;
            font-weight: bold;
            color: #ffffff;
        }
        td {
            color: #d9d9d9;
        }
        ul, ol {
            color: #d9d9d9;
        }
        li {
            margin-bottom: 8px;
        }
        a {
            color: #3b82f6;
            text-decoration: none;
        }
        a:hover {
            color: #60a5fa;
            text-decoration: underline;
        }
        /* Syntax Highlighting Overrides */
        pre[class*="language-"] {
            background: #0a0a0a !important;
            border: 1px solid #333333 !important;
            border-radius: 8px !important;
            padding: 20px !important;
            margin: 20px 0 !important;
            font-family: 'JetBrains Mono', 'Monaco', 'Consolas', monospace !important;
            font-size: 13px !important;
            line-height: 1.5 !important;
        }
        .token.comment { color: #6a9955 !important; }
        .token.keyword { color: #569cd6 !important; }
        .token.string { color: #ce9178 !important; }
        .token.number { color: #b5cea8 !important; }
        .token.function { color: #dcdcaa !important; }
        .token.class-name { color: #4ec9b0 !important; }
        .token.operator { color: #d4d4d4 !important; }
        .token.punctuation { color: #d4d4d4 !important; }
        .token.variable { color: #9cdcfe !important; }
        .token.constant { color: #4fc1ff !important; }
    </style>
</head>
<body>
    <div class="container">
        <div class="back-link">
            <a href="/">&larr; Back to Documentation</a>
        </div>
        <h1>Solana Expert Implementation Guide</h1>
<h2>Overview</h2>
<p>This document captures the expert recommendations from Solana/Anchor specialists for implementing a secure, scalable perpetual DEX architecture. These guidelines ensure proper separation of on-chain and off-chain data, optimal performance, and security best practices.</p>
<h2>Expert Consultation Summary</h2>
<h3>Consultation Date: January 2025</h3>
<h3>Experts Consulted:</h3>
<ul>
<li><strong>Solana Expert via MCP</strong>: On-chain vs off-chain data architecture</li>
<li><strong>Anchor Framework Expert via MCP</strong>: Event-driven synchronization and RLS policies</li>
</ul>
<h2>Key Architectural Decisions</h2>
<h3>1. Hybrid Data Architecture (Recommended)</h3>
<p><strong>Decision</strong>: Use a hybrid approach combining on-chain state mirroring with off-chain historical data storage.</p>
<p><strong>Rationale</strong>: 
- Fast UI queries require cached current state
- Historical data enables analytics and reporting
- On-chain data provides single source of truth
- Off-chain data enables complex queries and filtering</p>
<p><strong>Implementation</strong>:</p>
<h4>Current State (Mirror in PostgreSQL)</h4>
<div class="codehilite"><pre><span></span><code><span class="c1">-- Essential current state for fast UI queries</span>
<span class="o">-</span><span class="w"> </span><span class="n">positions</span><span class="p">:</span><span class="w"> </span><span class="n">Mirror</span><span class="w"> </span><span class="n">active</span><span class="w"> </span><span class="n">positions</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="n">book</span><span class="w"> </span><span class="n">display</span>
<span class="o">-</span><span class="w"> </span><span class="n">orders</span><span class="p">:</span><span class="w"> </span><span class="n">Mirror</span><span class="w"> </span><span class="n">active</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">trading</span><span class="w"> </span><span class="n">interface</span>
<span class="o">-</span><span class="w"> </span><span class="n">market_data</span><span class="p">:</span><span class="w"> </span><span class="n">Mirror</span><span class="w"> </span><span class="k">current</span><span class="w"> </span><span class="n">market</span><span class="w"> </span><span class="k">state</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">UI</span><span class="w"> </span><span class="n">performance</span>
<span class="o">-</span><span class="w"> </span><span class="n">user_balances</span><span class="p">:</span><span class="w"> </span><span class="n">Mirror</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">fast</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="n">checks</span>
</code></pre></div>

<h4>Historical Data (Store in PostgreSQL)</h4>
<div class="codehilite"><pre><span></span><code><span class="c1">-- Complete historical data for analytics</span>
<span class="o">-</span><span class="w"> </span><span class="n">trades</span><span class="p">:</span><span class="w"> </span><span class="k">All</span><span class="w"> </span><span class="n">trade</span><span class="w"> </span><span class="n">history</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">analytics</span>
<span class="o">-</span><span class="w"> </span><span class="n">order_history</span><span class="p">:</span><span class="w"> </span><span class="n">Complete</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="n">lifecycle</span><span class="w"> </span><span class="n">tracking</span>
<span class="o">-</span><span class="w"> </span><span class="n">liquidations</span><span class="p">:</span><span class="w"> </span><span class="n">Historical</span><span class="w"> </span><span class="n">liquidation</span><span class="w"> </span><span class="k">data</span>
<span class="o">-</span><span class="w"> </span><span class="n">funding_rates</span><span class="p">:</span><span class="w"> </span><span class="n">Historical</span><span class="w"> </span><span class="n">funding</span><span class="w"> </span><span class="n">calculations</span>
<span class="o">-</span><span class="w"> </span><span class="n">oracle_prices</span><span class="p">:</span><span class="w"> </span><span class="n">Historical</span><span class="w"> </span><span class="n">price</span><span class="w"> </span><span class="k">data</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">charts</span><span class="o">/</span><span class="n">analytics</span>
</code></pre></div>

<h3>2. Oracle Price Caching Strategy</h3>
<p><strong>Expert Recommendation</strong>: Store Pyth oracle prices in PostgreSQL with public read access.</p>
<p><strong>Rationale</strong>:
- Oracle prices are public on-chain data
- Caching improves performance and reduces RPC calls
- Public read access is appropriate for oracle data
- Keep current prices synchronized with on-chain state</p>
<p><strong>Implementation</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">-- Oracle prices table with public read access</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">oracle_prices</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">uuid_generate_v4</span><span class="p">(),</span>
<span class="w">    </span><span class="n">symbol</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">price</span><span class="w"> </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">confidence</span><span class="w"> </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span>
<span class="w">    </span><span class="k">timestamp</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="k">TIME</span><span class="w"> </span><span class="k">ZONE</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<span class="w">    </span><span class="n">slot</span><span class="w"> </span><span class="nb">BIGINT</span><span class="p">,</span>
<span class="w">    </span><span class="k">source</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;pyth&#39;</span>
<span class="p">);</span>

<span class="c1">-- Public read policy for oracle data</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">POLICY</span><span class="w"> </span><span class="ss">&quot;Public can read oracle prices&quot;</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">oracle_prices</span>
<span class="w">    </span><span class="k">FOR</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
</code></pre></div>

<h3>3. User Privacy vs Blockchain Transparency</h3>
<p><strong>Key Insight</strong>: User positions and liquidations are public on Solana blockchain, but database should protect user privacy.</p>
<p><strong>Database Approach</strong>:
- Restrict individual user data with RLS policies
- Make aggregated data (total open interest, funding rates) public
- Protect user privacy even though on-chain data is public</p>
<p><strong>Implementation</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">-- User-specific data with RLS</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">POLICY</span><span class="w"> </span><span class="ss">&quot;Users can view own positions&quot;</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">positions</span>
<span class="w">    </span><span class="k">FOR</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="n">auth</span><span class="p">.</span><span class="n">jwt</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;&gt;</span><span class="w"> </span><span class="s1">&#39;wallet_address&#39;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="k">SELECT</span><span class="w"> </span><span class="n">wallet_address</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">user_id</span>
<span class="w">    </span><span class="p">));</span>

<span class="c1">-- Public aggregated data</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">VIEW</span><span class="w"> </span><span class="n">public_market_summary</span><span class="w"> </span><span class="k">AS</span>
<span class="k">SELECT</span><span class="w"> </span>
<span class="w">    </span><span class="n">m</span><span class="p">.</span><span class="n">symbol</span><span class="p">,</span>
<span class="w">    </span><span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">user_id</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">active_traders</span><span class="p">,</span>
<span class="w">    </span><span class="k">SUM</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="k">size</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">entry_price</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">total_open_interest</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">markets</span><span class="w"> </span><span class="n">m</span>
<span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">positions</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">market_id</span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="n">symbol</span><span class="p">;</span>
</code></pre></div>

<h2>Synchronization Strategy</h2>
<h3>Event-Driven Architecture (Recommended)</h3>
<p><strong>Expert Recommendation</strong>: Use Anchor events for all significant state changes.</p>
<p><strong>Benefits</strong>:
- Most reliable and scalable synchronization method
- Real-time updates without polling
- Efficient data transfer
- Built-in retry mechanisms</p>
<p><strong>Implementation</strong>:</p>
<h4>1. Anchor Events Definition</h4>
<div class="codehilite"><pre><span></span><code><span class="cp">#[event]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">OrderFilled</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">market</span>: <span class="nc">Pubkey</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">position_id</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">order_id</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">price</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">quantity</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">taker_fee</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">maker_fee</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[event]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">PositionUpdated</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">position_id</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">user</span>: <span class="nc">Pubkey</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">market</span>: <span class="nc">Pubkey</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">size</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">entry_price</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">unrealized_pnl</span>: <span class="kt">i64</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[event]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">LiquidationExecuted</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">position_id</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">user</span>: <span class="nc">Pubkey</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">market</span>: <span class="nc">Pubkey</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">liquidated_size</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">liquidation_price</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">penalty_fee</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>

<h4>2. Off-Chain Event Listener</h4>
<div class="codehilite"><pre><span></span><code><span class="c1">// Event listener service</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Program</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;@coral-xyz/anchor&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Connection</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;@solana/web3.js&quot;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">EventListener</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">program</span><span class="o">:</span><span class="w"> </span><span class="kt">Program</span><span class="p">;</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">connection</span><span class="o">:</span><span class="w"> </span><span class="kt">Connection</span><span class="p">;</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">subscribeToEvents</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Order filled events</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">program</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;OrderFilled&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">event</span><span class="p">,</span><span class="w"> </span><span class="nx">slot</span><span class="p">,</span><span class="w"> </span><span class="nx">signature</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">handleOrderFilled</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span><span class="w"> </span><span class="nx">signature</span><span class="p">);</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Position updated events</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">program</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;PositionUpdated&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">event</span><span class="p">,</span><span class="w"> </span><span class="nx">slot</span><span class="p">,</span><span class="w"> </span><span class="nx">signature</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">handlePositionUpdated</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span><span class="w"> </span><span class="nx">signature</span><span class="p">);</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Liquidation events</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">program</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;LiquidationExecuted&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">event</span><span class="p">,</span><span class="w"> </span><span class="nx">slot</span><span class="p">,</span><span class="w"> </span><span class="nx">signature</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">handleLiquidation</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span><span class="w"> </span><span class="nx">signature</span><span class="p">);</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="nx">handleOrderFilled</span><span class="p">(</span><span class="nx">event</span><span class="o">:</span><span class="w"> </span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="nx">signature</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Insert into trades table</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">database</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="sb">`</span>
<span class="sb">      INSERT INTO trades (signature, market_id, user_id, side, size, price, fees, timestamp)</span>
<span class="sb">      VALUES ($1, $2, $3, $4, $5, $6, $7, NOW())</span>
<span class="sb">    `</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nx">signature</span><span class="p">,</span><span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">market</span><span class="p">,</span><span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">user</span><span class="p">,</span><span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">side</span><span class="p">,</span><span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">quantity</span><span class="p">,</span><span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">price</span><span class="p">,</span><span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">taker_fee</span><span class="p">]);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h4>3. Database Event Storage</h4>
<div class="codehilite"><pre><span></span><code><span class="c1">-- Event storage tables</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">program_events</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">uuid_generate_v4</span><span class="p">(),</span>
<span class="w">    </span><span class="n">signature</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span><span class="w"> </span><span class="k">UNIQUE</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">slot</span><span class="w"> </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">event_type</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">event_data</span><span class="w"> </span><span class="n">JSONB</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">processed</span><span class="w"> </span><span class="nb">BOOLEAN</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">false</span><span class="p">,</span>
<span class="w">    </span><span class="n">created_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="k">TIME</span><span class="w"> </span><span class="k">ZONE</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<span class="p">);</span>

<span class="c1">-- Index for efficient querying</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_program_events_signature</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">program_events</span><span class="p">(</span><span class="n">signature</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_program_events_slot</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">program_events</span><span class="p">(</span><span class="n">slot</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_program_events_type</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">program_events</span><span class="p">(</span><span class="n">event_type</span><span class="p">);</span>
</code></pre></div>

<h2>RLS Policy Implementation</h2>
<h3>Expert-Recommended RLS Policies</h3>
<h4>1. Public Data (No RLS Needed)</h4>
<div class="codehilite"><pre><span></span><code><span class="c1">-- Market specifications</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">POLICY</span><span class="w"> </span><span class="ss">&quot;Public market access&quot;</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">markets</span>
<span class="w">    </span><span class="k">FOR</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="k">true</span><span class="p">);</span>

<span class="c1">-- Oracle prices</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">POLICY</span><span class="w"> </span><span class="ss">&quot;Public oracle prices&quot;</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">oracle_prices</span>
<span class="w">    </span><span class="k">FOR</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="k">true</span><span class="p">);</span>

<span class="c1">-- Funding rates</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">POLICY</span><span class="w"> </span><span class="ss">&quot;Public funding rates&quot;</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">funding_rates</span>
<span class="w">    </span><span class="k">FOR</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="k">true</span><span class="p">);</span>

<span class="c1">-- Market statistics</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">POLICY</span><span class="w"> </span><span class="ss">&quot;Public market stats&quot;</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">market_stats</span>
<span class="w">    </span><span class="k">FOR</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
</code></pre></div>

<h4>2. User-Specific Data (RLS Required)</h4>
<div class="codehilite"><pre><span></span><code><span class="c1">-- User positions</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">POLICY</span><span class="w"> </span><span class="ss">&quot;Users can view own positions&quot;</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">positions</span>
<span class="w">    </span><span class="k">FOR</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="n">auth</span><span class="p">.</span><span class="n">jwt</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;&gt;</span><span class="w"> </span><span class="s1">&#39;wallet_address&#39;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="k">SELECT</span><span class="w"> </span><span class="n">wallet_address</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">user_id</span>
<span class="w">    </span><span class="p">));</span>

<span class="c1">-- User orders</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">POLICY</span><span class="w"> </span><span class="ss">&quot;Users can view own orders&quot;</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">orders</span>
<span class="w">    </span><span class="k">FOR</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="n">auth</span><span class="p">.</span><span class="n">jwt</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;&gt;</span><span class="w"> </span><span class="s1">&#39;wallet_address&#39;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="k">SELECT</span><span class="w"> </span><span class="n">wallet_address</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">user_id</span>
<span class="w">    </span><span class="p">));</span>

<span class="c1">-- User trades</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">POLICY</span><span class="w"> </span><span class="ss">&quot;Users can view own trades&quot;</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">trades</span>
<span class="w">    </span><span class="k">FOR</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="n">auth</span><span class="p">.</span><span class="n">jwt</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;&gt;</span><span class="w"> </span><span class="s1">&#39;wallet_address&#39;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="k">SELECT</span><span class="w"> </span><span class="n">wallet_address</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">user_id</span>
<span class="w">    </span><span class="p">));</span>

<span class="c1">-- User liquidations</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">POLICY</span><span class="w"> </span><span class="ss">&quot;Users can view own liquidations&quot;</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">liquidations</span>
<span class="w">    </span><span class="k">FOR</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="n">auth</span><span class="p">.</span><span class="n">jwt</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;&gt;</span><span class="w"> </span><span class="s1">&#39;wallet_address&#39;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="k">SELECT</span><span class="w"> </span><span class="n">wallet_address</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">user_id</span>
<span class="w">    </span><span class="p">));</span>
</code></pre></div>

<h4>3. Admin-Only Data (Service Role Only)</h4>
<div class="codehilite"><pre><span></span><code><span class="c1">-- Admin users</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">POLICY</span><span class="w"> </span><span class="ss">&quot;Admin users service role only&quot;</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">admin_users</span>
<span class="w">    </span><span class="k">FOR</span><span class="w"> </span><span class="k">ALL</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="n">auth</span><span class="p">.</span><span class="k">role</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;service_role&#39;</span><span class="p">);</span>

<span class="c1">-- Admin audit logs</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">POLICY</span><span class="w"> </span><span class="ss">&quot;Admin audit logs service role only&quot;</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">admin_audit_logs</span>
<span class="w">    </span><span class="k">FOR</span><span class="w"> </span><span class="k">ALL</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="n">auth</span><span class="p">.</span><span class="k">role</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;service_role&#39;</span><span class="p">);</span>

<span class="c1">-- System events</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">POLICY</span><span class="w"> </span><span class="ss">&quot;System events service role only&quot;</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">system_events</span>
<span class="w">    </span><span class="k">FOR</span><span class="w"> </span><span class="k">ALL</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="n">auth</span><span class="p">.</span><span class="k">role</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;service_role&#39;</span><span class="p">);</span>
</code></pre></div>

<h2>Performance Optimization</h2>
<h3>Expert Recommendations</h3>
<h4>1. Database Indexing</h4>
<div class="codehilite"><pre><span></span><code><span class="c1">-- Critical indexes for performance</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_positions_user_market</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">positions</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span><span class="w"> </span><span class="n">market_id</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_orders_user_status</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">orders</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_trades_user_timestamp</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">trades</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span><span class="w"> </span><span class="n">created_at</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_oracle_prices_symbol_timestamp</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">oracle_prices</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span><span class="w"> </span><span class="k">timestamp</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_markets_active</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">markets</span><span class="p">(</span><span class="n">is_active</span><span class="p">)</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">is_active</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">;</span>
</code></pre></div>

<h4>2. Query Optimization</h4>
<div class="codehilite"><pre><span></span><code><span class="c1">-- Optimized user portfolio query</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="k">REPLACE</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="n">get_user_portfolio</span><span class="p">(</span><span class="n">user_wallet_address</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">)</span>
<span class="k">RETURNS</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">position_id</span><span class="w"> </span><span class="n">UUID</span><span class="p">,</span>
<span class="w">    </span><span class="n">market_symbol</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">    </span><span class="n">side</span><span class="w"> </span><span class="n">position_side</span><span class="p">,</span>
<span class="w">    </span><span class="k">size</span><span class="w"> </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span>
<span class="w">    </span><span class="n">entry_price</span><span class="w"> </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span>
<span class="w">    </span><span class="n">current_price</span><span class="w"> </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span>
<span class="w">    </span><span class="n">unrealized_pnl</span><span class="w"> </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span>
<span class="p">)</span>
<span class="k">SECURITY</span><span class="w"> </span><span class="k">DEFINER</span>
<span class="k">SET</span><span class="w"> </span><span class="n">search_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">public</span>
<span class="k">LANGUAGE</span><span class="w"> </span><span class="n">plpgsql</span>
<span class="k">AS</span><span class="w"> </span><span class="err">$$</span>
<span class="k">BEGIN</span>
<span class="w">    </span><span class="c1">-- Only allow users to query their own portfolio</span>
<span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="n">auth</span><span class="p">.</span><span class="n">jwt</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;&gt;</span><span class="w"> </span><span class="s1">&#39;wallet_address&#39;</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">user_wallet_address</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">        </span><span class="n">RAISE</span><span class="w"> </span><span class="k">EXCEPTION</span><span class="w"> </span><span class="s1">&#39;Unauthorized: Cannot access other users portfolio&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="p">;</span>

<span class="w">    </span><span class="k">RETURN</span><span class="w"> </span><span class="n">QUERY</span>
<span class="w">    </span><span class="k">SELECT</span><span class="w"> </span>
<span class="w">        </span><span class="n">p</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
<span class="w">        </span><span class="n">m</span><span class="p">.</span><span class="n">symbol</span><span class="p">,</span>
<span class="w">        </span><span class="n">p</span><span class="p">.</span><span class="n">side</span><span class="p">,</span>
<span class="w">        </span><span class="n">p</span><span class="p">.</span><span class="k">size</span><span class="p">,</span>
<span class="w">        </span><span class="n">p</span><span class="p">.</span><span class="n">entry_price</span><span class="p">,</span>
<span class="w">        </span><span class="n">p</span><span class="p">.</span><span class="n">current_price</span><span class="p">,</span>
<span class="w">        </span><span class="n">p</span><span class="p">.</span><span class="n">unrealized_pnl</span>
<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">positions</span><span class="w"> </span><span class="n">p</span>
<span class="w">    </span><span class="k">JOIN</span><span class="w"> </span><span class="n">markets</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">market_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="n">id</span>
<span class="w">    </span><span class="k">JOIN</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="n">u</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">user_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">u</span><span class="p">.</span><span class="n">id</span>
<span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">u</span><span class="p">.</span><span class="n">wallet_address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">user_wallet_address</span>
<span class="w">    </span><span class="k">AND</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="k">size</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="k">AND</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">is_liquidated</span><span class="p">;</span>
<span class="k">END</span><span class="p">;</span>
<span class="err">$$</span><span class="p">;</span>
</code></pre></div>

<h4>3. Caching Strategy</h4>
<div class="codehilite"><pre><span></span><code><span class="c1">// Redis caching for frequently accessed data</span>
<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">CacheService</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">redis</span><span class="o">:</span><span class="w"> </span><span class="kt">Redis</span><span class="p">;</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">cacheMarketData</span><span class="p">(</span><span class="nx">symbol</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="kt">any</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">redis</span><span class="p">.</span><span class="nx">setex</span><span class="p">(</span><span class="sb">`market:</span><span class="si">${</span><span class="nx">symbol</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="mf">300</span><span class="p">,</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">data</span><span class="p">));</span><span class="w"> </span><span class="c1">// 5 min cache</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">getCachedMarketData</span><span class="p">(</span><span class="nx">symbol</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">cached</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">redis</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="sb">`market:</span><span class="si">${</span><span class="nx">symbol</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">cached</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">cached</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">cacheUserPortfolio</span><span class="p">(</span><span class="nx">walletAddress</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">portfolio</span><span class="o">:</span><span class="w"> </span><span class="kt">any</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">redis</span><span class="p">.</span><span class="nx">setex</span><span class="p">(</span><span class="sb">`portfolio:</span><span class="si">${</span><span class="nx">walletAddress</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="mf">60</span><span class="p">,</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">portfolio</span><span class="p">));</span><span class="w"> </span><span class="c1">// 1 min cache</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h2>Security Best Practices</h2>
<h3>Expert-Recommended Security Measures</h3>
<h4>1. Principle of Least Privilege</h4>
<div class="codehilite"><pre><span></span><code><span class="c1">-- Revoke overly permissive grants</span>
<span class="k">REVOKE</span><span class="w"> </span><span class="k">ALL</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">ALL</span><span class="w"> </span><span class="n">TABLES</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="k">SCHEMA</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">anon</span><span class="p">;</span>
<span class="k">REVOKE</span><span class="w"> </span><span class="k">ALL</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">ALL</span><span class="w"> </span><span class="n">FUNCTIONS</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="k">SCHEMA</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">anon</span><span class="p">;</span>
<span class="k">REVOKE</span><span class="w"> </span><span class="k">ALL</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">ALL</span><span class="w"> </span><span class="n">SEQUENCES</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="k">SCHEMA</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">anon</span><span class="p">;</span>

<span class="c1">-- Grant selective permissions</span>
<span class="k">GRANT</span><span class="w"> </span><span class="k">USAGE</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">SCHEMA</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">anon</span><span class="p">,</span><span class="w"> </span><span class="n">authenticated</span><span class="p">;</span>

<span class="c1">-- Public tables (read-only for anon)</span>
<span class="k">GRANT</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">markets</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">anon</span><span class="p">,</span><span class="w"> </span><span class="n">authenticated</span><span class="p">;</span>
<span class="k">GRANT</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">oracle_prices</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">anon</span><span class="p">,</span><span class="w"> </span><span class="n">authenticated</span><span class="p">;</span>

<span class="c1">-- Authenticated user tables (RLS enforced)</span>
<span class="k">GRANT</span><span class="w"> </span><span class="k">SELECT</span><span class="p">,</span><span class="w"> </span><span class="k">INSERT</span><span class="p">,</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">authenticated</span><span class="p">;</span>
<span class="k">GRANT</span><span class="w"> </span><span class="k">SELECT</span><span class="p">,</span><span class="w"> </span><span class="k">INSERT</span><span class="p">,</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">positions</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">authenticated</span><span class="p">;</span>
</code></pre></div>

<h4>2. Service Role Isolation</h4>
<div class="codehilite"><pre><span></span><code><span class="c1">-- Service role has full access for backend operations</span>
<span class="k">GRANT</span><span class="w"> </span><span class="k">ALL</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">ALL</span><span class="w"> </span><span class="n">TABLES</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="k">SCHEMA</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">service_role</span><span class="p">;</span>
<span class="k">GRANT</span><span class="w"> </span><span class="k">ALL</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">ALL</span><span class="w"> </span><span class="n">SEQUENCES</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="k">SCHEMA</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">service_role</span><span class="p">;</span>
<span class="k">GRANT</span><span class="w"> </span><span class="k">ALL</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">ALL</span><span class="w"> </span><span class="n">FUNCTIONS</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="k">SCHEMA</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">service_role</span><span class="p">;</span>
</code></pre></div>

<h4>3. Input Validation</h4>
<div class="codehilite"><pre><span></span><code><span class="c1">// Joi validation schemas</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">positionSchema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Joi</span><span class="p">.</span><span class="nx">object</span><span class="p">({</span>
<span class="w">  </span><span class="nx">market_id</span><span class="o">:</span><span class="w"> </span><span class="kt">Joi.string</span><span class="p">().</span><span class="nx">uuid</span><span class="p">().</span><span class="nx">required</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">side</span><span class="o">:</span><span class="w"> </span><span class="kt">Joi.string</span><span class="p">().</span><span class="nx">valid</span><span class="p">(</span><span class="s1">&#39;long&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;short&#39;</span><span class="p">).</span><span class="nx">required</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">size</span><span class="o">:</span><span class="w"> </span><span class="kt">Joi.number</span><span class="p">().</span><span class="nx">positive</span><span class="p">().</span><span class="nx">required</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">leverage</span><span class="o">:</span><span class="w"> </span><span class="kt">Joi.number</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mf">1</span><span class="p">).</span><span class="nx">max</span><span class="p">(</span><span class="mf">100</span><span class="p">).</span><span class="nx">required</span><span class="p">()</span>
<span class="p">});</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">orderSchema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Joi</span><span class="p">.</span><span class="nx">object</span><span class="p">({</span>
<span class="w">  </span><span class="nx">market_id</span><span class="o">:</span><span class="w"> </span><span class="kt">Joi.string</span><span class="p">().</span><span class="nx">uuid</span><span class="p">().</span><span class="nx">required</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">side</span><span class="o">:</span><span class="w"> </span><span class="kt">Joi.string</span><span class="p">().</span><span class="nx">valid</span><span class="p">(</span><span class="s1">&#39;buy&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;sell&#39;</span><span class="p">).</span><span class="nx">required</span><span class="p">(),</span>
<span class="w">  </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="nx">Joi</span><span class="p">.</span><span class="kt">string</span><span class="p">().</span><span class="nx">valid</span><span class="p">(</span><span class="s1">&#39;market&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;limit&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;stop_loss&#39;</span><span class="p">).</span><span class="nx">required</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">size</span><span class="o">:</span><span class="w"> </span><span class="kt">Joi.number</span><span class="p">().</span><span class="nx">positive</span><span class="p">().</span><span class="nx">required</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">price</span><span class="o">:</span><span class="w"> </span><span class="kt">Joi.number</span><span class="p">().</span><span class="nx">positive</span><span class="p">().</span><span class="nx">optional</span><span class="p">()</span>
<span class="p">});</span>
</code></pre></div>

<h2>Error Handling and Monitoring</h2>
<h3>Expert Recommendations</h3>
<h4>1. Comprehensive Error Handling</h4>
<div class="codehilite"><pre><span></span><code><span class="c1">// Error handling middleware</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">errorHandler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">Error</span><span class="p">,</span><span class="w"> </span><span class="nx">req</span><span class="o">:</span><span class="w"> </span><span class="kt">Request</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="o">:</span><span class="w"> </span><span class="kt">Response</span><span class="p">,</span><span class="w"> </span><span class="nx">next</span><span class="o">:</span><span class="w"> </span><span class="kt">NextFunction</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Database error:&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">error.message</span><span class="p">,</span>
<span class="w">    </span><span class="nx">stack</span><span class="o">:</span><span class="w"> </span><span class="kt">error.stack</span><span class="p">,</span>
<span class="w">    </span><span class="nx">query</span><span class="o">:</span><span class="w"> </span><span class="kt">req.body</span><span class="p">,</span>
<span class="w">    </span><span class="nx">user</span><span class="o">:</span><span class="w"> </span><span class="kt">req.user?.id</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="c1">// Don&#39;t expose internal errors to clients</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="nx">DatabaseError</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span>
<span class="w">      </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Database operation failed&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;DATABASE_ERROR&#39;</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Handle specific error types</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;RLS&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">403</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span>
<span class="w">      </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Access denied&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ACCESS_DENIED&#39;</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span>
<span class="w">    </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Internal server error&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;INTERNAL_ERROR&#39;</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">};</span>
</code></pre></div>

<h4>2. Event Processing Monitoring</h4>
<div class="codehilite"><pre><span></span><code><span class="c1">// Event processing health check</span>
<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">EventProcessor</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">processedEvents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Map</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">number</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">failedEvents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Map</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">number</span><span class="o">&gt;</span><span class="p">();</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">processEvent</span><span class="p">(</span><span class="nx">event</span><span class="o">:</span><span class="w"> </span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="nx">signature</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">handleEvent</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">processedEvents</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">signature</span><span class="p">,</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">failedEvents</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">signature</span><span class="p">,</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">());</span>
<span class="w">      </span><span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Event processing failed:&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">signature</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="nx">error</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">getHealthStatus</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">processed</span><span class="o">:</span><span class="w"> </span><span class="kt">this.processedEvents.size</span><span class="p">,</span>
<span class="w">      </span><span class="nx">failed</span><span class="o">:</span><span class="w"> </span><span class="kt">this.failedEvents.size</span><span class="p">,</span>
<span class="w">      </span><span class="nx">success_rate</span><span class="o">:</span><span class="w"> </span><span class="kt">this.processedEvents.size</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">processedEvents</span><span class="p">.</span><span class="nx">size</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">failedEvents</span><span class="p">.</span><span class="nx">size</span><span class="p">)</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h2>Implementation Checklist</h2>
<h3>Phase 1: Database Security</h3>
<ul>
<li>[ ] Apply RLS policies to all sensitive tables</li>
<li>[ ] Create secure views for public data</li>
<li>[ ] Implement service role isolation</li>
<li>[ ] Run security verification tests</li>
</ul>
<h3>Phase 2: Event-Driven Synchronization</h3>
<ul>
<li>[ ] Define Anchor events for all state changes</li>
<li>[ ] Implement off-chain event listener</li>
<li>[ ] Create event storage tables</li>
<li>[ ] Set up event processing pipeline</li>
</ul>
<h3>Phase 3: Performance Optimization</h3>
<ul>
<li>[ ] Add critical database indexes</li>
<li>[ ] Implement Redis caching</li>
<li>[ ] Optimize frequently used queries</li>
<li>[ ] Set up performance monitoring</li>
</ul>
<h3>Phase 4: Security Hardening</h3>
<ul>
<li>[ ] Implement input validation</li>
<li>[ ] Set up comprehensive error handling</li>
<li>[ ] Configure monitoring and alerting</li>
<li>[ ] Regular security audits</li>
</ul>
<h2>Future Considerations</h2>
<h3>Scalability</h3>
<ul>
<li>Consider database partitioning for large tables</li>
<li>Implement read replicas for analytics queries</li>
<li>Use connection pooling for high concurrency</li>
</ul>
<h3>Advanced Features</h3>
<ul>
<li>Implement real-time notifications via WebSockets</li>
<li>Add advanced analytics and reporting</li>
<li>Consider implementing a GraphQL API for complex queries</li>
</ul>
<h3>Monitoring</h3>
<ul>
<li>Set up comprehensive logging</li>
<li>Implement health checks for all services</li>
<li>Monitor database performance and query times</li>
<li>Track event processing latency</li>
</ul>
<h2>Conclusion</h2>
<p>This implementation guide provides a comprehensive roadmap for building a secure, scalable perpetual DEX following Solana expert recommendations. The hybrid architecture ensures optimal performance while maintaining security and data integrity.</p>
<p>Key takeaways:
1. <strong>Hybrid Architecture</strong>: Mirror current state, store historical data
2. <strong>Event-Driven Sync</strong>: Use Anchor events for reliable synchronization
3. <strong>RLS Security</strong>: Implement comprehensive row-level security
4. <strong>Performance First</strong>: Optimize queries and implement caching
5. <strong>Security Hardened</strong>: Follow principle of least privilege</p>
<p>Regular reviews and updates of this guide ensure continued alignment with best practices and evolving requirements.</p>
    </div>
</body>
</html>