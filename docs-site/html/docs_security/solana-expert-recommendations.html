<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solana-Expert-Recommendations - QuantDesk Documentation</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <style>
        body {
            font-family: 'JetBrains Mono', 'Monaco', 'Consolas', monospace;
            line-height: 1.6;
            color: #ffffff;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #000000;
            font-size: 14px;
        }
        .container {
            background: #000000;
            padding: 30px;
            border-radius: 8px;
            border: 1px solid #333333;
        }
        .back-link {
            margin-bottom: 20px;
        }
        .back-link a {
            color: #3b82f6;
            text-decoration: none;
            font-weight: bold;
            transition: color 0.3s ease;
        }
        .back-link a:hover {
            color: #60a5fa;
            text-decoration: underline;
        }
        h1, h2, h3, h4, h5, h6 {
            color: #ffffff;
            margin-top: 30px;
            margin-bottom: 15px;
            font-weight: 600;
        }
        h1 {
            border-bottom: 2px solid #333333;
            padding-bottom: 10px;
        }
        h2 {
            border-bottom: 1px solid #333333;
            padding-bottom: 8px;
        }
        code {
            background: #1a1a1a;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'JetBrains Mono', 'Monaco', 'Consolas', monospace;
            color: #ffffff;
            border: 1px solid #333333;
        }
        pre {
            background: #0a0a0a;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            border: 1px solid #333333;
            margin: 20px 0;
        }
        pre code {
            background: none;
            padding: 0;
            color: #ffffff;
            border: none;
        }
        blockquote {
            border-left: 4px solid #3b82f6;
            margin: 0;
            padding-left: 20px;
            color: #d9d9d9;
            background: #1a1a1a;
            padding: 15px 20px;
            border-radius: 0 8px 8px 0;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
            border: 1px solid #333333;
        }
        th, td {
            border: 1px solid #333333;
            padding: 12px;
            text-align: left;
        }
        th {
            background: #1a1a1a;
            font-weight: bold;
            color: #ffffff;
        }
        td {
            color: #d9d9d9;
        }
        ul, ol {
            color: #d9d9d9;
        }
        li {
            margin-bottom: 8px;
        }
        a {
            color: #3b82f6;
            text-decoration: none;
        }
        a:hover {
            color: #60a5fa;
            text-decoration: underline;
        }
        /* Syntax Highlighting Overrides */
        pre[class*="language-"] {
            background: #0a0a0a !important;
            border: 1px solid #333333 !important;
            border-radius: 8px !important;
            padding: 20px !important;
            margin: 20px 0 !important;
            font-family: 'JetBrains Mono', 'Monaco', 'Consolas', monospace !important;
            font-size: 13px !important;
            line-height: 1.5 !important;
        }
        .token.comment { color: #6a9955 !important; }
        .token.keyword { color: #569cd6 !important; }
        .token.string { color: #ce9178 !important; }
        .token.number { color: #b5cea8 !important; }
        .token.function { color: #dcdcaa !important; }
        .token.class-name { color: #4ec9b0 !important; }
        .token.operator { color: #d4d4d4 !important; }
        .token.punctuation { color: #d4d4d4 !important; }
        .token.variable { color: #9cdcfe !important; }
        .token.constant { color: #4fc1ff !important; }
    </style>
</head>
<body>
    <div class="container">
        <div class="back-link">
            <a href="/">&larr; Back to Documentation</a>
        </div>
        <h1>Solana Expert Recommendations for Database Architecture</h1>
<h2>On-Chain vs Off-Chain Data Separation</h2>
<h3>Recommended Architecture: Hybrid Approach</h3>
<p><strong>Current State (Mirror in PostgreSQL):</strong>
- <strong>Positions</strong>: Mirror essential current state for fast UI queries
- <strong>Orders</strong>: Mirror active orders for order book display
- <strong>Market Data</strong>: Mirror current market state for UI performance
- <strong>User Balances</strong>: Mirror for fast balance checks</p>
<p><strong>Historical Data (Store in PostgreSQL):</strong>
- <strong>Trades</strong>: All trade history for analytics
- <strong>Order History</strong>: Complete order lifecycle tracking
- <strong>Liquidations</strong>: Historical liquidation data
- <strong>Funding Rates</strong>: Historical funding calculations
- <strong>Oracle Prices</strong>: Historical price data for charts/analytics</p>
<h3>Oracle Price Caching Strategy</h3>
<p><strong>Recommendation</strong>: Store Pyth oracle prices in PostgreSQL with public read access
- <strong>Rationale</strong>: Oracle prices are public on-chain data, caching improves performance
- <strong>Best Practice</strong>: Keep current prices synchronized with on-chain state
- <strong>Security</strong>: Public read access is appropriate for oracle data</p>
<h3>User Privacy vs Blockchain Transparency</h3>
<p><strong>Key Insight</strong>: User positions and liquidations are public on Solana blockchain
- <strong>Database Approach</strong>: Restrict individual user data with RLS policies
- <strong>Public Data</strong>: Make aggregated data (total open interest, funding rates) public
- <strong>Rationale</strong>: While on-chain data is public, database should protect user privacy</p>
<h2>Synchronization Strategy</h2>
<h3>Event-Driven Architecture (Recommended)</h3>
<p><strong>Anchor Events</strong>: Emit events for all significant state changes
- OrderFilled, PositionUpdated, LiquidationExecuted, etc.
- Include all relevant data in events to avoid additional RPC calls</p>
<p><strong>Off-Chain Listener</strong>: 
- Subscribe to program events using Anchor event listeners
- Parse events and update PostgreSQL with proper transactions
- Implement idempotency and error handling</p>
<h3>Example Event Structure</h3>
<div class="codehilite"><pre><span></span><code><span class="cp">#[event]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">OrderFilled</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">market</span>: <span class="nc">Pubkey</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">position_id</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">order_id</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">price</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">quantity</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">taker_fee</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">maker_fee</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>

<h2>RLS Policy Recommendations</h2>
<h3>Public Data (No RLS needed)</h3>
<ul>
<li><code>markets</code> - Market specifications</li>
<li><code>oracle_prices</code> - Public price data</li>
<li><code>funding_rates</code> - Public funding calculations</li>
<li><code>market_stats</code> - Aggregated market statistics</li>
</ul>
<h3>User-Specific Data (RLS Required)</h3>
<ul>
<li><code>positions</code> - Users can only see their own positions</li>
<li><code>orders</code> - Users can only see their own orders</li>
<li><code>trades</code> - Users can only see their own trades</li>
<li><code>liquidations</code> - Users can only see their own liquidations</li>
<li><code>user_balances</code> - Users can only see their own balances</li>
</ul>
<h3>Admin-Only Data (Service Role Only)</h3>
<ul>
<li><code>admin_users</code> - Admin authentication data</li>
<li><code>admin_audit_logs</code> - Admin action logs</li>
<li><code>system_events</code> - System debugging information</li>
</ul>
<h2>Implementation Priority</h2>
<ol>
<li><strong>Phase 1</strong>: Implement comprehensive RLS policies</li>
<li><strong>Phase 2</strong>: Set up event-driven synchronization</li>
<li><strong>Phase 3</strong>: Optimize for performance and scalability</li>
</ol>
<h2>Security Considerations</h2>
<ul>
<li><strong>Principle of Least Privilege</strong>: Grant minimal necessary permissions</li>
<li><strong>Service Role</strong>: Use service_role for backend operations only</li>
<li><strong>Public Access</strong>: Limit to truly public data (markets, prices)</li>
<li><strong>User Privacy</strong>: Protect individual user data even if on-chain data is public</li>
</ul>
    </div>
</body>
</html>