<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1.1-Implementation-Plan - QuantDesk Documentation</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <style>
        body {
            font-family: 'JetBrains Mono', 'Monaco', 'Consolas', monospace;
            line-height: 1.6;
            color: #ffffff;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #000000;
            font-size: 14px;
        }
        .container {
            background: #000000;
            padding: 30px;
            border-radius: 8px;
            border: 1px solid #333333;
        }
        .back-link {
            margin-bottom: 20px;
        }
        .back-link a {
            color: #3b82f6;
            text-decoration: none;
            font-weight: bold;
            transition: color 0.3s ease;
        }
        .back-link a:hover {
            color: #60a5fa;
            text-decoration: underline;
        }
        h1, h2, h3, h4, h5, h6 {
            color: #ffffff;
            margin-top: 30px;
            margin-bottom: 15px;
            font-weight: 600;
        }
        h1 {
            border-bottom: 2px solid #333333;
            padding-bottom: 10px;
        }
        h2 {
            border-bottom: 1px solid #333333;
            padding-bottom: 8px;
        }
        code {
            background: #1a1a1a;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'JetBrains Mono', 'Monaco', 'Consolas', monospace;
            color: #ffffff;
            border: 1px solid #333333;
        }
        pre {
            background: #0a0a0a;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            border: 1px solid #333333;
            margin: 20px 0;
        }
        pre code {
            background: none;
            padding: 0;
            color: #ffffff;
            border: none;
        }
        blockquote {
            border-left: 4px solid #3b82f6;
            margin: 0;
            padding-left: 20px;
            color: #d9d9d9;
            background: #1a1a1a;
            padding: 15px 20px;
            border-radius: 0 8px 8px 0;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
            border: 1px solid #333333;
        }
        th, td {
            border: 1px solid #333333;
            padding: 12px;
            text-align: left;
        }
        th {
            background: #1a1a1a;
            font-weight: bold;
            color: #ffffff;
        }
        td {
            color: #d9d9d9;
        }
        ul, ol {
            color: #d9d9d9;
        }
        li {
            margin-bottom: 8px;
        }
        a {
            color: #3b82f6;
            text-decoration: none;
        }
        a:hover {
            color: #60a5fa;
            text-decoration: underline;
        }
        /* Syntax Highlighting Overrides */
        pre[class*="language-"] {
            background: #0a0a0a !important;
            border: 1px solid #333333 !important;
            border-radius: 8px !important;
            padding: 20px !important;
            margin: 20px 0 !important;
            font-family: 'JetBrains Mono', 'Monaco', 'Consolas', monospace !important;
            font-size: 13px !important;
            line-height: 1.5 !important;
        }
        .token.comment { color: #6a9955 !important; }
        .token.keyword { color: #569cd6 !important; }
        .token.string { color: #ce9178 !important; }
        .token.number { color: #b5cea8 !important; }
        .token.function { color: #dcdcaa !important; }
        .token.class-name { color: #4ec9b0 !important; }
        .token.operator { color: #d4d4d4 !important; }
        .token.punctuation { color: #d4d4d4 !important; }
        .token.variable { color: #9cdcfe !important; }
        .token.constant { color: #4fc1ff !important; }
    </style>
</head>
<body>
    <div class="container">
        <div class="back-link">
            <a href="/">&larr; Back to Documentation</a>
        </div>
        <h1>Story 1.1 Implementation Plan: Real-time Portfolio Updates (REVISED)</h1>
<h2>Executive Summary</h2>
<p>This <strong>revised plan</strong> focuses on <strong>fixing and integrating existing components</strong> rather than building from scratch. The infrastructure is largely in place - we need to connect the pieces and fix specific issues.</p>
<h2>Current State Analysis (REVISED)</h2>
<h3>‚úÖ Already Implemented &amp; Working</h3>
<ul>
<li><strong>Smart Contracts</strong>: Complete Anchor program with all structs (Order, Position, UserAccount, etc.)</li>
<li><strong>WebSocket Infrastructure</strong>: Backend Socket.IO server with authentication</li>
<li><strong>Portfolio Services</strong>: Backend portfolio analytics and frontend portfolio service</li>
<li><strong>Portfolio Components</strong>: PortfolioDashboard and PositionsTable components</li>
<li><strong>Market Data WebSocket</strong>: Real-time market data updates working</li>
<li><strong>Balance Services</strong>: SOL balance fetching and token balance calculations</li>
<li><strong>Deposit/Withdraw</strong>: Smart contract integration for deposits and withdrawals</li>
</ul>
<h3>üîß Issues to Fix (Not Missing Components)</h3>
<ol>
<li><strong>Transaction Status Display</strong>: Frontend shows "failed" when transactions actually succeed</li>
<li><strong>Balance Calculation</strong>: Wrong balance display - shows deposited amount vs. actual worth</li>
<li><strong>WebSocket Integration</strong>: Portfolio components use polling instead of existing WebSocket</li>
<li><strong>Real-time Updates</strong>: Need to connect existing WebSocket to portfolio data</li>
<li><strong>Error Handling</strong>: Improve error messages and transaction status reporting</li>
</ol>
<h2>Implementation Strategy (REVISED)</h2>
<h3>Phase 1: Fix Transaction Status &amp; Error Handling (Priority: Critical)</h3>
<h4>1.1 Fix Transaction Status Display</h4>
<p><strong>File</strong>: <code>frontend/src/services/smartContractService.ts</code>
<strong>Estimated Time</strong>: 2 hours</p>
<p><strong>Issues Found</strong>:
- Generic error messages like "Transaction failed: Unknown error"
- No proper transaction confirmation checking
- Error handling doesn't distinguish between user rejection and actual failures</p>
<p><strong>Fixes</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Improve error handling in createUserAccount, depositNativeSOL, etc.</span>
<span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">any</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;‚ùå Transaction error:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Better error classification</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="o">?</span><span class="p">.</span><span class="nx">message</span><span class="o">?</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;User rejected&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Transaction cancelled by user&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="o">?</span><span class="p">.</span><span class="nx">message</span><span class="o">?</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;Insufficient&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Insufficient funds for transaction&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="o">?</span><span class="p">.</span><span class="nx">message</span><span class="o">?</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;Blockhash&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Transaction expired - please try again&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="o">?</span><span class="p">.</span><span class="nx">logs</span><span class="o">?</span><span class="p">.</span><span class="nx">some</span><span class="p">(</span><span class="nx">log</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">log</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;success&#39;</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Transaction actually succeeded despite error</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;‚úÖ Transaction succeeded despite error message&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">signature</span><span class="p">;</span><span class="w"> </span><span class="c1">// Return success</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`Transaction failed: </span><span class="si">${</span><span class="nx">error</span><span class="o">?</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;Unknown error&#39;</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h4>1.2 Fix Balance Calculation Issues</h4>
<p><strong>File</strong>: <code>frontend/src/services/balanceService.ts</code>
<strong>Estimated Time</strong>: 3 hours</p>
<p><strong>Issues Found</strong>:
- Mock SOL price of $100 instead of real price
- Balance calculations don't reflect actual deposited amounts
- No integration with smart contract collateral balances</p>
<p><strong>Fixes</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Replace mock pricing with real oracle data</span>
<span class="k">async</span><span class="w"> </span><span class="nx">getUserBalances</span><span class="p">(</span><span class="nx">walletAddress</span><span class="o">:</span><span class="w"> </span><span class="kt">PublicKey</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">UserBalances</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Get real SOL price from oracle</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">solPrice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getRealSOLPrice</span><span class="p">();</span><span class="w"> </span><span class="c1">// Use existing oracle</span>

<span class="w">  </span><span class="c1">// Get actual collateral balance from smart contract</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">collateralBalance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">smartContractService</span><span class="p">.</span><span class="nx">getSOLCollateralBalance</span><span class="p">(</span>
<span class="w">    </span><span class="nx">walletAddress</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
<span class="w">  </span><span class="p">);</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">totalValueUSD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">collateralBalance</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">solPrice</span><span class="p">;</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">nativeSOL</span><span class="o">:</span><span class="w"> </span><span class="kt">collateralBalance</span><span class="p">,</span><span class="w"> </span><span class="c1">// Use actual deposited amount</span>
<span class="w">    </span><span class="nx">tokens</span><span class="o">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">    </span><span class="nx">totalValueUSD</span><span class="p">,</span>
<span class="w">  </span><span class="p">};</span>
<span class="p">}</span>
</code></pre></div>

<h3>Phase 2: Connect Existing WebSocket to Portfolio (Priority: High)</h3>
<h4>2.1 Extend Existing WebSocket Service</h4>
<p><strong>File</strong>: <code>backend/src/services/websocket.ts</code>
<strong>Estimated Time</strong>: 3 hours</p>
<p><strong>Implementation</strong>: Add portfolio events to existing WebSocketService</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Add to existing setupSocketHandlers():</span>
<span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;subscribe_portfolio&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">userId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">userId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">socket</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="sb">`portfolio:</span><span class="si">${</span><span class="nx">socket</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">userId</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">    </span><span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="sb">`User </span><span class="si">${</span><span class="nx">socket</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">userId</span><span class="si">}</span><span class="sb"> subscribed to portfolio updates`</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">});</span>

<span class="c1">// Add portfolio update broadcasting</span>
<span class="k">private</span><span class="w"> </span><span class="nx">broadcastPortfolioUpdate</span><span class="p">(</span><span class="nx">userId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">portfolioData</span><span class="o">:</span><span class="w"> </span><span class="kt">any</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">io</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="sb">`portfolio:</span><span class="si">${</span><span class="nx">userId</span><span class="si">}</span><span class="sb">`</span><span class="p">).</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;portfolio_update&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;portfolio_update&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="kt">portfolioData</span><span class="p">,</span>
<span class="w">    </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="kt">Date.now</span><span class="p">()</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">}</span>
</code></pre></div>

<h4>2.2 Add Portfolio Update Background Task</h4>
<p><strong>File</strong>: <code>backend/src/services/websocket.ts</code>
<strong>Estimated Time</strong>: 2 hours</p>
<p><strong>Implementation</strong>: Add to existing WebSocketService</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Add portfolio update interval to existing service</span>
<span class="k">private</span><span class="w"> </span><span class="nx">startPortfolioUpdates</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">setInterval</span><span class="p">(</span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Get all connected users</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">connectedUsers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">connectedClients</span><span class="p">.</span><span class="nx">keys</span><span class="p">());</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">connectedUsers</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Calculate portfolio using existing services</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">portfolioData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">calculateUserPortfolio</span><span class="p">(</span><span class="nx">userId</span><span class="p">);</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">broadcastPortfolioUpdate</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span><span class="w"> </span><span class="nx">portfolioData</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">`Error updating portfolio for user </span><span class="si">${</span><span class="nx">userId</span><span class="si">}</span><span class="sb">:`</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="mf">5000</span><span class="p">);</span><span class="w"> </span><span class="c1">// Every 5 seconds</span>
<span class="p">}</span>
</code></pre></div>

<h3>Phase 3: Update Frontend to Use WebSocket (Priority: High)</h3>
<h4>3.1 Update WebSocket Provider</h4>
<p><strong>File</strong>: <code>frontend/src/providers/WebSocketProvider.tsx</code>
<strong>Estimated Time</strong>: 2 hours</p>
<p><strong>Implementation</strong>: Add portfolio events to existing provider</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Add to existing WebSocketProvider:</span>
<span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">portfolioData</span><span class="p">,</span><span class="w"> </span><span class="nx">setPortfolioData</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="o">&lt;</span><span class="nb">Map</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">any</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nb">Map</span><span class="p">());</span>

<span class="c1">// Add portfolio event handler</span>
<span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;portfolio_update&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">message</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">userId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">setPortfolioData</span><span class="p">(</span><span class="nx">prev</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">newData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Map</span><span class="p">(</span><span class="nx">prev</span><span class="p">);</span>
<span class="w">      </span><span class="nx">newData</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">userId</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">newData</span><span class="p">;</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">});</span>

<span class="c1">// Add portfolio subscription method</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">subscribeToPortfolio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useCallback</span><span class="p">((</span><span class="nx">userId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">callback</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="kt">any</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">void</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">socket</span><span class="o">?</span><span class="p">.</span><span class="nx">connected</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;subscribe_portfolio&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;portfolio_update&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">callback</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">socket</span><span class="o">?</span><span class="p">.</span><span class="nx">off</span><span class="p">(</span><span class="s1">&#39;portfolio_update&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">callback</span><span class="p">);</span>
<span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="nx">socket</span><span class="p">]);</span>
</code></pre></div>

<h4>3.2 Update PortfolioDashboard Component</h4>
<p><strong>File</strong>: <code>frontend/src/components/PortfolioDashboard.tsx</code>
<strong>Estimated Time</strong>: 2 hours</p>
<p><strong>Implementation</strong>: Replace polling with WebSocket</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Replace existing useEffect polling with:</span>
<span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">subscribeToPortfolio</span><span class="p">,</span><span class="w"> </span><span class="nx">portfolioData</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useWebSocket</span><span class="p">();</span>

<span class="nx">useEffect</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">userId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">unsubscribe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">subscribeToPortfolio</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">setPortfolioSummary</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">summary</span><span class="p">);</span>
<span class="w">      </span><span class="nx">setRiskMetrics</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">riskMetrics</span><span class="p">);</span>
<span class="w">      </span><span class="nx">setPerformanceMetrics</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">performanceMetrics</span><span class="p">);</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">unsubscribe</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="nx">userId</span><span class="p">,</span><span class="w"> </span><span class="nx">subscribeToPortfolio</span><span class="p">]);</span>

<span class="c1">// Remove the existing polling interval</span>
</code></pre></div>

<h3>Phase 4: Add Smooth Animations (Priority: Medium)</h3>
<h4>4.1 Add React Spring Animations</h4>
<p><strong>File</strong>: <code>frontend/src/components/PortfolioDashboard.tsx</code>
<strong>Estimated Time</strong>: 2 hours</p>
<p><strong>Dependencies</strong>: Add <code>react-spring</code> to package.json</p>
<p><strong>Implementation</strong>: Add animations to existing component</p>
<div class="codehilite"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useSpring</span><span class="p">,</span><span class="w"> </span><span class="nx">animated</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react-spring&#39;</span>

<span class="c1">// Animate portfolio value changes:</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">portfolioValueSpring</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useSpring</span><span class="p">({</span>
<span class="w">  </span><span class="kt">number</span><span class="o">:</span><span class="w"> </span><span class="nx">portfolioSummary</span><span class="o">?</span><span class="p">.</span><span class="nx">totalEquity</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">  </span><span class="kr">from</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kt">number</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="p">},</span>
<span class="w">  </span><span class="nx">config</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">tension</span><span class="o">:</span><span class="w"> </span><span class="kt">120</span><span class="p">,</span><span class="w"> </span><span class="nx">friction</span><span class="o">:</span><span class="w"> </span><span class="kt">14</span><span class="w"> </span><span class="p">}</span>
<span class="p">})</span>

<span class="c1">// Use in existing JSX:</span>
<span class="o">&lt;</span><span class="nx">animated</span><span class="p">.</span><span class="nx">div</span><span class="w"> </span><span class="nx">className</span><span class="o">=</span><span class="s2">&quot;text-2xl font-bold text-white&quot;</span><span class="o">&gt;</span>
<span class="w">  </span><span class="p">{</span><span class="nx">portfolioValueSpring</span><span class="p">.</span><span class="kt">number</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="nx">n</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">formatCurrency</span><span class="p">(</span><span class="nx">n</span><span class="p">))}</span>
<span class="o">&lt;</span><span class="err">/animated.div&gt;</span>
</code></pre></div>

<h3>Phase 5: Testing &amp; Validation (Priority: High)</h3>
<h4>5.1 Test Transaction Status Fixes</h4>
<p><strong>File</strong>: <code>frontend/tests/services/smartContractService.test.ts</code>
<strong>Estimated Time</strong>: 2 hours</p>
<p><strong>Test Coverage</strong>:
- Transaction success detection
- Error message accuracy
- User rejection handling</p>
<h4>5.2 Test Balance Calculations</h4>
<p><strong>File</strong>: <code>frontend/tests/services/balanceService.test.ts</code>
<strong>Estimated Time</strong>: 2 hours</p>
<p><strong>Test Coverage</strong>:
- Real SOL price integration
- Collateral balance accuracy
- USD value calculations</p>
<h4>5.3 Test WebSocket Integration</h4>
<p><strong>File</strong>: <code>frontend/tests/components/PortfolioDashboard.test.tsx</code>
<strong>Estimated Time</strong>: 2 hours</p>
<p><strong>Test Coverage</strong>:
- WebSocket connection handling
- Real-time updates
- Component state management</p>
<h2>Implementation Timeline (REVISED)</h2>
<h3>Week 1: Fix Critical Issues</h3>
<ul>
<li><strong>Day 1</strong>: Fix transaction status display and error handling</li>
<li><strong>Day 2</strong>: Fix balance calculation issues</li>
<li><strong>Day 3</strong>: Extend existing WebSocket service for portfolio updates</li>
<li><strong>Day 4</strong>: Update frontend WebSocket provider</li>
<li><strong>Day 5</strong>: Update PortfolioDashboard component</li>
</ul>
<h3>Week 2: Integration &amp; Polish</h3>
<ul>
<li><strong>Day 1</strong>: Update PositionsTable component</li>
<li><strong>Day 2</strong>: Add smooth animations</li>
<li><strong>Day 3</strong>: Test transaction fixes</li>
<li><strong>Day 4</strong>: Test balance calculations</li>
<li><strong>Day 5</strong>: Test WebSocket integration</li>
</ul>
<p><strong>Total Estimated Time</strong>: 20 hours (vs. original 32 hours)</p>
<h2>Risk Mitigation (REVISED)</h2>
<h3>Technical Risks</h3>
<ol>
<li><strong>Transaction Status Confusion</strong></li>
<li><strong>Mitigation</strong>: Better error classification and transaction confirmation checking</li>
<li>
<p><strong>Fallback</strong>: Clear user messaging about transaction states</p>
</li>
<li>
<p><strong>Balance Calculation Accuracy</strong></p>
</li>
<li><strong>Mitigation</strong>: Use real oracle prices and smart contract collateral balances</li>
<li>
<p><strong>Validation</strong>: Cross-reference with multiple data sources</p>
</li>
<li>
<p><strong>WebSocket Integration Issues</strong></p>
</li>
<li><strong>Mitigation</strong>: Extend existing proven WebSocket infrastructure</li>
<li><strong>Fallback</strong>: Graceful degradation to polling if WebSocket fails</li>
</ol>
<h3>Integration Risks</h3>
<ol>
<li><strong>Existing Component Conflicts</strong></li>
<li><strong>Mitigation</strong>: Minimal changes to existing working components</li>
<li>
<p><strong>Testing</strong>: Comprehensive testing of modified components</p>
</li>
<li>
<p><strong>Smart Contract Data Mismatch</strong></p>
</li>
<li><strong>Mitigation</strong>: Use existing smart contract service methods</li>
<li><strong>Validation</strong>: Verify data consistency between frontend and blockchain</li>
</ol>
<h2>Success Criteria (REVISED)</h2>
<h3>Functional Requirements</h3>
<ul>
<li>[ ] <strong>Transaction Status Accuracy</strong>: Frontend correctly shows transaction success/failure</li>
<li>[ ] <strong>Balance Accuracy</strong>: Portfolio shows actual deposited amounts and real USD values</li>
<li>[ ] <strong>Real-time Updates</strong>: Portfolio updates every 5 seconds via WebSocket (not polling)</li>
<li>[ ] <strong>Smooth Animations</strong>: Value changes animate smoothly without flickering</li>
<li>[ ] <strong>Error Handling</strong>: Clear, accurate error messages for users</li>
</ul>
<h3>Performance Requirements</h3>
<ul>
<li>[ ] <strong>WebSocket Performance</strong>: Messages delivered within 100ms</li>
<li>[ ] <strong>Balance Calculation</strong>: Real-time price integration with &lt;1s latency</li>
<li>[ ] <strong>Transaction Confirmation</strong>: Accurate status within 2 seconds</li>
</ul>
<h3>Quality Requirements</h3>
<ul>
<li>[ ] <strong>Existing Functionality</strong>: No regression in current features</li>
<li>[ ] <strong>Smart Contract Integration</strong>: Accurate data from blockchain</li>
<li>[ ] <strong>User Experience</strong>: Clear feedback for all user actions</li>
</ul>
<h2>Dependencies (REVISED)</h2>
<h3>External Dependencies</h3>
<ul>
<li><strong>React Spring</strong>: For smooth animations (new dependency)</li>
<li><strong>Socket.IO</strong>: Already implemented and working</li>
<li><strong>Pyth Oracle</strong>: Already implemented and working</li>
<li><strong>Anchor Program</strong>: Already implemented with all structs</li>
</ul>
<h3>Internal Dependencies</h3>
<ul>
<li><strong>WebSocketService</strong>: Extend existing implementation (no new service needed)</li>
<li><strong>SmartContractService</strong>: Use existing methods (fix error handling)</li>
<li><strong>BalanceService</strong>: Use existing methods (fix calculations)</li>
<li><strong>PortfolioAnalyticsService</strong>: Use existing calculations</li>
</ul>
<h2>Next Steps (REVISED)</h2>
<ol>
<li><strong>Start with Critical Fixes</strong>: Begin with transaction status and balance calculation fixes</li>
<li><strong>Extend Existing Services</strong>: Add portfolio events to existing WebSocket service</li>
<li><strong>Update Frontend Components</strong>: Replace polling with WebSocket in existing components</li>
<li><strong>Add Polish</strong>: Implement animations and improve user experience</li>
<li><strong>Test &amp; Validate</strong>: Ensure all fixes work correctly</li>
</ol>
<hr />
<p><strong>Document Created</strong>: 2025-10-18
<strong>Last Updated</strong>: 2025-10-18 (REVISED)
<strong>Status</strong>: Approved
<strong>Estimated Total Time</strong>: 20 hours (reduced from 32 hours)
<strong>Complexity</strong>: Medium (Fixing existing components vs. building new ones)</p>
    </div>
</body>
</html>