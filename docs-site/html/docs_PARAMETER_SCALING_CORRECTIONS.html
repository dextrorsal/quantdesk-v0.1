<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parameter Scaling Corrections - QuantDesk Documentation</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <style>
        body {
            font-family: 'JetBrains Mono', 'Monaco', 'Consolas', monospace;
            line-height: 1.6;
            color: #ffffff;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #000000;
            font-size: 14px;
        }
        .container {
            background: #000000;
            padding: 30px;
            border-radius: 8px;
            border: 1px solid #333333;
        }
        .back-link {
            margin-bottom: 20px;
        }
        .back-link a {
            color: #3b82f6;
            text-decoration: none;
            font-weight: bold;
            transition: color 0.3s ease;
        }
        .back-link a:hover {
            color: #60a5fa;
            text-decoration: underline;
        }
        h1, h2, h3, h4, h5, h6 {
            color: #ffffff;
            margin-top: 30px;
            margin-bottom: 15px;
            font-weight: 600;
        }
        h1 {
            border-bottom: 2px solid #333333;
            padding-bottom: 10px;
        }
        h2 {
            border-bottom: 1px solid #333333;
            padding-bottom: 8px;
        }
        code {
            background: #1a1a1a;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'JetBrains Mono', 'Monaco', 'Consolas', monospace;
            color: #ffffff;
            border: 1px solid #333333;
        }
        pre {
            background: #0a0a0a;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            border: 1px solid #333333;
            margin: 20px 0;
        }
        pre code {
            background: none;
            padding: 0;
            color: #ffffff;
            border: none;
        }
        blockquote {
            border-left: 4px solid #3b82f6;
            margin: 0;
            padding-left: 20px;
            color: #d9d9d9;
            background: #1a1a1a;
            padding: 15px 20px;
            border-radius: 0 8px 8px 0;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
            border: 1px solid #333333;
        }
        th, td {
            border: 1px solid #333333;
            padding: 12px;
            text-align: left;
        }
        th {
            background: #1a1a1a;
            font-weight: bold;
            color: #ffffff;
        }
        td {
            color: #d9d9d9;
        }
        ul, ol {
            color: #d9d9d9;
        }
        li {
            margin-bottom: 8px;
        }
        a {
            color: #3b82f6;
            text-decoration: none;
        }
        a:hover {
            color: #60a5fa;
            text-decoration: underline;
        }
        /* Syntax Highlighting Overrides */
        pre[class*="language-"] {
            background: #0a0a0a !important;
            border: 1px solid #333333 !important;
            border-radius: 8px !important;
            padding: 20px !important;
            margin: 20px 0 !important;
            font-family: 'JetBrains Mono', 'Monaco', 'Consolas', monospace !important;
            font-size: 13px !important;
            line-height: 1.5 !important;
        }
        .token.comment { color: #6a9955 !important; }
        .token.keyword { color: #569cd6 !important; }
        .token.string { color: #ce9178 !important; }
        .token.number { color: #b5cea8 !important; }
        .token.function { color: #dcdcaa !important; }
        .token.class-name { color: #4ec9b0 !important; }
        .token.operator { color: #d4d4d4 !important; }
        .token.punctuation { color: #d4d4d4 !important; }
        .token.variable { color: #9cdcfe !important; }
        .token.constant { color: #4fc1ff !important; }
    </style>
</head>
<body>
    <div class="container">
        <div class="back-link">
            <a href="/">&larr; Back to Documentation</a>
        </div>
        <h1>🎯 Parameter Scaling Corrections: PineScript → PyTorch</h1>
<p><em>Critical corrections needed to match TradingView exactly</em></p>
<h2>🚨 <strong>Immediate Corrections Required</strong></h2>
<h3><strong>1. Chandelier Exit - MAJOR MISMATCH</strong></h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># CURRENT (WRONG):</span>
<span class="n">atr_period</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">atr_multiplier</span> <span class="o">=</span> <span class="mf">2.0</span>

<span class="c1"># CORRECT (from TradingView):</span>
<span class="n">atr_period</span> <span class="o">=</span> <span class="mi">22</span>
<span class="n">atr_multiplier</span> <span class="o">=</span> <span class="mf">3.0</span>
<span class="n">use_close_for_extremums</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Important: use close price for highs/lows</span>
</code></pre></div>

<h3><strong>2. Lorentzian Classifier - Parameter Alignment</strong></h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># CORRECT (from TradingView):</span>
<span class="n">LORENTZIAN_CONFIG</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;neighbors_count&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
    <span class="s1">&#39;max_bars_back&#39;</span><span class="p">:</span> <span class="mi">2000</span><span class="p">,</span>
    <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;close&#39;</span><span class="p">,</span>

    <span class="c1"># Feature Engineering (5 features):</span>
    <span class="s1">&#39;features&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;rsi_14_1&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;RSI&#39;</span><span class="p">,</span> <span class="s1">&#39;period&#39;</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span> <span class="s1">&#39;smooth&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
        <span class="s1">&#39;wt_10_11&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;WT&#39;</span><span class="p">,</span> <span class="s1">&#39;channel&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;average&#39;</span><span class="p">:</span> <span class="mi">11</span><span class="p">},</span>
        <span class="s1">&#39;cci_20_1&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;CCI&#39;</span><span class="p">,</span> <span class="s1">&#39;period&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s1">&#39;smooth&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
        <span class="s1">&#39;adx_20_2&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;ADX&#39;</span><span class="p">,</span> <span class="s1">&#39;period&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s1">&#39;smooth&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
        <span class="s1">&#39;rsi_9_1&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;RSI&#39;</span><span class="p">,</span> <span class="s1">&#39;period&#39;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span> <span class="s1">&#39;smooth&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
    <span class="p">},</span>

    <span class="c1"># Filters:</span>
    <span class="s1">&#39;use_volatility_filter&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s1">&#39;use_regime_filter&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s1">&#39;regime_threshold&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">,</span>
    <span class="s1">&#39;use_adx_filter&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s1">&#39;adx_threshold&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>

    <span class="c1"># Kernel Settings:</span>
    <span class="s1">&#39;trade_with_kernel&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s1">&#39;lookback_window&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
    <span class="s1">&#39;relative_weighting&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
    <span class="s1">&#39;regression_level&#39;</span><span class="p">:</span> <span class="mi">25</span>
<span class="p">}</span>
</code></pre></div>

<h3><strong>3. Logistic Regression - Learning Rate Scaling</strong></h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># CRITICAL: PineScript learning rates don&#39;t directly translate</span>
<span class="c1"># TradingView: 0.0009 over 1000 iterations</span>
<span class="c1"># PyTorch equivalent analysis needed:</span>

<span class="n">LOGISTIC_CONFIG</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;lookback_window&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>  <span class="c1"># Matches TradingView</span>
    <span class="s1">&#39;normalization_lookback&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>  <span class="c1"># Matches TradingView</span>
    <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.001</span><span class="p">,</span>  <span class="c1"># May need adjustment (was 0.0009 in TV)</span>
    <span class="s1">&#39;training_iterations&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>  <span class="c1"># Matches TradingView</span>
    <span class="s1">&#39;holding_period&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>  <span class="c1"># Matches TradingView</span>

    <span class="c1"># PyTorch-specific (not in TradingView):</span>
    <span class="s1">&#39;optimizer&#39;</span><span class="p">:</span> <span class="s1">&#39;adam&#39;</span><span class="p">,</span>  <span class="c1"># vs SGD in TradingView?</span>
    <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span>
    <span class="s1">&#39;regularization&#39;</span><span class="p">:</span> <span class="mf">0.01</span>
<span class="p">}</span>
</code></pre></div>

<h2>🔍 <strong>Scaling Differences Analysis</strong></h2>
<h3><strong>A. Numerical Precision</strong></h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># PineScript: </span>
<span class="c1"># - Single precision floats</span>
<span class="c1"># - Built-in function implementations</span>

<span class="c1"># PyTorch:</span>
<span class="c1"># - Double precision available</span>
<span class="c1"># - Manual implementations</span>
<span class="c1"># - Different rounding behavior</span>
</code></pre></div>

<h3><strong>B. Normalization Methods</strong></h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># TradingView Logistic Regression:</span>
<span class="k">def</span> <span class="nf">tv_normalize</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">lookback</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;PineScript-style normalization&quot;&quot;&quot;</span>
    <span class="n">recent_min</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="n">lookback</span><span class="p">:])</span>
    <span class="n">recent_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="n">lookback</span><span class="p">:])</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">current_value</span> <span class="o">-</span> <span class="n">recent_min</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">recent_max</span> <span class="o">-</span> <span class="n">recent_min</span><span class="p">)</span>

<span class="c1"># PyTorch Standard:</span>
<span class="k">def</span> <span class="nf">pytorch_normalize</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;StandardScaler equivalent&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">values</span> <span class="o">-</span> <span class="n">values</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">values</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

<span class="c1"># These produce DIFFERENT results!</span>
</code></pre></div>

<h3><strong>C. ATR Calculation Differences</strong></h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># TradingView Chandelier (PineScript):</span>
<span class="c1"># - Uses built-in ta.atr() function</span>
<span class="c1"># - Automatically handles close price for extremums</span>
<span class="c1"># - Period 22, multiplier 3.0</span>

<span class="c1"># Your PyTorch:</span>
<span class="c1"># - Custom ATR implementation</span>
<span class="c1"># - Period 3 (7x shorter window!)</span>
<span class="c1"># - Multiplier 2.0 (25% smaller stops)</span>
<span class="c1"># - Result: Completely different stop levels</span>
</code></pre></div>

<h2>🎯 <strong>Action Plan</strong></h2>
<h3><strong>Phase 1: Fix Critical Mismatches (Do This First)</strong></h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># 1. Update Chandelier Exit parameters immediately:</span>
<span class="n">chandelier_config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;atr_period&#39;</span><span class="p">:</span> <span class="mi">22</span><span class="p">,</span>        <span class="c1"># was 3</span>
    <span class="s1">&#39;atr_multiplier&#39;</span><span class="p">:</span> <span class="mf">3.0</span><span class="p">,</span>   <span class="c1"># was 2.0</span>
    <span class="s1">&#39;use_close_extremums&#39;</span><span class="p">:</span> <span class="kc">True</span>
<span class="p">}</span>

<span class="c1"># 2. Verify ATR calculation method matches TradingView</span>
<span class="c1"># 3. Test signals on recent data</span>
</code></pre></div>

<h3><strong>Phase 2: Normalization Alignment</strong></h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Implement TradingView-style normalization for Logistic Regression:</span>
<span class="k">class</span> <span class="nc">TVStyleNormalization</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookback</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lookback</span> <span class="o">=</span> <span class="n">lookback</span>

    <span class="k">def</span> <span class="nf">normalize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="n">normalized</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookback</span><span class="p">:</span>
                <span class="n">normalized</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># or handle edge case</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">window</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">lookback</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">min_val</span><span class="p">,</span> <span class="n">max_val</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">window</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">window</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">max_val</span> <span class="o">==</span> <span class="n">min_val</span><span class="p">:</span>
                    <span class="n">normalized</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">norm_val</span> <span class="o">=</span> <span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">min_val</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">max_val</span> <span class="o">-</span> <span class="n">min_val</span><span class="p">)</span>
                    <span class="n">normalized</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm_val</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">normalized</span>
</code></pre></div>

<h3><strong>Phase 3: Learning Rate Calibration</strong></h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Test different learning rates to match TradingView behavior:</span>
<span class="n">learning_rates_to_test</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0009</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.0015</span><span class="p">,</span> <span class="mf">0.002</span><span class="p">]</span>

<span class="c1"># Compare convergence patterns and final model outputs</span>
</code></pre></div>

<h2>⚠️ <strong>Why This Matters</strong></h2>
<h3><strong>Impact of Current Mismatches:</strong></h3>
<div class="codehilite"><pre><span></span><code><span class="n">Chandelier</span><span class="w"> </span><span class="n">Exit</span><span class="w"> </span><span class="p">(</span><span class="n">Period</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">vs</span><span class="w"> </span><span class="mi">22</span><span class="p">):</span>
<span class="o">-</span><span class="w"> </span><span class="n">Your</span><span class="w"> </span><span class="n">stops</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="mi">7</span><span class="n">x</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">sensitive</span>
<span class="o">-</span><span class="w"> </span><span class="n">Completely</span><span class="w"> </span><span class="n">different</span><span class="w"> </span><span class="n">risk</span><span class="w"> </span><span class="n">management</span>
<span class="o">-</span><span class="w"> </span><span class="n">May</span><span class="w"> </span><span class="n">explain</span><span class="w"> </span><span class="n">poor</span><span class="w"> </span><span class="n">performance</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">shorter</span><span class="w"> </span><span class="n">timeframes</span>

<span class="n">Logistic</span><span class="w"> </span><span class="n">Regression</span><span class="w"> </span><span class="n">Normalization</span><span class="p">:</span>
<span class="o">-</span><span class="w"> </span><span class="n">Different</span><span class="w"> </span><span class="n">feature</span><span class="w"> </span><span class="n">scaling</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">different</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="n">behavior</span>
<span class="o">-</span><span class="w"> </span><span class="n">Learning</span><span class="w"> </span><span class="n">rate</span><span class="w"> </span><span class="n">mismatch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">different</span><span class="w"> </span><span class="n">convergence</span>

<span class="n">Result</span><span class="p">:</span><span class="w"> </span><span class="n">Your</span><span class="w"> </span><span class="n">indicators</span><span class="w"> </span><span class="n">produce</span><span class="w"> </span><span class="n">different</span><span class="w"> </span><span class="n">signals</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">TradingView</span>
</code></pre></div>

<h2>🧪 <strong>Testing Strategy</strong></h2>
<h3><strong>1. Parameter-by-Parameter Testing</strong></h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Test each correction individually:</span>
<span class="n">test_chandelier_22_vs_3</span><span class="p">()</span>    <span class="c1"># Compare ATR periods</span>
<span class="n">test_logistic_norm_methods</span><span class="p">()</span> <span class="c1"># Compare normalization</span>
<span class="n">test_lorentzian_features</span><span class="p">()</span>   <span class="c1"># Verify feature calculations</span>
</code></pre></div>

<h3><strong>2. Signal Comparison</strong></h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Compare signals before/after corrections:</span>
<span class="n">old_signals</span> <span class="o">=</span> <span class="n">generate_signals_old_params</span><span class="p">()</span>
<span class="n">new_signals</span> <span class="o">=</span> <span class="n">generate_signals_tv_params</span><span class="p">()</span>
<span class="n">signal_diff_analysis</span><span class="p">(</span><span class="n">old_signals</span><span class="p">,</span> <span class="n">new_signals</span><span class="p">)</span>
</code></pre></div>

<h3><strong>3. TradingView Verification</strong></h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Key timestamps to check after corrections:</span>
<span class="n">verification_dates</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;2025-07-15 14:00:00&#39;</span><span class="p">,</span>
    <span class="s1">&#39;2025-07-16 09:00:00&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;2025-07-16 15:00:00&#39;</span>
<span class="p">]</span>
</code></pre></div>

<h2>🎯 <strong>Expected Results After Corrections</strong></h2>
<ol>
<li><strong>Chandelier Exit</strong>: Much smoother, less frequent signals</li>
<li><strong>Logistic Regression</strong>: More stable predictions </li>
<li><strong>Lorentzian</strong>: Better feature alignment</li>
<li><strong>Overall</strong>: Signals should closely match TradingView</li>
</ol>
<hr />
<p><em>Priority: Fix Chandelier Exit first (biggest mismatch), then test signal alignment</em></p>
    </div>
</body>
</html>