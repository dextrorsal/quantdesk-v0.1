<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brownfield-Architecture - QuantDesk Documentation</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <style>
        body {
            font-family: 'JetBrains Mono', 'Monaco', 'Consolas', monospace;
            line-height: 1.6;
            color: #ffffff;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #000000;
            font-size: 14px;
        }
        .container {
            background: #000000;
            padding: 30px;
            border-radius: 8px;
            border: 1px solid #333333;
        }
        .back-link {
            margin-bottom: 20px;
        }
        .back-link a {
            color: #3b82f6;
            text-decoration: none;
            font-weight: bold;
            transition: color 0.3s ease;
        }
        .back-link a:hover {
            color: #60a5fa;
            text-decoration: underline;
        }
        h1, h2, h3, h4, h5, h6 {
            color: #ffffff;
            margin-top: 30px;
            margin-bottom: 15px;
            font-weight: 600;
        }
        h1 {
            border-bottom: 2px solid #333333;
            padding-bottom: 10px;
        }
        h2 {
            border-bottom: 1px solid #333333;
            padding-bottom: 8px;
        }
        code {
            background: #1a1a1a;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'JetBrains Mono', 'Monaco', 'Consolas', monospace;
            color: #ffffff;
            border: 1px solid #333333;
        }
        pre {
            background: #0a0a0a;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            border: 1px solid #333333;
            margin: 20px 0;
        }
        pre code {
            background: none;
            padding: 0;
            color: #ffffff;
            border: none;
        }
        blockquote {
            border-left: 4px solid #3b82f6;
            margin: 0;
            padding-left: 20px;
            color: #d9d9d9;
            background: #1a1a1a;
            padding: 15px 20px;
            border-radius: 0 8px 8px 0;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
            border: 1px solid #333333;
        }
        th, td {
            border: 1px solid #333333;
            padding: 12px;
            text-align: left;
        }
        th {
            background: #1a1a1a;
            font-weight: bold;
            color: #ffffff;
        }
        td {
            color: #d9d9d9;
        }
        ul, ol {
            color: #d9d9d9;
        }
        li {
            margin-bottom: 8px;
        }
        a {
            color: #3b82f6;
            text-decoration: none;
        }
        a:hover {
            color: #60a5fa;
            text-decoration: underline;
        }
        /* Syntax Highlighting Overrides */
        pre[class*="language-"] {
            background: #0a0a0a !important;
            border: 1px solid #333333 !important;
            border-radius: 8px !important;
            padding: 20px !important;
            margin: 20px 0 !important;
            font-family: 'JetBrains Mono', 'Monaco', 'Consolas', monospace !important;
            font-size: 13px !important;
            line-height: 1.5 !important;
        }
        .token.comment { color: #6a9955 !important; }
        .token.keyword { color: #569cd6 !important; }
        .token.string { color: #ce9178 !important; }
        .token.number { color: #b5cea8 !important; }
        .token.function { color: #dcdcaa !important; }
        .token.class-name { color: #4ec9b0 !important; }
        .token.operator { color: #d4d4d4 !important; }
        .token.punctuation { color: #d4d4d4 !important; }
        .token.variable { color: #9cdcfe !important; }
        .token.constant { color: #4fc1ff !important; }
    </style>
</head>
<body>
    <div class="container">
        <div class="back-link">
            <a href="/">&larr; Back to Documentation</a>
        </div>
        <h1>QuantDesk Brownfield Architecture Document</h1>
<h2>Introduction</h2>
<p>This document captures the CURRENT STATE of the QuantDesk codebase, including technical debt, workarounds, and real-world patterns. It serves as a reference for AI agents working on the AI Portfolio Rebalancing enhancement.</p>
<h3>Document Scope</h3>
<p><strong>Focused on areas relevant to: AI Portfolio Rebalancing Enhancement</strong></p>
<p>The planned enhancement will require coordination between:
- <strong>Backend</strong>: Portfolio analytics API, AI integration endpoints
- <strong>Frontend</strong>: AI recommendation dashboard, real-time portfolio updates<br />
- <strong>MIKEY-AI</strong>: Portfolio analysis engine, rebalancing recommendations
- <strong>Smart Contracts</strong>: Automated execution engine, batch order processing
- <strong>Database</strong>: Portfolio data storage, analytics tracking
- <strong>Oracle</strong>: Real-time price feeds for rebalancing decisions</p>
<h3>Change Log</h3>
<table>
<thead>
<tr>
<th>Date</th>
<th>Version</th>
<th>Description</th>
<th>Author</th>
</tr>
</thead>
<tbody>
<tr>
<td>2025-10-18</td>
<td>1.0</td>
<td>Initial brownfield analysis</td>
<td>Winston (Architect)</td>
</tr>
</tbody>
</table>
<h2>Quick Reference - Key Files and Entry Points</h2>
<h3>Critical Files for Understanding the System</h3>
<ul>
<li><strong>Main Entry</strong>: <code>backend/src/server.ts</code> - Express API server with 34+ route handlers</li>
<li><strong>Configuration</strong>: <code>backend/src/config/environment.ts</code>, <code>.env</code> files</li>
<li><strong>Core Business Logic</strong>: <code>backend/src/services/supabaseDatabase.ts</code> - Consolidated database service</li>
<li><strong>API Definitions</strong>: <code>backend/src/routes/</code> - 34+ specialized route files</li>
<li><strong>Database Models</strong>: <code>backend/src/services/supabaseDatabase.ts</code> - TypeScript interfaces</li>
<li><strong>Key Algorithms</strong>: <code>backend/src/services/pythOracleService.ts</code> - Oracle price integration</li>
</ul>
<h3>Enhancement Impact Areas</h3>
<p><strong>Files that will be affected by AI Portfolio Rebalancing:</strong></p>
<ul>
<li><code>backend/src/routes/portfolioAnalytics.ts</code> - Portfolio analytics API (EXISTS)</li>
<li><code>backend/src/routes/ai.ts</code> - AI service endpoints (EXISTS) </li>
<li><code>backend/src/services/portfolioAnalyticsService.ts</code> - Portfolio analytics service (EXISTS)</li>
<li><code>frontend/src/components/PortfolioDashboard.tsx</code> - Portfolio management UI (EXISTS)</li>
<li><code>MIKEY-AI/src/agents/TradingAgent.ts</code> - AI trading agent (EXISTS)</li>
<li><code>MIKEY-AI/src/services/QuantDeskTools.ts</code> - QuantDesk API integration (EXISTS)</li>
<li><code>contracts/programs/quantdesk-perp-dex/src/instructions/order_management.rs</code> - Order execution (EXISTS)</li>
</ul>
<h2>High Level Architecture</h2>
<h3>Technical Summary</h3>
<p>QuantDesk is a sophisticated multi-service Solana perpetual DEX platform with AI integration. The system uses a backend-centric architecture where the Express API server acts as the central hub, coordinating between frontend, AI services, smart contracts, and external data sources.</p>
<h3>Actual Tech Stack (from package.json analysis)</h3>
<table>
<thead>
<tr>
<th>Category</th>
<th>Technology</th>
<th>Version</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>Runtime</td>
<td>Node.js</td>
<td>20+</td>
<td>Backend services</td>
</tr>
<tr>
<td>Framework</td>
<td>Express</td>
<td>4.18.2</td>
<td>Backend API server</td>
</tr>
<tr>
<td>Frontend</td>
<td>React</td>
<td>18.2.0</td>
<td>Trading interface</td>
</tr>
<tr>
<td>Database</td>
<td>Supabase</td>
<td>2.58.0</td>
<td>PostgreSQL with abstraction layer</td>
</tr>
<tr>
<td>Blockchain</td>
<td>Solana</td>
<td>1.87.0</td>
<td>Smart contracts via Anchor</td>
</tr>
<tr>
<td>AI</td>
<td>LangChain</td>
<td>0.3.15</td>
<td>MIKEY-AI trading agent</td>
</tr>
<tr>
<td>Oracle</td>
<td>Pyth</td>
<td>2.0.0</td>
<td>Price feeds via Hermes</td>
</tr>
<tr>
<td>Caching</td>
<td>Redis</td>
<td>4.6.10</td>
<td>Session and data caching</td>
</tr>
<tr>
<td>Real-time</td>
<td>Socket.io</td>
<td>4.7.4</td>
<td>WebSocket communication</td>
</tr>
</tbody>
</table>
<h3>Repository Structure Reality Check</h3>
<ul>
<li><strong>Type</strong>: Monorepo with pnpm workspace</li>
<li><strong>Package Manager</strong>: pnpm (NOT npm - critical constraint)</li>
<li><strong>Notable</strong>: Multi-service architecture with shared dependencies</li>
</ul>
<h2>Source Tree and Module Organization</h2>
<h3>Project Structure (Actual)</h3>
<div class="codehilite"><pre><span></span><code>quantdesk-1.0.6/
├── backend/                    # Node.js/Express API server (Port 3002)
│   ├── src/
│   │   ├── routes/            # 34+ specialized route handlers
│   │   ├── services/          # 25+ specialized services
│   │   ├── middleware/         # Auth, rate limiting, error handling
│   │   └── server.ts          # Main entry point
├── frontend/                   # React trading interface (Port 3001)
│   ├── src/
│   │   ├── components/        # 45+ React components
│   │   ├── contexts/          # React context providers
│   │   └── stores/            # Zustand state management
├── MIKEY-AI/                   # LangChain AI agent (Port 3000)
│   ├── src/
│   │   ├── agents/            # AI agent implementations
│   │   ├── services/          # AI service layer
│   │   └── api/               # AI API server
├── contracts/                  # Solana smart contracts
│   ├── programs/
│   │   └── quantdesk-perp-dex/ # Anchor program
├── data-ingestion/             # Real-time data pipeline (Port 3003)
├── admin-dashboard/            # Admin management interface
└── database/                   # Database schemas and migrations
</code></pre></div>

<h3>Key Modules and Their Purpose</h3>
<ul>
<li><strong>Backend API Gateway</strong>: <code>backend/src/server.ts</code> - Central coordination hub</li>
<li><strong>Database Service</strong>: <code>backend/src/services/supabaseDatabase.ts</code> - CRITICAL: Single abstraction layer, prevents direct Supabase usage</li>
<li><strong>Oracle Integration</strong>: <code>backend/src/services/pythOracleService.ts</code> - Pyth Network price feeds</li>
<li><strong>AI Trading Agent</strong>: <code>MIKEY-AI/src/agents/TradingAgent.ts</code> - LangChain-based trading intelligence</li>
<li><strong>Trading Interface</strong>: <code>frontend/src/components/DexTradingInterface.tsx</code> - Main trading UI</li>
<li><strong>Smart Contracts</strong>: <code>contracts/programs/quantdesk-perp-dex/src/lib.rs</code> - Solana program with 50+ instructions</li>
</ul>
<h2>Data Models and APIs</h2>
<h3>Data Models</h3>
<p><strong>Critical</strong>: All database operations MUST use <code>databaseService</code> from <code>backend/src/services/supabaseDatabase.ts</code></p>
<ul>
<li><strong>User Model</strong>: See <code>backend/src/services/supabaseDatabase.ts</code> lines 28-46</li>
<li><strong>Position Model</strong>: See <code>backend/src/services/supabaseDatabase.ts</code> lines 72-92  </li>
<li><strong>Order Model</strong>: See <code>backend/src/services/supabaseDatabase.ts</code> lines 94-115</li>
<li><strong>Market Model</strong>: See <code>backend/src/services/supabaseDatabase.ts</code> lines 48-70</li>
</ul>
<h3>API Specifications</h3>
<ul>
<li><strong>OpenAPI Spec</strong>: Available via <code>/api/docs/swagger</code> endpoint</li>
<li><strong>AI Development Endpoints</strong>: <code>/api/dev/*</code> - Special endpoints for AI assistance</li>
<li><strong>Portfolio Analytics</strong>: <code>/api/portfolio/*</code> - Portfolio management endpoints (EXISTS)</li>
<li><strong>AI Integration</strong>: <code>/api/ai/*</code> - AI service endpoints (EXISTS)</li>
</ul>
<h2>Technical Debt and Known Issues</h2>
<h3>Critical Technical Debt</h3>
<ol>
<li><strong>Package Manager Constraint</strong>: MUST use pnpm, NEVER npm (enforced in package.json)</li>
<li><strong>Database Access Pattern</strong>: All database operations MUST go through <code>databaseService</code> abstraction layer</li>
<li><strong>Oracle Integration</strong>: Pyth prices fetched by backend, normalized and cached (backend-centric pattern)</li>
<li><strong>TypeScript Errors</strong>: Backend and admin dashboard have non-blocking TypeScript errors</li>
<li><strong>Missing Functions</strong>: <code>execute_sql</code> function missing in Supabase devnet (EXPECTED, non-critical)</li>
</ol>
<h3>Workarounds and Gotchas</h3>
<ul>
<li><strong>Environment Variables</strong>: Must set <code>NODE_ENV=production</code> even for staging (historical reason)</li>
<li><strong>Oracle Price Format</strong>: Prices are in scientific notation, already normalized by backend</li>
<li><strong>WebSocket Authentication</strong>: Uses JWT tokens from session cookies for WebSocket connections</li>
<li><strong>RPC Load Balancing</strong>: Backend handles RPC load balancing for Solana connections</li>
<li><strong>Rate Limiting</strong>: Tiered rate limits via <code>backend/src/middleware/rateLimiting.ts</code></li>
</ul>
<h2>Integration Points and External Dependencies</h2>
<h3>External Services</h3>
<table>
<thead>
<tr>
<th>Service</th>
<th>Purpose</th>
<th>Integration Type</th>
<th>Key Files</th>
</tr>
</thead>
<tbody>
<tr>
<td>Pyth Network</td>
<td>Price Feeds</td>
<td>WebSocket + REST</td>
<td><code>backend/src/services/pythOracleService.ts</code></td>
</tr>
<tr>
<td>Supabase</td>
<td>Database</td>
<td>REST API</td>
<td><code>backend/src/services/supabaseDatabase.ts</code></td>
</tr>
<tr>
<td>Solana</td>
<td>Blockchain</td>
<td>RPC + Anchor</td>
<td><code>contracts/programs/quantdesk-perp-dex/</code></td>
</tr>
<tr>
<td>OpenAI/Anthropic</td>
<td>AI Models</td>
<td>REST API</td>
<td><code>MIKEY-AI/src/services/OfficialLLMRouter.ts</code></td>
</tr>
</tbody>
</table>
<h3>Internal Integration Points</h3>
<ul>
<li><strong>Frontend ↔ Backend</strong>: REST API on port 3002, WebSocket for real-time updates</li>
<li><strong>MIKEY-AI ↔ Backend</strong>: REST API integration via <code>MIKEY-AI/src/services/QuantDeskTools.ts</code></li>
<li><strong>Backend ↔ Smart Contracts</strong>: Anchor integration for transaction execution</li>
<li><strong>All Services ↔ Database</strong>: Single <code>databaseService</code> abstraction layer</li>
</ul>
<h2>Development and Deployment</h2>
<h3>Local Development Setup</h3>
<ol>
<li><strong>Prerequisites</strong>: Node.js 20+, pnpm, Solana CLI tools</li>
<li><strong>Installation</strong>: <code>npm run install:all</code> (uses pnpm internally)</li>
<li><strong>Start Services</strong>: <code>npm run dev</code> (starts all services)</li>
<li><strong>Individual Services</strong>:</li>
<li>Backend: <code>cd backend &amp;&amp; pnpm run start:dev</code></li>
<li>Frontend: <code>cd frontend &amp;&amp; pnpm run dev</code></li>
<li>MIKEY-AI: <code>cd MIKEY-AI &amp;&amp; pnpm run dev</code></li>
</ol>
<h3>Build and Deployment Process</h3>
<ul>
<li><strong>Build Command</strong>: <code>npm run build</code> (builds all components)</li>
<li><strong>Backend Deployment</strong>: Railway (configured in <code>backend/railway.json</code>)</li>
<li><strong>Frontend Deployment</strong>: Vercel (configured in <code>frontend/vercel.json</code>)</li>
<li><strong>Smart Contracts</strong>: Solana devnet/mainnet deployment</li>
</ul>
<h2>Testing Reality</h2>
<h3>Current Test Coverage</h3>
<ul>
<li><strong>Backend Tests</strong>: Vitest configured, coverage reporting available</li>
<li><strong>Smart Contract Tests</strong>: Anchor test framework</li>
<li><strong>Frontend Tests</strong>: Playwright E2E tests configured</li>
<li><strong>Integration Tests</strong>: Available via <code>/api/dev/*</code> endpoints</li>
</ul>
<h3>Running Tests</h3>
<div class="codehilite"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span>test:backend<span class="w">      </span><span class="c1"># Backend unit tests</span>
npm<span class="w"> </span>run<span class="w"> </span>test:contracts<span class="w">    </span><span class="c1"># Smart contract tests  </span>
npm<span class="w"> </span>run<span class="w"> </span>test:frontend<span class="w">     </span><span class="c1"># Frontend E2E tests</span>
</code></pre></div>

<h2>Enhancement Impact Analysis - AI Portfolio Rebalancing</h2>
<h3>Files That Will Need Modification</h3>
<p>Based on the AI Portfolio Rebalancing PRD, these files will be affected:</p>
<p><strong>Backend Changes:</strong>
- <code>backend/src/routes/portfolioAnalytics.ts</code> - Add AI rebalancing endpoints
- <code>backend/src/services/portfolioAnalyticsService.ts</code> - Add AI analysis integration
- <code>backend/src/routes/ai.ts</code> - Extend AI service endpoints
- <code>backend/src/services/websocket.ts</code> - Real-time rebalancing notifications</p>
<p><strong>Frontend Changes:</strong>
- <code>frontend/src/components/PortfolioDashboard.tsx</code> - Add AI recommendation display
- <code>frontend/src/components/DexTradingInterface.tsx</code> - Add rebalancing controls
- <code>frontend/src/contexts/MarketContext.tsx</code> - Real-time portfolio updates</p>
<p><strong>MIKEY-AI Changes:</strong>
- <code>MIKEY-AI/src/agents/TradingAgent.ts</code> - Add portfolio analysis capabilities
- <code>MIKEY-AI/src/services/QuantDeskTools.ts</code> - Portfolio data integration
- <code>MIKEY-AI/src/services/PortfolioAnalysisService.ts</code> - NEW: Portfolio analysis service</p>
<p><strong>Smart Contract Changes:</strong>
- <code>contracts/programs/quantdesk-perp-dex/src/instructions/order_management.rs</code> - Batch order execution
- <code>contracts/programs/quantdesk-perp-dex/src/instructions/position_management.rs</code> - Cross-collateral rebalancing</p>
<h3>New Files/Modules Needed</h3>
<ul>
<li><code>backend/src/services/aiPortfolioService.ts</code> - AI portfolio analysis service</li>
<li><code>backend/src/routes/aiRebalancing.ts</code> - AI rebalancing endpoints</li>
<li><code>frontend/src/components/AIRebalancingDashboard.tsx</code> - AI recommendation UI</li>
<li><code>MIKEY-AI/src/services/PortfolioAnalysisService.ts</code> - Portfolio analysis engine</li>
<li><code>contracts/programs/quantdesk-perp-dex/src/instructions/batch_execution.rs</code> - Batch order execution</li>
</ul>
<h3>Integration Considerations</h3>
<ul>
<li><strong>AI ↔ Database</strong>: Portfolio data access via existing <code>databaseService</code></li>
<li><strong>Oracle ↔ Smart Contracts</strong>: Real-time price feeds for rebalancing execution</li>
<li><strong>Frontend ↔ Backend</strong>: WebSocket for real-time AI recommendation updates</li>
<li><strong>Smart Contracts ↔ Backend</strong>: Transaction monitoring and execution results</li>
<li><strong>All Departments</strong>: Database for audit trail and analytics tracking</li>
</ul>
<h2>Appendix - Useful Commands and Scripts</h2>
<h3>Frequently Used Commands</h3>
<div class="codehilite"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span>dev<span class="w">              </span><span class="c1"># Start all services in development</span>
npm<span class="w"> </span>run<span class="w"> </span>build<span class="w">            </span><span class="c1"># Build all components</span>
npm<span class="w"> </span>run<span class="w"> </span>test:all<span class="w">         </span><span class="c1"># Run all tests</span>
npm<span class="w"> </span>run<span class="w"> </span>lint<span class="w">             </span><span class="c1"># Lint all code</span>
pnpm<span class="w"> </span>--filter<span class="o">=</span>*<span class="w"> </span>dev<span class="w">     </span><span class="c1"># Start services via pnpm workspace</span>
</code></pre></div>

<h3>Debugging and Troubleshooting</h3>
<ul>
<li><strong>Backend Logs</strong>: Check <code>backend/logs/</code> for application logs</li>
<li><strong>AI Development</strong>: Use <code>/api/dev/codebase-structure</code> endpoint for system info</li>
<li><strong>Database Issues</strong>: Use <code>databaseService.healthCheck()</code> method</li>
<li><strong>Oracle Issues</strong>: Check <code>pythOracleService</code> connection status</li>
</ul>
<h3>AI Assistant Integration</h3>
<p>The system provides special endpoints for AI development assistance:</p>
<ul>
<li><strong>System Architecture</strong>: <code>GET /api/dev/codebase-structure</code></li>
<li><strong>Market Data</strong>: <code>GET /api/dev/market-summary</code>  </li>
<li><strong>User Portfolio</strong>: <code>GET /api/dev/user-portfolio/:wallet</code></li>
<li><strong>API Documentation</strong>: <code>GET /api/docs/swagger</code></li>
</ul>
<p>These endpoints return structured, machine-readable data about the system architecture, making it easier for AI assistants to understand the codebase and provide accurate suggestions for the AI Portfolio Rebalancing enhancement.</p>
    </div>
</body>
</html>