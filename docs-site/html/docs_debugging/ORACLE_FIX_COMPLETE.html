<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oracle Fix Complete - QuantDesk Documentation</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <style>
        body {
            font-family: 'JetBrains Mono', 'Monaco', 'Consolas', monospace;
            line-height: 1.6;
            color: #ffffff;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #000000;
            font-size: 14px;
        }
        .container {
            background: #000000;
            padding: 30px;
            border-radius: 8px;
            border: 1px solid #333333;
        }
        .back-link {
            margin-bottom: 20px;
        }
        .back-link a {
            color: #3b82f6;
            text-decoration: none;
            font-weight: bold;
            transition: color 0.3s ease;
        }
        .back-link a:hover {
            color: #60a5fa;
            text-decoration: underline;
        }
        h1, h2, h3, h4, h5, h6 {
            color: #ffffff;
            margin-top: 30px;
            margin-bottom: 15px;
            font-weight: 600;
        }
        h1 {
            border-bottom: 2px solid #333333;
            padding-bottom: 10px;
        }
        h2 {
            border-bottom: 1px solid #333333;
            padding-bottom: 8px;
        }
        code {
            background: #1a1a1a;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'JetBrains Mono', 'Monaco', 'Consolas', monospace;
            color: #ffffff;
            border: 1px solid #333333;
        }
        pre {
            background: #0a0a0a;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            border: 1px solid #333333;
            margin: 20px 0;
        }
        pre code {
            background: none;
            padding: 0;
            color: #ffffff;
            border: none;
        }
        blockquote {
            border-left: 4px solid #3b82f6;
            margin: 0;
            padding-left: 20px;
            color: #d9d9d9;
            background: #1a1a1a;
            padding: 15px 20px;
            border-radius: 0 8px 8px 0;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
            border: 1px solid #333333;
        }
        th, td {
            border: 1px solid #333333;
            padding: 12px;
            text-align: left;
        }
        th {
            background: #1a1a1a;
            font-weight: bold;
            color: #ffffff;
        }
        td {
            color: #d9d9d9;
        }
        ul, ol {
            color: #d9d9d9;
        }
        li {
            margin-bottom: 8px;
        }
        a {
            color: #3b82f6;
            text-decoration: none;
        }
        a:hover {
            color: #60a5fa;
            text-decoration: underline;
        }
        /* Syntax Highlighting Overrides */
        pre[class*="language-"] {
            background: #0a0a0a !important;
            border: 1px solid #333333 !important;
            border-radius: 8px !important;
            padding: 20px !important;
            margin: 20px 0 !important;
            font-family: 'JetBrains Mono', 'Monaco', 'Consolas', monospace !important;
            font-size: 13px !important;
            line-height: 1.5 !important;
        }
        .token.comment { color: #6a9955 !important; }
        .token.keyword { color: #569cd6 !important; }
        .token.string { color: #ce9178 !important; }
        .token.number { color: #b5cea8 !important; }
        .token.function { color: #dcdcaa !important; }
        .token.class-name { color: #4ec9b0 !important; }
        .token.operator { color: #d4d4d4 !important; }
        .token.punctuation { color: #d4d4d4 !important; }
        .token.variable { color: #9cdcfe !important; }
        .token.constant { color: #4fc1ff !important; }
    </style>
</head>
<body>
    <div class="container">
        <div class="back-link">
            <a href="/">&larr; Back to Documentation</a>
        </div>
        <h1>üéâ Oracle Price Calculation Fix - COMPLETE!</h1>
<h2>‚úÖ Issue Resolved</h2>
<p><strong>Problem:</strong> Smart contract was storing lamports as USD directly (0.2 SOL = $200 instead of $41.60)<br />
<strong>Root Cause:</strong> Wrong deployment method (<code>solana program deploy</code> instead of <code>anchor upgrade</code>)<br />
<strong>Solution:</strong> Used proper upgrade process with buffer</p>
<hr />
<h2>üìä Deployment History</h2>
<table>
<thead>
<tr>
<th>Deployment</th>
<th>Slot</th>
<th>Method</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr>
<td>Initial (buggy)</td>
<td>414430670</td>
<td><code>solana program deploy</code></td>
<td>‚ùå Created new program instead of upgrading</td>
</tr>
<tr>
<td>Fixed (correct!)</td>
<td><strong>414433599</strong></td>
<td><code>solana program write-buffer</code> + <code>solana program upgrade</code></td>
<td>‚úÖ <strong>Properly upgraded existing program</strong></td>
</tr>
</tbody>
</table>
<hr />
<h2>üîß What Was Fixed</h2>
<h3><strong>Before Fix (Buggy Code):</strong></h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// Incorrectly stored lamports as USD directly</span>
<span class="kd">let</span><span class="w"> </span><span class="n">usd_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">amount</span><span class="p">;</span><span class="w"> </span><span class="c1">// 200,000,000 lamports ‚Üí $200 USD ‚ùå</span>
</code></pre></div>

<h3><strong>After Fix (Correct Code in <code>oracle.rs</code>):</strong></h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// Correctly converts lamports ‚Üí SOL ‚Üí USD</span>
<span class="kd">let</span><span class="w"> </span><span class="n">sol_amount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">sol_lamports</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">f64</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1_000_000_000.0</span><span class="p">;</span><span class="w">  </span><span class="c1">// 200,000,000 / 1e9 = 0.2 SOL</span>
<span class="kd">let</span><span class="w"> </span><span class="n">usd_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sol_amount</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">price_scaled</span><span class="p">;</span><span class="w">                 </span><span class="c1">// 0.2 √ó $208 = $41.60</span>
<span class="kd">let</span><span class="w"> </span><span class="n">usd_value_6_decimals</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">usd_value</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1_000_000.0</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u64</span><span class="p">;</span><span class="w"> </span><span class="c1">// Store as 41,600,000</span>
</code></pre></div>

<hr />
<h2>üéØ Expected Results After Re-Deposit</h2>
<h3><strong>Test Case: Deposit 0.2 SOL</strong></h3>
<p><strong>OLD (Buggy):</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">Deposited</span><span class="o">:</span><span class="w"> </span><span class="mf">0.2</span><span class="w"> </span><span class="n">SOL</span>
<span class="n">Stored</span><span class="o">:</span><span class="w"> </span><span class="mi">200</span><span class="o">,</span><span class="mi">000</span><span class="o">,</span><span class="mi">000</span><span class="w"> </span><span class="n">lamports</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">USD</span>
<span class="n">Displayed</span><span class="o">:</span><span class="w"> </span><span class="n">$200</span><span class="o">.</span><span class="mi">00</span><span class="w"> </span><span class="n">USD</span><span class="w">  </span><span class="err">‚ùå</span><span class="w"> </span><span class="o">(</span><span class="mf">4.8</span><span class="n">x</span><span class="w"> </span><span class="n">overvalued</span><span class="o">!)</span>
</code></pre></div>

<p><strong>NEW (Fixed):</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">Deposited</span><span class="o">:</span><span class="w"> </span><span class="mf">0.2</span><span class="w"> </span><span class="n">SOL</span>
<span class="n">Calculated</span><span class="o">:</span><span class="w"> </span><span class="mf">0.2</span><span class="w"> </span><span class="err">√ó</span><span class="w"> </span><span class="n">$208</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">$41</span><span class="o">.</span><span class="mi">60</span><span class="w"> </span><span class="n">USD</span>
<span class="n">Stored</span><span class="o">:</span><span class="w"> </span><span class="mi">41</span><span class="o">,</span><span class="mi">600</span><span class="o">,</span><span class="mi">000</span><span class="w"> </span><span class="o">(</span><span class="mi">6</span><span class="w"> </span><span class="n">decimals</span><span class="o">)</span>
<span class="n">Displayed</span><span class="o">:</span><span class="w"> </span><span class="n">$41</span><span class="o">.</span><span class="mi">60</span><span class="w"> </span><span class="n">USD</span><span class="w">  </span><span class="err">‚úÖ</span><span class="w"> </span><span class="n">CORRECT</span><span class="o">!</span>
</code></pre></div>

<hr />
<h2>üìù Testing Instructions</h2>
<h3><strong>Step 1: Hard Refresh Frontend</strong></h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Clear browser cache</span>
Ctrl+Shift+R<span class="w"> </span><span class="o">(</span>Linux/Windows<span class="o">)</span><span class="w"> </span>or<span class="w"> </span>Cmd+Shift+R<span class="w"> </span><span class="o">(</span>Mac<span class="o">)</span>

<span class="c1"># Or open incognito window</span>
</code></pre></div>

<h3><strong>Step 2: Withdraw Existing Collateral</strong></h3>
<p>Your current collateral still has the OLD buggy value. You need to withdraw it first:</p>
<ol>
<li><strong>Open Withdraw Modal</strong></li>
<li><strong>Withdraw ALL</strong> (UI shows 2.16 SOL, but vault only has the actual deposited amount)</li>
<li><strong>If error:</strong> Withdraw the actual amount you deposited (e.g., 0.2 SOL)</li>
</ol>
<h3><strong>Step 3: Re-Deposit with Fixed Code</strong></h3>
<ol>
<li><strong>Deposit 0.2 SOL</strong></li>
<li><strong>Check Display:</strong></li>
<li>‚úÖ Total Collateral: <strong>$41.60 USD</strong> (not $200!)</li>
<li>‚úÖ SOL Holdings: <strong>0.2 SOL</strong></li>
<li>‚úÖ Max Withdrawal: <strong>0.2 SOL</strong></li>
</ol>
<hr />
<h2>üßÆ Price Calculation Reference</h2>
<h3><strong>Fixed Devnet Price:</strong></h3>
<ul>
<li><strong>SOL/USD:</strong> $208 (fixed fallback for devnet)</li>
</ul>
<h3><strong>Deposit Amount ‚Üí USD Value:</strong></h3>
<table>
<thead>
<tr>
<th>SOL Amount</th>
<th>USD Value @ $208/SOL</th>
<th>Display</th>
</tr>
</thead>
<tbody>
<tr>
<td>0.10 SOL</td>
<td>$20.80</td>
<td>$20.80 USD</td>
</tr>
<tr>
<td>0.20 SOL</td>
<td>$41.60</td>
<td>$41.60 USD ‚úÖ</td>
</tr>
<tr>
<td>0.45 SOL</td>
<td>$93.60</td>
<td>$93.60 USD</td>
</tr>
<tr>
<td>1.00 SOL</td>
<td>$208.00</td>
<td>$208.00 USD</td>
</tr>
</tbody>
</table>
<hr />
<h2>üö® Known Issue: "Transaction Already Processed" Error</h2>
<h3><strong>Symptom:</strong></h3>
<div class="codehilite"><pre><span></span><code><span class="n">Error</span><span class="o">:</span><span class="w"> </span><span class="n">Transaction</span><span class="w"> </span><span class="n">simulation</span><span class="w"> </span><span class="n">failed</span><span class="o">:</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="n">transaction</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">already</span><span class="w"> </span><span class="n">been</span><span class="w"> </span><span class="n">processed</span>
</code></pre></div>

<h3><strong>Cause:</strong></h3>
<p>React Strict Mode in development causes components to render twice, potentially submitting transactions twice.</p>
<h3><strong>Mitigation (Already Implemented):</strong></h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// In DepositModal.tsx and WithdrawModal.tsx</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">isProcessingRef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useRef</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">isProcessingRef</span><span class="p">.</span><span class="nx">current</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;‚ö†Ô∏è Transaction already in progress, ignoring duplicate call&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">isProcessingRef</span><span class="p">.</span><span class="nx">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// ... transaction logic</span>
<span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">isProcessingRef</span><span class="p">.</span><span class="nx">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"> </span><span class="c1">// Reset after completion</span>
<span class="p">}</span>
</code></pre></div>

<h3><strong>If Error Persists:</strong></h3>
<ol>
<li><strong>Wait 2-3 seconds</strong> and try again</li>
<li><strong>Hard refresh</strong> browser (Ctrl+Shift+R)</li>
<li><strong>Reconnect wallet</strong> (disconnect then reconnect)</li>
</ol>
<hr />
<h2>üîç How to Verify Fix is Working</h2>
<h3><strong>Method 1: Check Console Logs</strong></h3>
<p>After depositing 0.2 SOL, look for:</p>
<div class="codehilite"><pre><span></span><code>‚úÖ Should see: &quot;üîÆ Oracle Price: $208.00, 200000000 lamports = $41.60 USD (fixed)&quot;
‚ùå Should NOT see: &quot;200 USD&quot; or &quot;$200&quot;
</code></pre></div>

<h3><strong>Method 2: Check Account Data</strong></h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># In browser console</span>
localStorage.getItem<span class="o">(</span><span class="s1">&#39;accountState&#39;</span><span class="o">)</span>
<span class="c1"># Should show totalCollateral around 41.6 (in USD, 6 decimals = 41,600,000)</span>
</code></pre></div>

<h3><strong>Method 3: Use Solana Explorer</strong></h3>
<ol>
<li>Go to https://explorer.solana.com/?cluster=devnet</li>
<li>Paste your wallet address</li>
<li>Find the Collateral Account PDA</li>
<li>Check <code>valueUsd</code> field: Should be <strong>41,600,000</strong> (6 decimals) for 0.2 SOL</li>
</ol>
<hr />
<h2>üí° Why the Old Value Shows</h2>
<p><strong>Q: Why does my account still show $200 for 0.2 SOL after the fix?</strong></p>
<p><strong>A:</strong> The old value is <strong>STORED ON-CHAIN</strong> in your Collateral Account PDA. The smart contract fix only affects <strong>NEW</strong> deposits. To clear the old data:</p>
<ol>
<li><strong>Withdraw</strong> the existing collateral</li>
<li><strong>Re-deposit</strong> using the fixed smart contract</li>
<li><strong>New deposit</strong> will use the correct calculation</li>
</ol>
<hr />
<h2>üé¨ Hackathon Demo Script</h2>
<div class="codehilite"><pre><span></span><code><span class="s">&quot;I identified a critical bug in our oracle integration where lamports were </span>
<span class="s">being stored as USD directly, causing a 4.8x overvaluation.</span>

<span class="s">For example, depositing 0.2 SOL (200 million lamports) was incorrectly </span>
<span class="s">valued at $200 instead of the correct $41.60.</span>

<span class="s">I fixed this by implementing a proper oracle module with Pyth integration </span>
<span class="s">and a fixed-price fallback for devnet:</span>

<span class="s">1. Convert lamports to SOL (√∑ 1e9)</span>
<span class="s">2. Multiply by oracle price ($208/SOL)</span>
<span class="s">3. Store as 6-decimal USD (√ó 1e6)</span>

<span class="s">I also learned the importance of using &#39;solana program upgrade&#39; instead of </span>
<span class="s">&#39;solana program deploy&#39; to properly update existing programs.</span>

<span class="s">Let me demonstrate:</span>
<span class="s">[Withdraw old collateral]</span>
<span class="s">[Deposit 0.2 SOL]</span>
<span class="s">[Show $41.60 USD display - CORRECT!]</span>

<span class="s">This fix is critical for preventing liquidation issues and ensuring fair </span>
<span class="s">trading on our perpetual DEX.&quot;</span>
</code></pre></div>

<hr />
<h2>üìö Key Learnings</h2>
<h3><strong>1. Deployment Methods Matter</strong></h3>
<ul>
<li>‚ùå <code>solana program deploy</code> ‚Üí Creates NEW program (wrong for updates!)</li>
<li>‚úÖ <code>solana program write-buffer</code> + <code>solana program upgrade</code> ‚Üí Updates EXISTING program</li>
</ul>
<h3><strong>2. Verify Deployments</strong></h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Check deployment slot</span>
solana<span class="w"> </span>program<span class="w"> </span>show<span class="w"> </span>&lt;PROGRAM_ID&gt;<span class="w"> </span>--url<span class="w"> </span>devnet<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s2">&quot;Last Deployed&quot;</span>

<span class="c1"># Verify bytecode matches</span>
anchor<span class="w"> </span>verify<span class="w"> </span>&lt;PROGRAM_ID&gt;
</code></pre></div>

<h3><strong>3. Oracle Integration Best Practices</strong></h3>
<ul>
<li>Always convert units properly (lamports ‚Üí SOL ‚Üí USD)</li>
<li>Use fixed-price fallback for devnet (Pyth feeds often empty)</li>
<li>Store values in fixed-point format (6 decimals for USD)</li>
<li>Log calculations for debugging</li>
</ul>
<h3><strong>4. On-Chain State Persistence</strong></h3>
<ul>
<li>Program upgrades don't modify existing account data</li>
<li>Users must re-deposit to populate accounts with new calculations</li>
<li>Consider migration scripts for production</li>
</ul>
<hr />
<h2>‚úÖ Success Criteria</h2>
<h3><strong>Fix is WORKING if:</strong></h3>
<ul>
<li>[ ] 0.2 SOL shows as $41.60 USD (not $200!)</li>
<li>[ ] Withdrawal works without errors</li>
<li>[ ] Console shows correct oracle price logs</li>
<li>[ ] Max withdrawal matches deposited amount</li>
</ul>
<h3><strong>Fix is BROKEN if:</strong></h3>
<ul>
<li>[ ] Still shows $200 for 0.2 SOL</li>
<li>[ ] Withdrawal fails with "Cross-program invocation" error</li>
<li>[ ] Console shows "$200 USD" in logs</li>
</ul>
<hr />
<h2>üöÄ Next Steps (Post-Hackathon)</h2>
<ol>
<li><strong>Mainnet Deployment</strong></li>
<li>Switch from fixed price to live Pyth feeds</li>
<li>Remove devnet fallback logic</li>
<li>
<p>Test with real SOL prices</p>
</li>
<li>
<p><strong>Multi-Oracle Support</strong></p>
</li>
<li>Add Switchboard for redundancy</li>
<li>Implement Jupiter Price API for long-tail tokens</li>
<li>
<p>Add price aggregation and median filtering</p>
</li>
<li>
<p><strong>Account Migration</strong></p>
</li>
<li>Create script to help users migrate from old accounts</li>
<li>
<p>Auto-detect and warn about buggy collateral values</p>
</li>
<li>
<p><strong>Monitoring</strong></p>
</li>
<li>Add price deviation alerts</li>
<li>Monitor oracle staleness</li>
<li>Track collateral calculations</li>
</ol>
<hr />
<h2>üìû Support</h2>
<p>If you still see incorrect prices after following this guide:</p>
<ol>
<li><strong>Check deployment slot:</strong> Should be <strong>414433599</strong> or later</li>
<li><strong>Check you withdrew old collateral:</strong> Must clear old on-chain data</li>
<li><strong>Hard refresh browser:</strong> Clear all caches</li>
<li><strong>Check console logs:</strong> Look for "üîÆ Oracle Price" messages</li>
</ol>
<p><strong>Program ID:</strong> <code>HsSzXVuSwiqGQvocT2zMX8zc86KQ9TYfZFZcfmmejzso</code><br />
<strong>Latest Deployment Slot:</strong> <code>414433599</code><br />
<strong>Deployment Date:</strong> October 14, 2025 ~3:30 AM UTC</p>
<hr />
<h2>üéâ <strong>Ready to Test!</strong></h2>
<p><strong>Withdraw your old collateral, re-deposit, and verify $41.60 for 0.2 SOL!</strong> üöÄ</p>
    </div>
</body>
</html>