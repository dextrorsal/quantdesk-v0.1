<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Devnet-Troubleshooting - QuantDesk Documentation</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <style>
        body {
            font-family: 'JetBrains Mono', 'Monaco', 'Consolas', monospace;
            line-height: 1.6;
            color: #ffffff;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #000000;
            font-size: 14px;
        }
        .container {
            background: #000000;
            padding: 30px;
            border-radius: 8px;
            border: 1px solid #333333;
        }
        .back-link {
            margin-bottom: 20px;
        }
        .back-link a {
            color: #3b82f6;
            text-decoration: none;
            font-weight: bold;
            transition: color 0.3s ease;
        }
        .back-link a:hover {
            color: #60a5fa;
            text-decoration: underline;
        }
        h1, h2, h3, h4, h5, h6 {
            color: #ffffff;
            margin-top: 30px;
            margin-bottom: 15px;
            font-weight: 600;
        }
        h1 {
            border-bottom: 2px solid #333333;
            padding-bottom: 10px;
        }
        h2 {
            border-bottom: 1px solid #333333;
            padding-bottom: 8px;
        }
        code {
            background: #1a1a1a;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'JetBrains Mono', 'Monaco', 'Consolas', monospace;
            color: #ffffff;
            border: 1px solid #333333;
        }
        pre {
            background: #0a0a0a;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            border: 1px solid #333333;
            margin: 20px 0;
        }
        pre code {
            background: none;
            padding: 0;
            color: #ffffff;
            border: none;
        }
        blockquote {
            border-left: 4px solid #3b82f6;
            margin: 0;
            padding-left: 20px;
            color: #d9d9d9;
            background: #1a1a1a;
            padding: 15px 20px;
            border-radius: 0 8px 8px 0;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
            border: 1px solid #333333;
        }
        th, td {
            border: 1px solid #333333;
            padding: 12px;
            text-align: left;
        }
        th {
            background: #1a1a1a;
            font-weight: bold;
            color: #ffffff;
        }
        td {
            color: #d9d9d9;
        }
        ul, ol {
            color: #d9d9d9;
        }
        li {
            margin-bottom: 8px;
        }
        a {
            color: #3b82f6;
            text-decoration: none;
        }
        a:hover {
            color: #60a5fa;
            text-decoration: underline;
        }
        /* Syntax Highlighting Overrides */
        pre[class*="language-"] {
            background: #0a0a0a !important;
            border: 1px solid #333333 !important;
            border-radius: 8px !important;
            padding: 20px !important;
            margin: 20px 0 !important;
            font-family: 'JetBrains Mono', 'Monaco', 'Consolas', monospace !important;
            font-size: 13px !important;
            line-height: 1.5 !important;
        }
        .token.comment { color: #6a9955 !important; }
        .token.keyword { color: #569cd6 !important; }
        .token.string { color: #ce9178 !important; }
        .token.number { color: #b5cea8 !important; }
        .token.function { color: #dcdcaa !important; }
        .token.class-name { color: #4ec9b0 !important; }
        .token.operator { color: #d4d4d4 !important; }
        .token.punctuation { color: #d4d4d4 !important; }
        .token.variable { color: #9cdcfe !important; }
        .token.constant { color: #4fc1ff !important; }
    </style>
</head>
<body>
    <div class="container">
        <div class="back-link">
            <a href="/">&larr; Back to Documentation</a>
        </div>
        <h1>QuantDesk Devnet Troubleshooting Runbook</h1>
<h2>Quick Diagnostic Commands</h2>
<div class="codehilite"><pre><span></span><code><span class="c1"># Check all systems</span>
<span class="nb">cd</span><span class="w"> </span>solana-sandbox<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>pnpm<span class="w"> </span>run<span class="w"> </span>check-program<span class="w">  </span><span class="c1"># Verify program</span>
curl<span class="w"> </span>http://localhost:3002/api/health<span class="w">          </span><span class="c1"># Backend health</span>
curl<span class="w"> </span>http://localhost:3002/api/markets<span class="w">         </span><span class="c1"># Markets data</span>
solana<span class="w"> </span>balance<span class="w">                                  </span><span class="c1"># Wallet balance</span>
</code></pre></div>

<hr />
<h2>Error Categories</h2>
<h3>🔴 Critical Errors (Service Down)</h3>
<ul>
<li>Program not deployed</li>
<li>Backend not responding</li>
<li>Database unreachable</li>
</ul>
<h3>🟡 Transaction Errors (User Impact)</h3>
<ul>
<li>Account creation fails</li>
<li>Position opening fails</li>
<li>Insufficient balance</li>
</ul>
<h3>🟢 Warning Errors (Degraded)</h3>
<ul>
<li>Stale oracle prices</li>
<li>RPC rate limits</li>
<li>Slow confirmations</li>
</ul>
<hr />
<h2>Common Errors &amp; Solutions</h2>
<h3>Error: <code>AccountDidNotDeserialize</code> (Error 3003)</h3>
<p><strong>Symptoms:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">Error</span><span class="o">:</span><span class="w"> </span><span class="n">Account</span><span class="w"> </span><span class="n">does</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">match</span><span class="w"> </span><span class="n">expected</span><span class="w"> </span><span class="n">type</span>
<span class="n">Error</span><span class="w"> </span><span class="n">Code</span><span class="o">:</span><span class="w"> </span><span class="mi">3003</span><span class="w"> </span><span class="o">(</span><span class="n">AccountDidNotDeserialize</span><span class="o">)</span>
</code></pre></div>

<p><strong>Cause:</strong> IDL mismatch between frontend and deployed program</p>
<p><strong>Diagnosis:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>solana-sandbox
pnpm<span class="w"> </span>run<span class="w"> </span>validate-idl
</code></pre></div>

<p><strong>Solution:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Option 1: Rebuild and redeploy program</span>
<span class="nb">cd</span><span class="w"> </span>contracts
anchor<span class="w"> </span>build
anchor<span class="w"> </span>deploy<span class="w"> </span>--provider.cluster<span class="w"> </span>devnet
cp<span class="w"> </span>target/idl/quantdesk_perp_dex.json<span class="w"> </span>../../frontend/src/types/

<span class="c1"># Option 2: Use correct IDL from deployment</span>
<span class="nb">cd</span><span class="w"> </span>contracts
anchor<span class="w"> </span>idl<span class="w"> </span>fetch<span class="w"> </span>GcpEyGMJg9AvEx8LgAyzyUNTPWFxovHxtmQ4vVWuWu3a
cp<span class="w"> </span>.anchor/idl/quantdesk_perp_dex.json<span class="w"> </span>../../frontend/src/types/
</code></pre></div>

<p><strong>Prevention:</strong> Always sync IDL after redeployment</p>
<hr />
<h3>Error: <code>InvalidAccountData</code> or Wrong PDA</h3>
<p><strong>Symptoms:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">Error</span><span class="o">:</span><span class="w"> </span><span class="n">Invalid</span><span class="w"> </span><span class="n">seeds</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">PDA</span>
<span class="n">Account</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">expected</span><span class="w"> </span><span class="n">address</span>
</code></pre></div>

<p><strong>Cause:</strong> PDA derivation mismatch between frontend and smart contract</p>
<p><strong>Diagnosis:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>solana-sandbox
pnpm<span class="w"> </span>run<span class="w"> </span>derive<span class="w"> </span>--<span class="w"> </span>--wallet<span class="w"> </span>&lt;YOUR_WALLET&gt;<span class="w"> </span>--index<span class="w"> </span><span class="m">0</span>
</code></pre></div>

<p><strong>Compare with smart contract seeds:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// In lib.rs - User Account PDA</span>
<span class="n">seeds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s">b&quot;user_account&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="n">authority</span><span class="p">.</span><span class="n">key</span><span class="p">().</span><span class="n">as_ref</span><span class="p">(),</span>
<span class="w">    </span><span class="o">&amp;</span><span class="n">account_index</span><span class="p">.</span><span class="n">to_le_bytes</span><span class="p">()</span><span class="w">  </span><span class="c1">// Must be u16 little-endian!</span>
<span class="p">]</span>
</code></pre></div>

<p><strong>Solution in Frontend:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Correct PDA derivation</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">accountIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">accountIndexBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Buffer</span><span class="p">.</span><span class="nx">alloc</span><span class="p">(</span><span class="mf">2</span><span class="p">);</span>
<span class="nx">accountIndexBuffer</span><span class="p">.</span><span class="nx">writeUInt16LE</span><span class="p">(</span><span class="nx">accountIndex</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>

<span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">userAccountPDA</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">PublicKey</span><span class="p">.</span><span class="nx">findProgramAddressSync</span><span class="p">(</span>
<span class="w">    </span><span class="p">[</span>
<span class="w">        </span><span class="nx">Buffer</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="s2">&quot;user_account&quot;</span><span class="p">),</span>
<span class="w">        </span><span class="nx">wallet</span><span class="p">.</span><span class="nx">publicKey</span><span class="p">.</span><span class="nx">toBuffer</span><span class="p">(),</span>
<span class="w">        </span><span class="nx">accountIndexBuffer</span><span class="w">  </span><span class="c1">// ✅ Correct: 2 bytes, little-endian</span>
<span class="w">    </span><span class="p">],</span>
<span class="w">    </span><span class="nx">program</span><span class="p">.</span><span class="nx">programId</span>
<span class="p">);</span>

<span class="c1">// ❌ WRONG:</span>
<span class="nx">Buffer</span><span class="p">.</span><span class="kr">from</span><span class="p">([</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">])</span><span class="w">  </span><span class="c1">// Don&#39;t use this!</span>
</code></pre></div>

<p><strong>Prevention:</strong> Use helper functions from <code>frontend/src/utils/accountHelpers.ts</code></p>
<hr />
<h3>Error: <code>InsufficientFunds</code> / <code>0x1</code> (Custom Program Error)</h3>
<p><strong>Symptoms:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">Error</span><span class="o">:</span><span class="w"> </span><span class="n">Insufficient</span><span class="w"> </span><span class="n">funds</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">transaction</span>
<span class="n">Error</span><span class="o">:</span><span class="w"> </span><span class="n">custom</span><span class="w"> </span><span class="n">program</span><span class="w"> </span><span class="n">error</span><span class="o">:</span><span class="w"> </span><span class="mh">0x1</span>
</code></pre></div>

<p><strong>Cause:</strong> Not enough SOL for rent or transaction fees</p>
<p><strong>Diagnosis:</strong></p>
<div class="codehilite"><pre><span></span><code>solana<span class="w"> </span>balance
<span class="c1"># Should show &gt; 0.02 SOL</span>
</code></pre></div>

<p><strong>Solution:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Request devnet airdrop</span>
solana<span class="w"> </span>airdrop<span class="w"> </span><span class="m">2</span>

<span class="c1"># Or use web faucet</span>
<span class="c1"># https://faucet.solana.com</span>
</code></pre></div>

<p><strong>Prevention:</strong> Set up airdrop automation in test scripts</p>
<hr />
<h3>Error: <code>Transaction Simulation Failed</code></h3>
<p><strong>Symptoms:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">Error</span><span class="o">:</span><span class="w"> </span><span class="n">Transaction</span><span class="w"> </span><span class="n">simulation</span><span class="w"> </span><span class="n">failed</span><span class="o">:</span><span class="w"> </span><span class="n">Error</span><span class="w"> </span><span class="n">processing</span><span class="w"> </span><span class="n">Instruction</span><span class="w"> </span><span class="mi">0</span>
<span class="n">Logs</span><span class="o">:</span>
<span class="w">  </span><span class="n">Program</span><span class="w"> </span><span class="n">GcpEy</span><span class="o">...</span><span class="w"> </span><span class="n">invoke</span><span class="w"> </span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>
<span class="w">  </span><span class="n">Program</span><span class="w"> </span><span class="n">log</span><span class="o">:</span><span class="w"> </span><span class="n">AnchorError</span><span class="w"> </span><span class="n">caused</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">account</span><span class="o">:</span><span class="w"> </span><span class="n">user_account</span>
<span class="w">  </span><span class="n">Program</span><span class="w"> </span><span class="n">GcpEy</span><span class="o">...</span><span class="w"> </span><span class="n">consumed</span><span class="w"> </span><span class="mi">5000</span><span class="w"> </span><span class="n">compute</span><span class="w"> </span><span class="n">units</span>
<span class="w">  </span><span class="n">Program</span><span class="w"> </span><span class="n">GcpEy</span><span class="o">...</span><span class="w"> </span><span class="n">failed</span><span class="o">:</span><span class="w"> </span><span class="n">invalid</span><span class="w"> </span><span class="n">account</span><span class="w"> </span><span class="n">data</span>
</code></pre></div>

<p><strong>Diagnosis Steps:</strong></p>
<ol>
<li><strong>Check account exists:</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>solana-sandbox
pnpm<span class="w"> </span>run<span class="w"> </span>inspect<span class="w"> </span>--<span class="w"> </span>&lt;ACCOUNT_ADDRESS&gt;
</code></pre></div>

<ol>
<li><strong>Verify account ownership:</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code>solana<span class="w"> </span>account<span class="w"> </span>&lt;ACCOUNT_ADDRESS&gt;
<span class="c1"># Owner should be: GcpEyGMJg9AvEx8LgAyzyUNTPWFxovHxtmQ4vVWuWu3a</span>
</code></pre></div>

<ol>
<li><strong>Check account constraints:</strong></li>
<li>Review smart contract constraints</li>
<li>Verify signer requirements</li>
<li>Check mutability flags</li>
</ol>
<p><strong>Common Fixes:</strong>
- User account not initialized → Create account first
- Wrong account passed → Verify PDA derivation
- Missing signer → Add wallet.publicKey as signer
- Account not mutable → Add <code>mut</code> flag in context</p>
<hr />
<h3>Error: <code>Program Not Found</code> / <code>ProgramAccountNotFound</code></h3>
<p><strong>Symptoms:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">Error</span><span class="o">:</span><span class="w"> </span><span class="n">Program</span><span class="w"> </span><span class="n">GcpEy</span><span class="o">...</span><span class="n">Wu3a</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">found</span>
</code></pre></div>

<p><strong>Diagnosis:</strong></p>
<div class="codehilite"><pre><span></span><code>solana<span class="w"> </span>program<span class="w"> </span>show<span class="w"> </span>GcpEyGMJg9AvEx8LgAyzyUNTPWFxovHxtmQ4vVWuWu3a
</code></pre></div>

<p><strong>If not found:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>contracts
anchor<span class="w"> </span>deploy<span class="w"> </span>--provider.cluster<span class="w"> </span>devnet
</code></pre></div>

<p><strong>If deployed but still error:</strong>
1. Check Program ID matches everywhere:
   - <code>contracts/smart-contracts/lib.rs</code> (declare_id!)
   - <code>contracts/smart-contracts/Anchor.toml</code>
   - <code>backend/.env</code> (PROGRAM_ID)
   - <code>frontend/src/contexts/ProgramContext.tsx</code></p>
<ol>
<li>Rebuild with correct ID:</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>contracts
<span class="c1"># Update lib.rs declare_id! first</span>
anchor<span class="w"> </span>build
anchor<span class="w"> </span>deploy<span class="w"> </span>--provider.cluster<span class="w"> </span>devnet
</code></pre></div>

<hr />
<h3>Error: <code>BlockhashNotFound</code> / Transaction Timeout</h3>
<p><strong>Symptoms:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">Error</span><span class="o">:</span><span class="w"> </span><span class="n">Transaction</span><span class="w"> </span><span class="n">was</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">confirmed</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="n">seconds</span>
<span class="n">Error</span><span class="o">:</span><span class="w"> </span><span class="n">Blockhash</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">found</span>
</code></pre></div>

<p><strong>Cause:</strong> Network congestion or outdated blockhash</p>
<p><strong>Solution:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// In frontend, increase confirmation timeout</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">tx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">program</span><span class="p">.</span><span class="nx">methods</span>
<span class="w">    </span><span class="p">.</span><span class="nx">createUserAccount</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="nx">accounts</span><span class="p">({</span><span class="w"> </span><span class="cm">/* ... */</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="p">.</span><span class="nx">rpc</span><span class="p">({</span><span class="w"> </span>
<span class="w">        </span><span class="nx">skipPreflight</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span>
<span class="w">        </span><span class="nx">commitment</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;confirmed&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">maxRetries</span><span class="o">:</span><span class="w"> </span><span class="kt">3</span>
<span class="w">    </span><span class="p">});</span>

<span class="c1">// Wait with longer timeout</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">confirmation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">connection</span><span class="p">.</span><span class="nx">confirmTransaction</span><span class="p">(</span><span class="nx">tx</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">commitment</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;confirmed&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">maxRetries</span><span class="o">:</span><span class="w"> </span><span class="kt">5</span>
<span class="p">});</span>
</code></pre></div>

<p><strong>Prevention:</strong> Implement retry logic with exponential backoff</p>
<hr />
<h3>Error: <code>429 Too Many Requests</code> (RPC Rate Limit)</h3>
<p><strong>Symptoms:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">Error</span><span class="o">:</span><span class="w"> </span><span class="mi">429</span><span class="w"> </span><span class="n">Too</span><span class="w"> </span><span class="n">Many</span><span class="w"> </span><span class="n">Requests</span>
<span class="n">Failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">fetch</span>
</code></pre></div>

<p><strong>Immediate Solution:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Wait 60 seconds and retry</span>
<span class="c1"># Or switch to paid RPC</span>
</code></pre></div>

<p><strong>Long-term Solution:</strong>
Update <code>backend/.env</code>:</p>
<div class="codehilite"><pre><span></span><code># Use Helius, QuickNode, or other paid RPC
RPC_URL=https://devnet.helius-rpc.com/?api-key=YOUR_KEY
SOLANA_RPC_URL=https://devnet.helius-rpc.com/?api-key=YOUR_KEY
</code></pre></div>

<p><strong>Prevention:</strong> Implement request caching and batching</p>
<hr />
<h3>Error: <code>MarketNotFound</code> / Empty Markets List</h3>
<p><strong>Symptoms:</strong>
- Frontend shows no markets
- API returns empty array</p>
<p><strong>Diagnosis:</strong></p>
<div class="codehilite"><pre><span></span><code>curl<span class="w"> </span>http://localhost:3002/api/markets
</code></pre></div>

<p><strong>If empty:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>backend
pnpm<span class="w"> </span>run<span class="w"> </span>init:devnet
</code></pre></div>

<p><strong>Check database:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">-- Connect to Supabase</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">markets</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">is_active</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">;</span>
</code></pre></div>

<p><strong>If still empty:</strong> Manually insert markets via Supabase dashboard or SQL</p>
<hr />
<h3>Error: <code>PriceStale</code> / Oracle Update Failed</h3>
<p><strong>Symptoms:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">Error</span><span class="o">:</span><span class="w"> </span><span class="n">Oracle</span><span class="w"> </span><span class="n">price</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">stale</span>
<span class="n">Error</span><span class="o">:</span><span class="w"> </span><span class="n">Price</span><span class="w"> </span><span class="n">updated</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">minutes</span><span class="w"> </span><span class="n">ago</span>
</code></pre></div>

<p><strong>Diagnosis:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Check oracle service</span>
curl<span class="w"> </span>http://localhost:3002/api/oracle/prices
</code></pre></div>

<p><strong>Solution:</strong>
1. Verify Pyth price feeds are correct for devnet
2. Check backend oracle service is running
3. Manually update price (for testing):</p>
<div class="codehilite"><pre><span></span><code><span class="k">await</span><span class="w"> </span><span class="nx">program</span><span class="p">.</span><span class="nx">methods</span>
<span class="w">    </span><span class="p">.</span><span class="nx">updateOraclePrice</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nx">anchor</span><span class="p">.</span><span class="nx">BN</span><span class="p">(</span><span class="mf">100</span><span class="nx">_000_000</span><span class="p">))</span><span class="w"> </span><span class="c1">// $100</span>
<span class="w">    </span><span class="p">.</span><span class="nx">accounts</span><span class="p">({</span>
<span class="w">        </span><span class="nx">market</span><span class="o">:</span><span class="w"> </span><span class="kt">marketPDA</span><span class="p">,</span>
<span class="w">        </span><span class="nx">authority</span><span class="o">:</span><span class="w"> </span><span class="kt">wallet.publicKey</span><span class="p">,</span>
<span class="w">        </span><span class="nx">clock</span><span class="o">:</span><span class="w"> </span><span class="kt">SYSVAR_CLOCK_PUBKEY</span><span class="p">,</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">    </span><span class="p">.</span><span class="nx">rpc</span><span class="p">();</span>
</code></pre></div>

<hr />
<h3>Error: Frontend Can't Create User Account</h3>
<p><strong>Symptoms:</strong>
- "Create Account" button doesn't work
- Transaction fails silently
- No error message shown</p>
<p><strong>Diagnosis:</strong>
1. <strong>Check wallet connection:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Wallet:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">wallet</span><span class="p">.</span><span class="nx">publicKey</span><span class="o">?</span><span class="p">.</span><span class="nx">toBase58</span><span class="p">());</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Program:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">program</span><span class="o">?</span><span class="p">.</span><span class="nx">programId</span><span class="p">.</span><span class="nx">toBase58</span><span class="p">());</span>
</code></pre></div>

<ol>
<li><strong>Check PDA derivation:</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">pda</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">deriveUserAccountPDA</span><span class="p">(</span><span class="nx">program</span><span class="p">,</span><span class="w"> </span><span class="nx">wallet</span><span class="p">.</span><span class="nx">publicKey</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;User Account PDA:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">pda</span><span class="p">.</span><span class="nx">toBase58</span><span class="p">());</span>
</code></pre></div>

<ol>
<li><strong>Check transaction building:</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">tx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">program</span><span class="p">.</span><span class="nx">methods</span>
<span class="w">    </span><span class="p">.</span><span class="nx">createUserAccount</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="nx">accounts</span><span class="p">({</span>
<span class="w">        </span><span class="nx">userAccount</span><span class="o">:</span><span class="w"> </span><span class="nx">userAccountPDA</span><span class="p">,</span>
<span class="w">        </span><span class="nx">authority</span><span class="o">:</span><span class="w"> </span><span class="nx">wallet</span><span class="p">.</span><span class="nx">publicKey</span><span class="p">,</span>
<span class="w">        </span><span class="nx">systemProgram</span><span class="o">:</span><span class="w"> </span><span class="nx">SystemProgram</span><span class="p">.</span><span class="nx">programId</span><span class="p">,</span>
<span class="w">        </span><span class="nx">rent</span><span class="o">:</span><span class="w"> </span><span class="nx">SYSVAR_RENT_PUBKEY</span><span class="p">,</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">    </span><span class="p">.</span><span class="nx">rpc</span><span class="p">();</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Transaction:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">tx</span><span class="p">);</span>
</code></pre></div>

<p><strong>Common Issues:</strong>
- ❌ Missing SystemProgram
- ❌ Missing Rent sysvar
- ❌ Wrong PDA seeds
- ❌ Insufficient SOL</p>
<hr />
<h2>Debugging Workflow</h2>
<h3>Step 1: Verify System Status</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Check all components</span>
./scripts/health-check.sh<span class="w">  </span><span class="c1"># (create this if needed)</span>

<span class="c1"># Or manually:</span>
solana<span class="w"> </span>cluster-version<span class="w">              </span><span class="c1"># Devnet is up</span>
curl<span class="w"> </span>http://localhost:3002/health<span class="w">   </span><span class="c1"># Backend is up</span>
curl<span class="w"> </span>http://localhost:3001<span class="w">          </span><span class="c1"># Frontend is up</span>
</code></pre></div>

<h3>Step 2: Isolate the Problem</h3>
<p><strong>Is it Frontend?</strong>
- Check browser console
- Verify wallet connection
- Check network tab for failed API calls</p>
<p><strong>Is it Backend?</strong>
- Check <code>backend/logs/backend-dev.log</code>
- Test API endpoints with curl
- Verify database connection</p>
<p><strong>Is it Smart Contract?</strong>
- Run sandbox tests
- Check program logs with <code>solana logs</code>
- Verify program is deployed</p>
<p><strong>Is it Database?</strong>
- Query Supabase directly
- Check table schemas
- Verify RLS policies</p>
<h3>Step 3: Use Sandbox Tools</h3>
<div class="codehilite"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>solana-sandbox

<span class="c1"># Full diagnostic</span>
pnpm<span class="w"> </span>run<span class="w"> </span>test:flow

<span class="c1"># Specific checks</span>
pnpm<span class="w"> </span>run<span class="w"> </span>check-program<span class="w">     </span><span class="c1"># Program status</span>
pnpm<span class="w"> </span>run<span class="w"> </span>validate-idl<span class="w">      </span><span class="c1"># IDL consistency</span>
pnpm<span class="w"> </span>run<span class="w"> </span>inspect<span class="w"> </span>--<span class="w"> </span>&lt;addr&gt;<span class="w"> </span><span class="c1"># Account data</span>
</code></pre></div>

<hr />
<h2>Performance Issues</h2>
<h3>Slow Transaction Confirmations</h3>
<p><strong>Symptoms:</strong> Transactions take &gt; 30 seconds</p>
<p><strong>Solutions:</strong>
1. Use paid RPC with priority fees
2. Implement proper retry logic
3. Use <code>confirmed</code> instead of <code>finalized</code>
4. Add priority fees to transactions</p>
<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">tx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">program</span><span class="p">.</span><span class="nx">methods</span>
<span class="w">    </span><span class="p">.</span><span class="nx">openPosition</span><span class="p">(</span><span class="cm">/* args */</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="nx">accounts</span><span class="p">({</span><span class="w"> </span><span class="cm">/* accounts */</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="p">.</span><span class="nx">preInstructions</span><span class="p">([</span>
<span class="w">        </span><span class="nx">ComputeBudgetProgram</span><span class="p">.</span><span class="nx">setComputeUnitPrice</span><span class="p">({</span><span class="w"> </span><span class="nx">microLamports</span><span class="o">:</span><span class="w"> </span><span class="kt">1000</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="p">])</span>
<span class="w">    </span><span class="p">.</span><span class="nx">rpc</span><span class="p">();</span>
</code></pre></div>

<h3>High Memory Usage</h3>
<p><strong>Symptoms:</strong> Browser/backend consumes excessive RAM</p>
<p><strong>Solutions:</strong>
1. Limit WebSocket subscriptions
2. Implement pagination for markets/positions
3. Clear old data from state
4. Use React.memo and useMemo</p>
<hr />
<h2>Emergency Procedures</h2>
<h3>Critical: Program Upgrade Needed</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># 1. Backup current state</span>
solana<span class="w"> </span>program<span class="w"> </span>dump<span class="w"> </span>GcpEy...Wu3a<span class="w"> </span>backup.so

<span class="c1"># 2. Build new version</span>
anchor<span class="w"> </span>build

<span class="c1"># 3. Deploy upgrade</span>
anchor<span class="w"> </span>upgrade<span class="w"> </span>&lt;BUFFER_ADDRESS&gt;<span class="w"> </span>--program-id<span class="w"> </span>GcpEy...Wu3a

<span class="c1"># 4. Update IDL everywhere</span>
cp<span class="w"> </span>target/idl/quantdesk_perp_dex.json<span class="w"> </span>../../frontend/src/types/

<span class="c1"># 5. Restart services</span>
<span class="nb">cd</span><span class="w"> </span>backend<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>pnpm<span class="w"> </span>run<span class="w"> </span>dev
<span class="nb">cd</span><span class="w"> </span>frontend<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>pnpm<span class="w"> </span>run<span class="w"> </span>dev
</code></pre></div>

<h3>Critical: Database Migration Required</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># 1. Backup database</span>
pg_dump<span class="w"> </span>&lt;DATABASE_URL&gt;<span class="w"> </span>&gt;<span class="w"> </span>backup.sql

<span class="c1"># 2. Run migration</span>
psql<span class="w"> </span>&lt;DATABASE_URL&gt;<span class="w"> </span>&lt;<span class="w"> </span>database/migration-file.sql

<span class="c1"># 3. Verify</span>
psql<span class="w"> </span>&lt;DATABASE_URL&gt;<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;SELECT * FROM markets LIMIT 1;&quot;</span>

<span class="c1"># 4. Re-seed if needed</span>
<span class="nb">cd</span><span class="w"> </span>backend<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>pnpm<span class="w"> </span>run<span class="w"> </span>init:devnet
</code></pre></div>

<hr />
<h2>Useful Commands Reference</h2>
<div class="codehilite"><pre><span></span><code><span class="c1"># Solana</span>
solana<span class="w"> </span>--version<span class="w">                           </span><span class="c1"># Check CLI version</span>
solana<span class="w"> </span>config<span class="w"> </span>get<span class="w">                          </span><span class="c1"># Show config</span>
solana<span class="w"> </span>address<span class="w">                             </span><span class="c1"># Show wallet address</span>
solana<span class="w"> </span>balance<span class="w">                             </span><span class="c1"># Check balance</span>
solana<span class="w"> </span>airdrop<span class="w"> </span><span class="m">2</span><span class="w">                          </span><span class="c1"># Request SOL</span>
solana<span class="w"> </span>program<span class="w"> </span>show<span class="w"> </span>&lt;PROGRAM_ID&gt;<span class="w">          </span><span class="c1"># Program info</span>
solana<span class="w"> </span>logs<span class="w"> </span>&lt;PROGRAM_ID&gt;<span class="w">                  </span><span class="c1"># Watch logs</span>
solana<span class="w"> </span>account<span class="w"> </span>&lt;ACCOUNT_ADDRESS&gt;<span class="w">          </span><span class="c1"># Account details</span>

<span class="c1"># Anchor</span>
anchor<span class="w"> </span>--version<span class="w">                           </span><span class="c1"># Check version</span>
anchor<span class="w"> </span>build<span class="w">                              </span><span class="c1"># Build program</span>
anchor<span class="w"> </span>deploy<span class="w">                             </span><span class="c1"># Deploy program</span>
anchor<span class="w"> </span><span class="nb">test</span><span class="w">                               </span><span class="c1"># Run tests</span>
anchor<span class="w"> </span>idl<span class="w"> </span>fetch<span class="w"> </span>&lt;PROGRAM_ID&gt;<span class="w">            </span><span class="c1"># Fetch IDL</span>

<span class="c1"># Sandbox</span>
<span class="nb">cd</span><span class="w"> </span>solana-sandbox
pnpm<span class="w"> </span>run<span class="w"> </span>check-program<span class="w">                    </span><span class="c1"># Verify deployment</span>
pnpm<span class="w"> </span>run<span class="w"> </span>validate-idl<span class="w">                     </span><span class="c1"># Check IDL sync</span>
pnpm<span class="w"> </span>run<span class="w"> </span>inspect<span class="w"> </span>--<span class="w"> </span>&lt;ADDRESS&gt;<span class="w">            </span><span class="c1"># Inspect account</span>
pnpm<span class="w"> </span>run<span class="w"> </span>derive<span class="w"> </span>--<span class="w"> </span>--wallet<span class="w"> </span>&lt;ADDR&gt;<span class="w">       </span><span class="c1"># Derive PDA</span>
pnpm<span class="w"> </span>run<span class="w"> </span>test:flow<span class="w">                       </span><span class="c1"># E2E test</span>

<span class="c1"># Backend</span>
<span class="nb">cd</span><span class="w"> </span>backend
pnpm<span class="w"> </span>run<span class="w"> </span>dev<span class="w">                             </span><span class="c1"># Start server</span>
pnpm<span class="w"> </span>run<span class="w"> </span>init:devnet<span class="w">                     </span><span class="c1"># Initialize devnet</span>
curl<span class="w"> </span>localhost:3002/api/health<span class="w">           </span><span class="c1"># Health check</span>
curl<span class="w"> </span>localhost:3002/api/markets<span class="w">          </span><span class="c1"># Get markets</span>

<span class="c1"># Frontend</span>
<span class="nb">cd</span><span class="w"> </span>frontend
pnpm<span class="w"> </span>run<span class="w"> </span>dev<span class="w">                             </span><span class="c1"># Start dev server</span>
pnpm<span class="w"> </span>run<span class="w"> </span>build<span class="w">                           </span><span class="c1"># Production build</span>
</code></pre></div>

<hr />
<h2>Getting Help</h2>
<h3>Before Asking for Help</h3>
<p>Collect this information:
1. Error message (full text)
2. Transaction signature (if available)
3. Account addresses involved
4. Browser console logs
5. Backend logs
6. Steps to reproduce</p>
<h3>MCP Expert Tools</h3>
<p>Use the Solana MCP expert tools for complex issues:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Ask Solana Expert</span>
<span class="s2">&quot;How do I debug AccountDidNotDeserialize error 3003 in Anchor?&quot;</span>

<span class="c1">// Ask Anchor Expert  </span>
<span class="s2">&quot;Why is my PDA derivation failing with invalid seeds?&quot;</span>

<span class="c1">// Search Documentation</span>
<span class="s2">&quot;How to handle transaction confirmation in web3.js?&quot;</span>
</code></pre></div>

<h3>External Resources</h3>
<ul>
<li><strong>Solana Stack Exchange</strong>: https://solana.stackexchange.com</li>
<li><strong>Anchor Discord</strong>: https://discord.gg/anchor</li>
<li><strong>Solana Discord</strong>: https://discord.gg/solana</li>
<li><strong>Solana Cookbook</strong>: https://solanacookbook.com</li>
</ul>
<hr />
<h2>Monitoring Checklist</h2>
<p>Daily checks:
- [ ] Backend health endpoint responding
- [ ] Markets loading in frontend
- [ ] Oracle prices updating
- [ ] Transaction success rate &gt; 95%
- [ ] No error spikes in logs
- [ ] Database within size limits
- [ ] Devnet SOL balance sufficient</p>
<hr />
<p><strong>Last Updated</strong>: October 2025<br />
<strong>Maintainer</strong>: QuantDesk Team<br />
<strong>Emergency Contact</strong>: Check project README</p>
    </div>
</body>
</html>