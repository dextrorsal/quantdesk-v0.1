# Test Design: Story 1.1 - Real-time Portfolio Updates

**Date:** 2025-10-21  
**Designer:** Quinn (Test Architect)  
**Story:** Real-time Portfolio Updates  
**Epic:** 1.1  

## Test Strategy Overview

- **Total test scenarios:** 24
- **Unit tests:** 8 (33%)
- **Integration tests:** 10 (42%)
- **E2E tests:** 6 (25%)
- **Priority distribution:** P0: 12, P1: 8, P2: 4

## Test Scenarios by Acceptance Criteria

### AC1: Portfolio value updates automatically every 5 seconds

#### Scenarios

| ID           | Level       | Priority | Test                      | Justification            |
| ------------ | ----------- | -------- | ------------------------- | ------------------------ |
| 1.1-UNIT-001 | Unit        | P0       | WebSocket client reconnection logic with exponential backoff | Pure algorithm validation |
| 1.1-INT-001  | Integration | P0       | WebSocket endpoint delivers portfolio updates every 5s | Multi-component flow validation |
| 1.1-INT-002  | Integration | P0       | Background task triggers portfolio recalculation every 5s | Service integration |
| 1.1-E2E-001  | E2E         | P0       | User sees portfolio value update every 5 seconds | Critical user journey |

### AC2: Individual position values reflect current market prices

#### Scenarios

| ID           | Level       | Priority | Test                      | Justification            |
| ------------ | ----------- | -------- | ------------------------- | ------------------------ |
| 1.1-UNIT-002 | Unit        | P0       | Portfolio calculation service with current prices | Pure calculation logic |
| 1.1-INT-003  | Integration | P0       | Oracle price feed integration updates position values | External service integration |
| 1.1-INT-004  | Integration | P1       | Database query optimization for position aggregation | Performance-critical integration |
| 1.1-E2E-002  | E2E         | P1       | Position cards show accurate current market values | User experience validation |

### AC3: UI shows smooth animations without flickering

#### Scenarios

| ID           | Level       | Priority | Test                      | Justification            |
| ------------ | ----------- | -------- | ------------------------- | ------------------------ |
| 1.1-UNIT-003 | Unit        | P1       | React Spring animation configuration | Component behavior |
| 1.1-INT-005  | Integration | P1       | Redux state updates trigger smooth UI transitions | State management integration |
| 1.1-E2E-003  | E2E         | P1       | Visual regression test for smooth animations | User experience validation |

### AC4: Updates pause when user is viewing order form

#### Scenarios

| ID           | Level       | Priority | Test                      | Justification            |
| ------------ | ----------- | -------- | ------------------------- | ------------------------ |
| 1.1-UNIT-004 | Unit        | P1       | WebSocket pause/resume logic | Pure state management |
| 1.1-INT-006  | Integration | P1       | Frontend state management pauses updates | Component interaction |
| 1.1-E2E-004  | E2E         | P1       | Portfolio updates pause during order form interaction | User workflow validation |

### Cross-Department Integration Requirements

#### Backend WebSocket Service

| ID           | Level       | Priority | Test                      | Justification            |
| ------------ | ----------- | -------- | ------------------------- | ------------------------ |
| 1.1-INT-007  | Integration | P0       | WebSocket endpoint `/ws/portfolio` with user-specific rooms | Critical service contract |
| 1.1-INT-008  | Integration | P0       | JWT authentication for WebSocket connections | Security-critical integration |
| 1.1-E2E-005  | E2E         | P0       | Multiple users receive isolated portfolio updates | Multi-user security validation |

#### Database Optimization

| ID           | Level       | Priority | Test                      | Justification            |
| ------------ | ----------- | -------- | ------------------------- | ------------------------ |
| 1.1-UNIT-005 | Unit        | P1       | Database function for portfolio calculation | Pure calculation logic |
| 1.1-INT-009  | Integration | P1       | Composite index performance for position queries | Performance-critical integration |
| 1.1-E2E-006  | E2E         | P2       | Portfolio calculation performance under load | Performance validation |

#### Caching Strategy

| ID           | Level       | Priority | Test                      | Justification            |
| ------------ | ----------- | -------- | ------------------------- | ------------------------ |
| 1.1-UNIT-006 | Unit        | P1       | Cache TTL and invalidation logic | Pure cache management |
| 1.1-INT-010  | Integration | P1       | Cache invalidation triggers WebSocket updates | Cache-service integration |

#### Oracle Integration

| ID           | Level       | Priority | Test                      | Justification            |
| ------------ | ----------- | -------- | ------------------------- | ------------------------ |
| 1.1-UNIT-007 | Unit        | P0       | Price feed processing and normalization | Pure data transformation |
| 1.1-UNIT-008 | Unit        | P2       | Error handling for Oracle service failures | Error handling logic |

## Risk Coverage

| Risk ID | Risk Description | Mitigating Tests |
|---------|------------------|------------------|
| RISK-001 | WebSocket connection instability | 1.1-UNIT-001, 1.1-INT-001, 1.1-E2E-001 |
| RISK-002 | Database performance under load | 1.1-INT-004, 1.1-INT-009, 1.1-E2E-006 |
| RISK-003 | Cache inconsistency with database | 1.1-INT-010 |
| RISK-004 | Frontend state synchronization issues | 1.1-INT-005, 1.1-INT-006 |

## Recommended Execution Order

1. **P0 Unit tests** (fail fast on critical logic)
   - 1.1-UNIT-001: WebSocket reconnection logic
   - 1.1-UNIT-002: Portfolio calculation service
   - 1.1-UNIT-007: Price feed processing

2. **P0 Integration tests** (critical service contracts)
   - 1.1-INT-001: WebSocket endpoint functionality
   - 1.1-INT-002: Background task triggers
   - 1.1-INT-003: Oracle integration
   - 1.1-INT-007: WebSocket authentication
   - 1.1-INT-008: JWT validation

3. **P0 E2E tests** (critical user journeys)
   - 1.1-E2E-001: Portfolio update frequency
   - 1.1-E2E-005: Multi-user isolation

4. **P1 tests** (core functionality)
   - All remaining P1 scenarios in order

5. **P2 tests** (as time permits)
   - Performance and edge case validation

## Quality Checklist

- [x] Every AC has test coverage
- [x] Test levels are appropriate (not over-testing)
- [x] No duplicate coverage across levels
- [x] Priorities align with business risk
- [x] Test IDs follow naming convention
- [x] Scenarios are atomic and independent

## Test Environment Requirements

### Unit Tests
- No external dependencies
- Mock WebSocket clients
- Mock Oracle price feeds
- In-memory cache simulation

### Integration Tests
- Test database with sample data
- Mock WebSocket clients
- Redis test instance
- Oracle service mock

### E2E Tests
- Full environment with real services
- Multiple test user accounts
- Load testing capabilities
- Visual regression testing setup

## Performance Benchmarks

- **WebSocket message delivery:** <100ms
- **Concurrent connections:** 1000 users
- **Error rate:** <0.1% disconnections
- **Database query performance:** <50ms for portfolio calculation
- **Cache hit rate:** >95% for portfolio data
