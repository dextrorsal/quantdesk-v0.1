# Story 2.3 - Authentication and Smart Contract Fixes - Test Design

**Test Architect**: Quinn (Test Architect)  
**Date**: January 27, 2025  
**Story**: Authentication and Smart Contract Fixes  
**Test Design Version**: 1.0  

---

## ðŸŽ¯ **TEST DESIGN OVERVIEW**

### **Test Objectives**
- Validate JWT to RLS mapping fixes for proper user context resolution
- Ensure Pyth SDK dependency conflicts are resolved in smart contracts
- Verify manual Pyth deserialization works correctly for on-chain price validation
- Confirm deterministic order matching with idempotency key support
- Test cross-department integration between backend and smart contracts

### **Critical Integration Points**
- **Backend â†’ Database**: JWT `wallet_pubkey` â†’ `users.id` â†’ `auth.uid()` mapping
- **Backend â†’ Smart Contracts**: User context propagation for on-chain operations
- **Smart Contracts â†’ Oracle**: Manual Pyth deserialization for price validation
- **Order Matching**: Deterministic behavior with idempotency protection

---

## ðŸ§ª **TEST SUITE ARCHITECTURE**

### **Test Categories**
1. **Unit Tests** - Individual component validation
2. **Integration Tests** - Cross-component functionality
3. **Security Tests** - Authentication and RLS validation
4. **Smart Contract Tests** - On-chain functionality validation
5. **End-to-End Tests** - Complete authentication and trading workflow

---

## ðŸ“‹ **DETAILED TEST SPECIFICATIONS**

### **1. UNIT TESTS**

#### **1.1 Authentication Middleware Tests**
**File**: `backend/tests/unit/auth-middleware.test.ts`

```typescript
describe('Authentication Middleware', () => {
  describe('JWT to RLS mapping', () => {
    it('should resolve wallet_pubkey to users.id correctly', async () => {
      // Test: JWT with wallet_pubkey claim
      // Expected: Proper user.id resolution
      // Validation: req.user.id and req.user.wallet_pubkey set correctly
    });

    it('should handle invalid JWT tokens gracefully', async () => {
      // Test: Malformed or expired JWT tokens
      // Expected: Proper error handling and 401 response
      // Security: No user context leakage
    });

    it('should validate JWT signature and expiration', async () => {
      // Test: JWT signature validation and exp claim
      // Expected: Valid tokens accepted, invalid tokens rejected
      // Security: Proper JWT validation
    });
  });

  describe('user context propagation', () => {
    it('should set req.user.id from database lookup', async () => {
      // Test: Database user lookup by wallet_pubkey
      // Expected: req.user.id populated correctly
      // Performance: <100ms resolution time
    });

    it('should handle non-existent users gracefully', async () => {
      // Test: JWT with wallet_pubkey not in database
      // Expected: Proper error handling, no crashes
      // Security: No information leakage
    });
  });
});
```

#### **1.2 Manual Pyth Deserialization Tests**
**File**: `contracts/tests/unit/pyth-deserialization.test.ts`

```typescript
describe('Manual Pyth Deserialization', () => {
  describe('price feed parsing', () => {
    it('should parse Pyth price feed account correctly', async () => {
      // Test: Real devnet Pyth price feed account
      // Expected: Correct price, confidence, timestamp extraction
      // Validation: Price data matches expected values
    });

    it('should handle malformed price feed data', async () => {
      // Test: Corrupted or invalid price feed data
      // Expected: Proper error handling with custom error codes
      // Security: No crashes or undefined behavior
    });

    it('should validate price staleness correctly', async () => {
      // Test: Various staleness scenarios
      // Expected: Correct staleness detection
      // Security: Prevent stale price usage
    });
  });

  describe('confidence interval validation', () => {
    it('should validate confidence intervals', async () => {
      // Test: Price feeds with various confidence levels
      // Expected: Confidence validation working correctly
      // Security: Reject prices with insufficient confidence
    });
  });
});
```

#### **1.3 Order Matching Tests**
**File**: `backend/tests/unit/order-matching.test.ts`

```typescript
describe('Deterministic Order Matching', () => {
  describe('price-time priority', () => {
    it('should match orders by price then time priority', async () => {
      // Test: Multiple orders with same price
      // Expected: Orders matched by timestamp priority
      // Validation: Deterministic matching order
    });

    it('should handle market orders correctly', async () => {
      // Test: Market orders vs limit orders
      // Expected: Market orders matched immediately
      // Performance: <50ms matching time
    });
  });

  describe('idempotency key support', () => {
    it('should prevent duplicate order processing', async () => {
      // Test: Same idempotency key submitted twice
      // Expected: Second submission ignored
      // Security: No duplicate fills
    });

    it('should handle idempotency key collisions', async () => {
      // Test: Different users with same idempotency key
      // Expected: Keys scoped by user_id
      // Security: User isolation maintained
    });
  });
});
```

### **2. INTEGRATION TESTS**

#### **2.1 Authentication Flow Integration**
**File**: `backend/tests/integration/auth-flow.test.ts`

```typescript
describe('Authentication Flow Integration', () => {
  describe('JWT to RLS mapping integration', () => {
    it('should propagate user context through all services', async () => {
      // Test: Complete authentication flow
      // Expected: User context available in all database operations
      // Validation: All queries include proper user_id
    });

    it('should enforce RLS policies correctly', async () => {
      // Test: Cross-user data access attempts
      // Expected: RLS policies prevent unauthorized access
      // Security: User data isolation maintained
    });
  });

  describe('database operation integration', () => {
    it('should include user_id in all database writes', async () => {
      // Test: Order placement, position updates
      // Expected: All writes include proper user_id
      // Validation: No NULL user_id inserts
    });

    it('should handle user context in error scenarios', async () => {
      // Test: Database errors with user context
      // Expected: Proper error handling with user context
      // Reliability: No context loss during errors
    });
  });
});
```

#### **2.2 Smart Contract Integration**
**File**: `contracts/tests/integration/smart-contract-auth.test.ts`

```typescript
describe('Smart Contract Authentication Integration', () => {
  describe('user context propagation', () => {
    it('should receive user context from backend', async () => {
      // Test: Backend â†’ Smart contract user context
      // Expected: Smart contract receives proper user identification
      // Validation: User context maintained on-chain
    });

    it('should validate user permissions on-chain', async () => {
      // Test: User attempting unauthorized operations
      // Expected: Smart contract rejects unauthorized operations
      // Security: On-chain permission validation
    });
  });

  describe('Pyth oracle integration', () => {
    it('should validate prices using manual deserialization', async () => {
      // Test: Smart contract price validation
      // Expected: Manual Pyth deserialization working correctly
      // Validation: Price data accurate and fresh
    });

    it('should handle oracle failures gracefully', async () => {
      // Test: Pyth oracle unavailable
      // Expected: Proper error handling, no crashes
      // Reliability: Graceful degradation
    });
  });
});
```

### **3. SECURITY TESTS**

#### **3.1 Authentication Security Tests**
**File**: `backend/tests/security/auth-security.test.ts`

```typescript
describe('Authentication Security', () => {
  describe('JWT security validation', () => {
    it('should prevent JWT token forgery', async () => {
      // Test: Attempts to forge JWT tokens
      // Expected: Forged tokens rejected
      // Security: Proper signature validation
    });

    it('should handle JWT replay attacks', async () => {
      // Test: Reusing expired JWT tokens
      // Expected: Expired tokens rejected
      // Security: Proper expiration validation
    });
  });

  describe('RLS policy enforcement', () => {
    it('should prevent cross-user data access', async () => {
      // Test: User attempting to access other user's data
      // Expected: RLS policies prevent access
      // Security: User data isolation enforced
    });

    it('should validate auth.uid() mapping', async () => {
      // Test: RLS policy using auth.uid()
      // Expected: Correct user identification
      // Security: Proper user context resolution
    });
  });
});
```

#### **3.2 Smart Contract Security Tests**
**File**: `contracts/tests/security/smart-contract-security.test.ts`

```typescript
describe('Smart Contract Security', () => {
  describe('price manipulation protection', () => {
    it('should prevent stale price usage', async () => {
      // Test: Attempts to use stale Pyth prices
      // Expected: Stale prices rejected
      // Security: Price staleness validation
    });

    it('should validate price confidence intervals', async () => {
      // Test: Prices with insufficient confidence
      // Expected: Low confidence prices rejected
      // Security: Confidence threshold validation
    });
  });

  describe('idempotency security', () => {
    it('should prevent duplicate order execution', async () => {
      // Test: Same idempotency key used multiple times
      // Expected: Duplicate executions prevented
      // Security: Idempotency protection
    });
  });
});
```

### **4. SMART CONTRACT TESTS**

#### **4.1 Pyth Integration Tests**
**File**: `contracts/tests/smart-contract/pyth-integration.test.ts`

```typescript
describe('Pyth Integration', () => {
  describe('real devnet price feeds', () => {
    it('should read real Pyth price feeds', async () => {
      // Test: Reading actual devnet Pyth feeds
      // Expected: Correct price data extraction
      // Validation: Price matches expected values
    });

    it('should handle Pyth feed updates', async () => {
      // Test: Price feed updates over time
      // Expected: Fresh prices detected correctly
      // Performance: Update detection <100ms
    });
  });

  describe('price validation logic', () => {
    it('should validate price ranges', async () => {
      // Test: Prices outside reasonable ranges
      // Expected: Invalid prices rejected
      // Security: Price range validation
    });

    it('should handle price feed errors', async () => {
      // Test: Pyth feed returns error states
      // Expected: Proper error handling
      // Reliability: Graceful error handling
    });
  });
});
```

#### **4.2 Order Execution Tests**
**File**: `contracts/tests/smart-contract/order-execution.test.ts`

```typescript
describe('Order Execution', () => {
  describe('deterministic matching', () => {
    it('should execute orders deterministically', async () => {
      // Test: Multiple orders with same parameters
      // Expected: Consistent execution order
      // Validation: Deterministic behavior
    });

    it('should handle partial fills correctly', async () => {
      // Test: Orders with partial fills
      // Expected: Correct partial fill handling
      // Validation: Fill amounts accurate
    });
  });

  describe('idempotency on-chain', () => {
    it('should prevent duplicate on-chain execution', async () => {
      // Test: Same idempotency key on-chain
      // Expected: Duplicate execution prevented
      // Security: On-chain idempotency protection
    });
  });
});
```

### **5. END-TO-END TESTS**

#### **5.1 Complete Authentication Workflow**
**File**: `backend/tests/e2e/complete-auth-workflow.test.ts`

```typescript
describe('Complete Authentication Workflow', () => {
  describe('user registration to trading', () => {
    it('should handle complete user journey', async () => {
      // Test: User registration â†’ authentication â†’ trading
      // Expected: Complete workflow with proper user context
      // Performance: <500ms total workflow time
    });

    it('should maintain user context throughout session', async () => {
      // Test: Multiple operations in same session
      // Expected: User context maintained consistently
      // Validation: No context loss
    });
  });

  describe('cross-department integration', () => {
    it('should integrate backend and smart contracts', async () => {
      // Test: Backend â†’ Smart contract â†’ Oracle workflow
      // Expected: Complete integration working
      // Performance: <1,200 CU per operation
    });
  });
});
```

#### **5.2 Epic 1 Test Script Validation**
**File**: `backend/tests/e2e/epic1-validation.test.ts`

```typescript
describe('Epic 1 Test Script Validation', () => {
  describe('regression testing', () => {
    it('should pass Epic 1 test script with new authentication', async () => {
      // Test: Run Epic 1 test script
      // Expected: All tests pass with new authentication
      // Validation: No regressions introduced
    });

    it('should maintain performance with new authentication', async () => {
      // Test: Performance comparison with Epic 1
      // Expected: No performance degradation
      // Performance: <100ms authentication resolution
    });
  });
});
```

---

## ðŸ“Š **TEST EXECUTION STRATEGY**

### **Test Execution Order**
1. **Unit Tests** - Individual component validation
2. **Integration Tests** - Cross-component functionality
3. **Security Tests** - Authentication and RLS validation
4. **Smart Contract Tests** - On-chain functionality
5. **End-to-End Tests** - Complete workflow validation

### **Performance Validation Criteria**
- **Authentication Resolution**: <100ms JWT to user ID resolution
- **Database Operations**: All operations include proper user_id
- **Smart Contract CU**: <1,200 CU per operation
- **Order Matching**: <50ms deterministic matching
- **Cross-Department Integration**: <500ms total workflow

### **Security Validation Criteria**
- **JWT Security**: Proper signature and expiration validation
- **RLS Enforcement**: User data isolation maintained
- **Price Validation**: Stale price prevention
- **Idempotency**: Duplicate execution prevention

---

## ðŸŽ¯ **TEST IMPLEMENTATION PRIORITIES**

### **P0 (Critical) - Must Implement**
1. JWT to RLS mapping unit tests
2. Manual Pyth deserialization tests
3. Authentication flow integration tests
4. RLS policy enforcement tests

### **P1 (High) - Should Implement**
1. Order matching tests
2. Smart contract integration tests
3. Security tests
4. Epic 1 validation tests

### **P2 (Medium) - Nice to Have**
1. Performance benchmarking tests
2. Stress testing
3. Advanced security tests
4. Comprehensive monitoring tests

---

## ðŸ“‹ **TEST DATA REQUIREMENTS**

### **Authentication Test Data**
- **Valid JWT Tokens**: With proper wallet_pubkey claims
- **Invalid JWT Tokens**: Expired, malformed, forged tokens
- **User Database Records**: Test users with wallet_pubkey mappings
- **RLS Test Data**: Cross-user data access scenarios

### **Smart Contract Test Data**
- **Pyth Price Feeds**: Real devnet feeds for testing
- **Order Test Data**: Various order types and scenarios
- **Idempotency Keys**: Test keys for duplicate prevention
- **Error Scenarios**: Oracle failures, invalid data

---

## ðŸš€ **IMPLEMENTATION RECOMMENDATIONS**

### **Immediate Actions**
1. **Implement JWT to RLS mapping fixes** in auth middleware
2. **Resolve Pyth SDK dependency conflicts** in smart contracts
3. **Add manual Pyth deserialization** for price validation
4. **Implement deterministic order matching** with idempotency

### **Testing Infrastructure**
1. **Set up authentication test framework**
2. **Create Pyth oracle test data**
3. **Implement Epic 1 test script validation**
4. **Set up cross-department integration testing**

---

*This test design provides comprehensive coverage for Story 2.3 Authentication and Smart Contract Fixes, ensuring all authentication, smart contract, and integration requirements are validated.*
