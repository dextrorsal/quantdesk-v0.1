<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live-Market-Data - QuantDesk Documentation</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <style>
        body {
            font-family: 'JetBrains Mono', 'Monaco', 'Consolas', monospace;
            line-height: 1.6;
            color: #ffffff;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #000000;
            font-size: 14px;
        }
        .container {
            background: #000000;
            padding: 30px;
            border-radius: 8px;
            border: 1px solid #333333;
        }
        .back-link {
            margin-bottom: 20px;
        }
        .back-link a {
            color: #3b82f6;
            text-decoration: none;
            font-weight: bold;
            transition: color 0.3s ease;
        }
        .back-link a:hover {
            color: #60a5fa;
            text-decoration: underline;
        }
        h1, h2, h3, h4, h5, h6 {
            color: #ffffff;
            margin-top: 30px;
            margin-bottom: 15px;
            font-weight: 600;
        }
        h1 {
            border-bottom: 2px solid #333333;
            padding-bottom: 10px;
        }
        h2 {
            border-bottom: 1px solid #333333;
            padding-bottom: 8px;
        }
        code {
            background: #1a1a1a;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'JetBrains Mono', 'Monaco', 'Consolas', monospace;
            color: #ffffff;
            border: 1px solid #333333;
        }
        pre {
            background: #0a0a0a;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            border: 1px solid #333333;
            margin: 20px 0;
        }
        pre code {
            background: none;
            padding: 0;
            color: #ffffff;
            border: none;
        }
        blockquote {
            border-left: 4px solid #3b82f6;
            margin: 0;
            padding-left: 20px;
            color: #d9d9d9;
            background: #1a1a1a;
            padding: 15px 20px;
            border-radius: 0 8px 8px 0;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
            border: 1px solid #333333;
        }
        th, td {
            border: 1px solid #333333;
            padding: 12px;
            text-align: left;
        }
        th {
            background: #1a1a1a;
            font-weight: bold;
            color: #ffffff;
        }
        td {
            color: #d9d9d9;
        }
        ul, ol {
            color: #d9d9d9;
        }
        li {
            margin-bottom: 8px;
        }
        a {
            color: #3b82f6;
            text-decoration: none;
        }
        a:hover {
            color: #60a5fa;
            text-decoration: underline;
        }
        /* Syntax Highlighting Overrides */
        pre[class*="language-"] {
            background: #0a0a0a !important;
            border: 1px solid #333333 !important;
            border-radius: 8px !important;
            padding: 20px !important;
            margin: 20px 0 !important;
            font-family: 'JetBrains Mono', 'Monaco', 'Consolas', monospace !important;
            font-size: 13px !important;
            line-height: 1.5 !important;
        }
        .token.comment { color: #6a9955 !important; }
        .token.keyword { color: #569cd6 !important; }
        .token.string { color: #ce9178 !important; }
        .token.number { color: #b5cea8 !important; }
        .token.function { color: #dcdcaa !important; }
        .token.class-name { color: #4ec9b0 !important; }
        .token.operator { color: #d4d4d4 !important; }
        .token.punctuation { color: #d4d4d4 !important; }
        .token.variable { color: #9cdcfe !important; }
        .token.constant { color: #4fc1ff !important; }
    </style>
</head>
<body>
    <div class="container">
        <div class="back-link">
            <a href="/">&larr; Back to Documentation</a>
        </div>
        <h1>Live Market Data Delivery</h1>
<p>QuantDesk’s trading terminal relies on fast, predictable market data. This page summarizes how the platform serves price, order book, and trade information to the UI and partner integrations.</p>
<h2>REST Endpoints</h2>
<ul>
<li><code>GET /api/markets</code> – List of active markets with latest oracle price and metadata.</li>
<li><code>GET /api/markets/:symbol/price</code> – Latest mark price payload <code>{ price, confidence, slot, ts }</code>.</li>
<li><code>GET /api/markets/:symbol/orderbook</code> – Top-of-book bids/asks (default 20 levels per side) plus spread and timestamp.</li>
</ul>
<p>Symbols are normalized server-side to canonical <code>BASE-PERP</code> format (e.g., <code>SOL-PERP</code>). Aliases such as <code>SOL</code>, <code>SOL/USDT</code>, or <code>SOLUSDT</code> are accepted and mapped internally. Responses include both <code>symbol</code> and <code>marketId</code> so frontends can join data reliably.</p>
<h2>WebSocket Envelope</h2>
<p>Real-time updates mirror the REST shapes using a versioned envelope:</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;v&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;price | orderbook | trades&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;symbol&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;SOL-PERP&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;ts&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1730930000000</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;data&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* same structure as the REST endpoint */</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<ul>
<li>Price messages carry <code>{ price, confidence, slot }</code> and volatility flags.</li>
<li>Order book messages contain arrays of <code>[price, size]</code> pairs.</li>
<li>Cadence targets ~1 second; payload compression (gzip/deflate) is available if throughput increases.</li>
</ul>
<p>Clients subscribe via the WebSocket layer first, then fall back to REST polling (2–5 seconds with jitter) if the stream disconnects. UI badges call out staleness when snapshots are older than ~3 seconds.</p>
<h2>Caching &amp; Fallbacks</h2>
<ul>
<li>Redis caches fresh snapshots under <code>qd:{ENV}:price:{SYMBOL}</code> and <code>qd:{ENV}:orderbook:{SYMBOL}</code> with 1–3 second TTLs.</li>
<li>Pub/Sub channels (<code>qd:{ENV}:price</code>, <code>qd:{ENV}:orderbook</code>) fan out updates to the WebSocket broadcaster.</li>
<li>A stale-while-revalidate approach lets the terminal display the last good value immediately while it re-fetches in the background.</li>
</ul>
<h2>Frontend Consumption Pattern</h2>
<ul>
<li><strong>PriceContext</strong> – Attempts WebSocket first, then falls back to REST polling, exposing <code>price</code>, <code>confidence</code>, and <code>lastUpdated</code> to UI components.</li>
<li><strong>DepthService</strong> – Polls REST with jitter until the WebSocket stabilizes, then switches to real-time updates; flags stale depth so heatmaps dim gracefully.</li>
<li><strong>Volatility Handling</strong> – If <code>confidence / price &gt; 1%</code> or price deviates sharply from a local EMA, the UI widens spreads and labels the market “high volatility.”</li>
</ul>
<h2>Security &amp; Limits</h2>
<ul>
<li>Public endpoints enforce rate limiting and CORS rules; unknown symbols are rejected.</li>
<li>Authenticated trading endpoints still require wallet-verified sessions (Sign-In with Solana) even if a client knows the REST/WS URLs.</li>
<li>Monitoring tracks endpoint latency, Redis hit ratios, WebSocket reconnects, and data freshness. Alerts fire if price snapshots are stale (&gt;5s) or if the WS broadcaster loops.</li>
</ul>
<p>These practices keep the terminal responsive under normal loads while giving enterprise users clear expectations for integration. For upstream ingestion pipelines, see the <a href="../ai-engine/market-intelligence-pipeline.md">Market Intelligence Pipeline</a>.</p>
    </div>
</body>
</html>