<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Contract Integration Guide - QuantDesk Documentation</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <style>
        body {
            font-family: 'JetBrains Mono', 'Monaco', 'Consolas', monospace;
            line-height: 1.6;
            color: #ffffff;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #000000;
            font-size: 14px;
        }
        .container {
            background: #000000;
            padding: 30px;
            border-radius: 8px;
            border: 1px solid #333333;
        }
        .back-link {
            margin-bottom: 20px;
        }
        .back-link a {
            color: #3b82f6;
            text-decoration: none;
            font-weight: bold;
            transition: color 0.3s ease;
        }
        .back-link a:hover {
            color: #60a5fa;
            text-decoration: underline;
        }
        h1, h2, h3, h4, h5, h6 {
            color: #ffffff;
            margin-top: 30px;
            margin-bottom: 15px;
            font-weight: 600;
        }
        h1 {
            border-bottom: 2px solid #333333;
            padding-bottom: 10px;
        }
        h2 {
            border-bottom: 1px solid #333333;
            padding-bottom: 8px;
        }
        code {
            background: #1a1a1a;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'JetBrains Mono', 'Monaco', 'Consolas', monospace;
            color: #ffffff;
            border: 1px solid #333333;
        }
        pre {
            background: #0a0a0a;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            border: 1px solid #333333;
            margin: 20px 0;
        }
        pre code {
            background: none;
            padding: 0;
            color: #ffffff;
            border: none;
        }
        blockquote {
            border-left: 4px solid #3b82f6;
            margin: 0;
            padding-left: 20px;
            color: #d9d9d9;
            background: #1a1a1a;
            padding: 15px 20px;
            border-radius: 0 8px 8px 0;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
            border: 1px solid #333333;
        }
        th, td {
            border: 1px solid #333333;
            padding: 12px;
            text-align: left;
        }
        th {
            background: #1a1a1a;
            font-weight: bold;
            color: #ffffff;
        }
        td {
            color: #d9d9d9;
        }
        ul, ol {
            color: #d9d9d9;
        }
        li {
            margin-bottom: 8px;
        }
        a {
            color: #3b82f6;
            text-decoration: none;
        }
        a:hover {
            color: #60a5fa;
            text-decoration: underline;
        }
        /* Syntax Highlighting Overrides */
        pre[class*="language-"] {
            background: #0a0a0a !important;
            border: 1px solid #333333 !important;
            border-radius: 8px !important;
            padding: 20px !important;
            margin: 20px 0 !important;
            font-family: 'JetBrains Mono', 'Monaco', 'Consolas', monospace !important;
            font-size: 13px !important;
            line-height: 1.5 !important;
        }
        .token.comment { color: #6a9955 !important; }
        .token.keyword { color: #569cd6 !important; }
        .token.string { color: #ce9178 !important; }
        .token.number { color: #b5cea8 !important; }
        .token.function { color: #dcdcaa !important; }
        .token.class-name { color: #4ec9b0 !important; }
        .token.operator { color: #d4d4d4 !important; }
        .token.punctuation { color: #d4d4d4 !important; }
        .token.variable { color: #9cdcfe !important; }
        .token.constant { color: #4fc1ff !important; }
    </style>
</head>
<body>
    <div class="container">
        <div class="back-link">
            <a href="/docs">&larr; Back to Documentation</a>
        </div>
        <h1>Smart Contract Integration Guide</h1>
<h2>Overview</h2>
<p>This guide explains how to integrate the QuantDesk Solana smart contracts with the frontend to create the complete account lifecycle experience similar to Drift Protocol.</p>
<h2>Smart Contract Architecture</h2>
<h3>Core Programs</h3>
<ol>
<li><strong>User Account Program</strong>: Manages user account creation and state</li>
<li><strong>Market Program</strong>: Handles trading, positions, and orders</li>
<li><strong>Collateral Program</strong>: Manages deposits and withdrawals</li>
<li><strong>Oracle Program</strong>: Provides price feeds</li>
</ol>
<h3>PDA Structure</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// User Account PDA</span>
<span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">user_account_pda</span><span class="p">,</span><span class="w"> </span><span class="n">bump</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Pubkey</span>::<span class="n">find_program_address</span><span class="p">(</span>
<span class="w">    </span><span class="o">&amp;</span><span class="p">[</span><span class="s">b&quot;user_account&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">user_wallet</span><span class="p">.</span><span class="n">as_ref</span><span class="p">(),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">account_index</span><span class="p">.</span><span class="n">to_le_bytes</span><span class="p">()],</span>
<span class="w">    </span><span class="n">program_id</span><span class="p">,</span>
<span class="p">);</span>

<span class="c1">// Market PDA</span>
<span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">market_pda</span><span class="p">,</span><span class="w"> </span><span class="n">bump</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Pubkey</span>::<span class="n">find_program_address</span><span class="p">(</span>
<span class="w">    </span><span class="o">&amp;</span><span class="p">[</span><span class="s">b&quot;market&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">base_asset</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">(),</span><span class="w"> </span><span class="n">quote_asset</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">()],</span>
<span class="w">    </span><span class="n">program_id</span><span class="p">,</span>
<span class="p">);</span>

<span class="c1">// Position PDA</span>
<span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">position_pda</span><span class="p">,</span><span class="w"> </span><span class="n">bump</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Pubkey</span>::<span class="n">find_program_address</span><span class="p">(</span>
<span class="w">    </span><span class="o">&amp;</span><span class="p">[</span><span class="s">b&quot;position&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">user_wallet</span><span class="p">.</span><span class="n">as_ref</span><span class="p">(),</span><span class="w"> </span><span class="n">market</span><span class="p">.</span><span class="n">as_ref</span><span class="p">()],</span>
<span class="w">    </span><span class="n">program_id</span><span class="p">,</span>
<span class="p">);</span>

<span class="c1">// Collateral Account PDA</span>
<span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">collateral_pda</span><span class="p">,</span><span class="w"> </span><span class="n">bump</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Pubkey</span>::<span class="n">find_program_address</span><span class="p">(</span>
<span class="w">    </span><span class="o">&amp;</span><span class="p">[</span><span class="s">b&quot;collateral&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">user_wallet</span><span class="p">.</span><span class="n">as_ref</span><span class="p">(),</span><span class="w"> </span><span class="n">asset_mint</span><span class="p">.</span><span class="n">as_ref</span><span class="p">()],</span>
<span class="w">    </span><span class="n">program_id</span><span class="p">,</span>
<span class="p">);</span>
</code></pre></div>

<h2>Account Lifecycle Implementation</h2>
<h3>1. Wallet Connection State</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// Check if user has QuantDesk account</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">checkUserAccount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">walletAddress</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="kt">boolean</span><span class="o">&gt;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">userAccountPda</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">PublicKey</span><span class="p">.</span><span class="nx">findProgramAddress</span><span class="p">(</span>
<span class="w">      </span><span class="p">[</span><span class="nx">Buffer</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="s2">&quot;user_account&quot;</span><span class="p">),</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">PublicKey</span><span class="p">(</span><span class="nx">walletAddress</span><span class="p">).</span><span class="nx">toBuffer</span><span class="p">(),</span><span class="w"> </span><span class="nx">Buffer</span><span class="p">.</span><span class="kr">from</span><span class="p">([</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">])],</span><span class="w"> </span><span class="c1">// account_index = 0</span>
<span class="w">      </span><span class="nx">programId</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">accountInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">connection</span><span class="p">.</span><span class="nx">getAccountInfo</span><span class="p">(</span><span class="nx">userAccountPda</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">accountInfo</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Error checking user account:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h3>2. Account Creation Flow</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// Create user account</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">createUserAccount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">wallet</span><span class="o">:</span><span class="w"> </span><span class="kt">Wallet</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">userAccountPda</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">PublicKey</span><span class="p">.</span><span class="nx">findProgramAddress</span><span class="p">(</span>
<span class="w">    </span><span class="p">[</span><span class="nx">Buffer</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="s2">&quot;user_account&quot;</span><span class="p">),</span><span class="w"> </span><span class="nx">wallet</span><span class="p">.</span><span class="nx">publicKey</span><span class="p">.</span><span class="nx">toBuffer</span><span class="p">(),</span><span class="w"> </span><span class="nx">Buffer</span><span class="p">.</span><span class="kr">from</span><span class="p">([</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">])],</span>
<span class="w">    </span><span class="nx">programId</span>
<span class="w">  </span><span class="p">);</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">transaction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Transaction</span><span class="p">().</span><span class="nx">add</span><span class="p">(</span>
<span class="w">    </span><span class="ow">new</span><span class="w"> </span><span class="nx">TransactionInstruction</span><span class="p">({</span>
<span class="w">      </span><span class="nx">keys</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">pubkey</span><span class="o">:</span><span class="w"> </span><span class="kt">wallet.publicKey</span><span class="p">,</span><span class="w"> </span><span class="nx">isSigner</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span><span class="w"> </span><span class="nx">isWritable</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">pubkey</span><span class="o">:</span><span class="w"> </span><span class="kt">userAccountPda</span><span class="p">,</span><span class="w"> </span><span class="nx">isSigner</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span><span class="w"> </span><span class="nx">isWritable</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">pubkey</span><span class="o">:</span><span class="w"> </span><span class="kt">SystemProgram.programId</span><span class="p">,</span><span class="w"> </span><span class="nx">isSigner</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span><span class="w"> </span><span class="nx">isWritable</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">],</span>
<span class="w">      </span><span class="nx">programId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="kt">Buffer.from</span><span class="p">([</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">]),</span><span class="w"> </span><span class="c1">// create_user_account instruction with account_index = 0</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">);</span>

<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">wallet</span><span class="p">.</span><span class="nx">sendTransaction</span><span class="p">(</span><span class="nx">transaction</span><span class="p">,</span><span class="w"> </span><span class="nx">connection</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div>

<h3>3. Account State Management</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// Get user account state</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">getUserAccountState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">walletAddress</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">UserAccountState</span><span class="o">&gt;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">userAccountPda</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">PublicKey</span><span class="p">.</span><span class="nx">findProgramAddress</span><span class="p">(</span>
<span class="w">    </span><span class="p">[</span><span class="nx">Buffer</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="s2">&quot;user_account&quot;</span><span class="p">),</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">PublicKey</span><span class="p">(</span><span class="nx">walletAddress</span><span class="p">).</span><span class="nx">toBuffer</span><span class="p">(),</span><span class="w"> </span><span class="nx">Buffer</span><span class="p">.</span><span class="kr">from</span><span class="p">([</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">])],</span>
<span class="w">    </span><span class="nx">programId</span>
<span class="w">  </span><span class="p">);</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">accountInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">connection</span><span class="p">.</span><span class="nx">getAccountInfo</span><span class="p">(</span><span class="nx">userAccountPda</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">accountInfo</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">exists</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span>
<span class="w">      </span><span class="nx">canDeposit</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span>
<span class="w">      </span><span class="nx">canTrade</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span>
<span class="w">      </span><span class="nx">totalCollateral</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span>
<span class="w">      </span><span class="nx">accountHealth</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Decode account data</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">userAccount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">UserAccount</span><span class="p">.</span><span class="nx">decode</span><span class="p">(</span><span class="nx">accountInfo</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">exists</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span>
<span class="w">    </span><span class="nx">canDeposit</span><span class="o">:</span><span class="w"> </span><span class="kt">userAccount.is_active</span><span class="p">,</span>
<span class="w">    </span><span class="nx">canTrade</span><span class="o">:</span><span class="w"> </span><span class="kt">userAccount.can_trade</span><span class="p">(),</span>
<span class="w">    </span><span class="nx">totalCollateral</span><span class="o">:</span><span class="w"> </span><span class="kt">userAccount.total_collateral</span><span class="p">,</span>
<span class="w">    </span><span class="nx">accountHealth</span><span class="o">:</span><span class="w"> </span><span class="kt">userAccount.account_health</span><span class="p">,</span>
<span class="w">    </span><span class="nx">liquidationPrice</span><span class="o">:</span><span class="w"> </span><span class="kt">userAccount.liquidation_price</span><span class="p">,</span>
<span class="w">  </span><span class="p">};</span>
<span class="p">};</span>
</code></pre></div>

<h3>4. Deposit Flow</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// Initialize collateral account</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">initializeCollateralAccount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="nx">wallet</span><span class="o">:</span><span class="w"> </span><span class="kt">Wallet</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="nx">assetType</span><span class="o">:</span><span class="w"> </span><span class="kt">CollateralType</span>
<span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">collateralPda</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">PublicKey</span><span class="p">.</span><span class="nx">findProgramAddress</span><span class="p">(</span>
<span class="w">    </span><span class="p">[</span><span class="nx">Buffer</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="s2">&quot;collateral&quot;</span><span class="p">),</span><span class="w"> </span><span class="nx">wallet</span><span class="p">.</span><span class="nx">publicKey</span><span class="p">.</span><span class="nx">toBuffer</span><span class="p">(),</span><span class="w"> </span><span class="nx">Buffer</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="nx">assetType</span><span class="p">.</span><span class="nx">toString</span><span class="p">())],</span>
<span class="w">    </span><span class="nx">programId</span>
<span class="w">  </span><span class="p">);</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">transaction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Transaction</span><span class="p">().</span><span class="nx">add</span><span class="p">(</span>
<span class="w">    </span><span class="ow">new</span><span class="w"> </span><span class="nx">TransactionInstruction</span><span class="p">({</span>
<span class="w">      </span><span class="nx">keys</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">pubkey</span><span class="o">:</span><span class="w"> </span><span class="kt">wallet.publicKey</span><span class="p">,</span><span class="w"> </span><span class="nx">isSigner</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span><span class="w"> </span><span class="nx">isWritable</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">pubkey</span><span class="o">:</span><span class="w"> </span><span class="kt">collateralPda</span><span class="p">,</span><span class="w"> </span><span class="nx">isSigner</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span><span class="w"> </span><span class="nx">isWritable</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">pubkey</span><span class="o">:</span><span class="w"> </span><span class="kt">SystemProgram.programId</span><span class="p">,</span><span class="w"> </span><span class="nx">isSigner</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span><span class="w"> </span><span class="nx">isWritable</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">],</span>
<span class="w">      </span><span class="nx">programId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="kt">Buffer.from</span><span class="p">([</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="nx">assetType</span><span class="p">]),</span><span class="w"> </span><span class="c1">// initialize_collateral_account instruction</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">);</span>

<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">wallet</span><span class="p">.</span><span class="nx">sendTransaction</span><span class="p">(</span><span class="nx">transaction</span><span class="p">,</span><span class="w"> </span><span class="nx">connection</span><span class="p">);</span>
<span class="p">};</span>

<span class="c1">// Add collateral</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">addCollateral</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="nx">wallet</span><span class="o">:</span><span class="w"> </span><span class="kt">Wallet</span><span class="p">,</span>
<span class="w">  </span><span class="nx">assetType</span><span class="o">:</span><span class="w"> </span><span class="kt">CollateralType</span><span class="p">,</span>
<span class="w">  </span><span class="nx">amount</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span>
<span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">collateralPda</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">PublicKey</span><span class="p">.</span><span class="nx">findProgramAddress</span><span class="p">(</span>
<span class="w">    </span><span class="p">[</span><span class="nx">Buffer</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="s2">&quot;collateral&quot;</span><span class="p">),</span><span class="w"> </span><span class="nx">wallet</span><span class="p">.</span><span class="nx">publicKey</span><span class="p">.</span><span class="nx">toBuffer</span><span class="p">(),</span><span class="w"> </span><span class="nx">Buffer</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="nx">assetType</span><span class="p">.</span><span class="nx">toString</span><span class="p">())],</span>
<span class="w">    </span><span class="nx">programId</span>
<span class="w">  </span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Get user&#39;s token account</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">tokenMint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getTokenMint</span><span class="p">(</span><span class="nx">assetType</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">userTokenAccount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getAssociatedTokenAddress</span><span class="p">(</span><span class="nx">tokenMint</span><span class="p">,</span><span class="w"> </span><span class="nx">wallet</span><span class="p">.</span><span class="nx">publicKey</span><span class="p">);</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">transaction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Transaction</span><span class="p">().</span><span class="nx">add</span><span class="p">(</span>
<span class="w">    </span><span class="ow">new</span><span class="w"> </span><span class="nx">TransactionInstruction</span><span class="p">({</span>
<span class="w">      </span><span class="nx">keys</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">pubkey</span><span class="o">:</span><span class="w"> </span><span class="kt">wallet.publicKey</span><span class="p">,</span><span class="w"> </span><span class="nx">isSigner</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span><span class="w"> </span><span class="nx">isWritable</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">pubkey</span><span class="o">:</span><span class="w"> </span><span class="kt">collateralPda</span><span class="p">,</span><span class="w"> </span><span class="nx">isSigner</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span><span class="w"> </span><span class="nx">isWritable</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">pubkey</span><span class="o">:</span><span class="w"> </span><span class="kt">userTokenAccount</span><span class="p">,</span><span class="w"> </span><span class="nx">isSigner</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span><span class="w"> </span><span class="nx">isWritable</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">],</span>
<span class="w">      </span><span class="nx">programId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="kt">Buffer.from</span><span class="p">([</span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="p">...</span><span class="ow">new</span><span class="w"> </span><span class="nx">BN</span><span class="p">(</span><span class="nx">amount</span><span class="p">).</span><span class="nx">toArray</span><span class="p">(</span><span class="s1">&#39;le&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">8</span><span class="p">)]),</span><span class="w"> </span><span class="c1">// add_collateral instruction</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">);</span>

<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">wallet</span><span class="p">.</span><span class="nx">sendTransaction</span><span class="p">(</span><span class="nx">transaction</span><span class="p">,</span><span class="w"> </span><span class="nx">connection</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div>

<h3>5. Trading Flow</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// Place order</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">placeOrder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="nx">wallet</span><span class="o">:</span><span class="w"> </span><span class="kt">Wallet</span><span class="p">,</span>
<span class="w">  </span><span class="nx">market</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">  </span><span class="nx">orderType</span><span class="o">:</span><span class="w"> </span><span class="kt">OrderType</span><span class="p">,</span>
<span class="w">  </span><span class="nx">side</span><span class="o">:</span><span class="w"> </span><span class="kt">PositionSide</span><span class="p">,</span>
<span class="w">  </span><span class="nx">size</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">,</span>
<span class="w">  </span><span class="nx">price</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">,</span>
<span class="w">  </span><span class="nx">leverage</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span>
<span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">marketPda</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">PublicKey</span><span class="p">.</span><span class="nx">findProgramAddress</span><span class="p">(</span>
<span class="w">    </span><span class="p">[</span><span class="nx">Buffer</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="s2">&quot;market&quot;</span><span class="p">),</span><span class="w"> </span><span class="nx">Buffer</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="nx">market</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mf">0</span><span class="p">]),</span><span class="w"> </span><span class="nx">Buffer</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="nx">market</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mf">1</span><span class="p">])],</span>
<span class="w">    </span><span class="nx">programId</span>
<span class="w">  </span><span class="p">);</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">orderPda</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">PublicKey</span><span class="p">.</span><span class="nx">findProgramAddress</span><span class="p">(</span>
<span class="w">    </span><span class="p">[</span><span class="nx">Buffer</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="s2">&quot;order&quot;</span><span class="p">),</span><span class="w"> </span><span class="nx">wallet</span><span class="p">.</span><span class="nx">publicKey</span><span class="p">.</span><span class="nx">toBuffer</span><span class="p">(),</span><span class="w"> </span><span class="nx">marketPda</span><span class="p">.</span><span class="nx">toBuffer</span><span class="p">()],</span>
<span class="w">    </span><span class="nx">programId</span>
<span class="w">  </span><span class="p">);</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">transaction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Transaction</span><span class="p">().</span><span class="nx">add</span><span class="p">(</span>
<span class="w">    </span><span class="ow">new</span><span class="w"> </span><span class="nx">TransactionInstruction</span><span class="p">({</span>
<span class="w">      </span><span class="nx">keys</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">pubkey</span><span class="o">:</span><span class="w"> </span><span class="kt">wallet.publicKey</span><span class="p">,</span><span class="w"> </span><span class="nx">isSigner</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span><span class="w"> </span><span class="nx">isWritable</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">pubkey</span><span class="o">:</span><span class="w"> </span><span class="kt">marketPda</span><span class="p">,</span><span class="w"> </span><span class="nx">isSigner</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span><span class="w"> </span><span class="nx">isWritable</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">pubkey</span><span class="o">:</span><span class="w"> </span><span class="kt">orderPda</span><span class="p">,</span><span class="w"> </span><span class="nx">isSigner</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span><span class="w"> </span><span class="nx">isWritable</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">],</span>
<span class="w">      </span><span class="nx">programId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="kt">Buffer.from</span><span class="p">([</span>
<span class="w">        </span><span class="mf">4</span><span class="p">,</span><span class="w"> </span><span class="c1">// place_order instruction</span>
<span class="w">        </span><span class="nx">orderType</span><span class="p">,</span>
<span class="w">        </span><span class="nx">side</span><span class="p">,</span>
<span class="w">        </span><span class="p">...</span><span class="ow">new</span><span class="w"> </span><span class="nx">BN</span><span class="p">(</span><span class="nx">size</span><span class="p">).</span><span class="nx">toArray</span><span class="p">(</span><span class="s1">&#39;le&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">8</span><span class="p">),</span>
<span class="w">        </span><span class="p">...</span><span class="ow">new</span><span class="w"> </span><span class="nx">BN</span><span class="p">(</span><span class="nx">price</span><span class="p">).</span><span class="nx">toArray</span><span class="p">(</span><span class="s1">&#39;le&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">8</span><span class="p">),</span>
<span class="w">        </span><span class="nx">leverage</span><span class="p">,</span>
<span class="w">      </span><span class="p">]),</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">);</span>

<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">wallet</span><span class="p">.</span><span class="nx">sendTransaction</span><span class="p">(</span><span class="nx">transaction</span><span class="p">,</span><span class="w"> </span><span class="nx">connection</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div>

<h2>Frontend State Management</h2>
<h3>Account Context Provider</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// frontend/src/contexts/AccountContext.tsx</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">AccountProvider</span><span class="o">:</span><span class="w"> </span><span class="kt">React.FC</span><span class="o">&lt;</span><span class="p">{</span><span class="w"> </span><span class="nx">children</span><span class="o">:</span><span class="w"> </span><span class="kt">React.ReactNode</span><span class="w"> </span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">({</span><span class="w"> </span><span class="nx">children</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">accountState</span><span class="p">,</span><span class="w"> </span><span class="nx">setAccountState</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="o">&lt;</span><span class="nx">AccountState</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="o">&gt;</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">loading</span><span class="p">,</span><span class="w"> </span><span class="nx">setLoading</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">connected</span><span class="p">,</span><span class="w"> </span><span class="nx">publicKey</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useWallet</span><span class="p">();</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">fetchAccountState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useCallback</span><span class="p">(</span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">connected</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="nx">publicKey</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">setAccountState</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">setLoading</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getUserAccountState</span><span class="p">(</span><span class="nx">publicKey</span><span class="p">.</span><span class="nx">toString</span><span class="p">());</span>
<span class="w">      </span><span class="nx">setAccountState</span><span class="p">(</span><span class="nx">state</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Error fetching account state:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">setLoading</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="nx">connected</span><span class="p">,</span><span class="w"> </span><span class="nx">publicKey</span><span class="p">]);</span>

<span class="w">  </span><span class="nx">useEffect</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">fetchAccountState</span><span class="p">();</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="nx">fetchAccountState</span><span class="p">]);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="o">&lt;</span><span class="nx">AccountContext</span><span class="p">.</span><span class="nx">Provider</span><span class="w"> </span><span class="nx">value</span><span class="o">=</span><span class="p">{{</span>
<span class="w">      </span><span class="nx">accountState</span><span class="p">,</span>
<span class="w">      </span><span class="nx">loading</span><span class="p">,</span>
<span class="w">      </span><span class="nx">fetchAccountState</span><span class="p">,</span>
<span class="w">      </span><span class="nx">createAccount</span><span class="o">:</span><span class="w"> </span><span class="kt">createUserAccount</span><span class="p">,</span>
<span class="w">      </span><span class="nx">deposit</span><span class="o">:</span><span class="w"> </span><span class="kt">addCollateral</span><span class="p">,</span>
<span class="w">      </span><span class="nx">trade</span><span class="o">:</span><span class="w"> </span><span class="kt">placeOrder</span><span class="p">,</span>
<span class="w">    </span><span class="p">}}</span><span class="o">&gt;</span>
<span class="w">      </span><span class="p">{</span><span class="nx">children</span><span class="p">}</span>
<span class="w">    </span><span class="o">&lt;</span><span class="err">/AccountContext.Provider&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div>

<h3>State-Based UI Components</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// frontend/src/components/AccountStateManager.tsx</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">AccountStateManager</span><span class="o">:</span><span class="w"> </span><span class="kt">React.FC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">accountState</span><span class="p">,</span><span class="w"> </span><span class="nx">loading</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useAccount</span><span class="p">();</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">connected</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useWallet</span><span class="p">();</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">connected</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&lt;</span><span class="nx">WalletConnectionPrompt</span><span class="w"> </span><span class="o">/&gt;</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">loading</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&lt;</span><span class="nx">LoadingSpinner</span><span class="w"> </span><span class="o">/&gt;</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">accountState</span><span class="o">?</span><span class="p">.</span><span class="nx">exists</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&lt;</span><span class="nx">AccountCreationPrompt</span><span class="w"> </span><span class="o">/&gt;</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">accountState</span><span class="p">.</span><span class="nx">canTrade</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&lt;</span><span class="nx">DepositPrompt</span><span class="w"> </span><span class="o">/&gt;</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="o">&lt;</span><span class="nx">TradingInterface</span><span class="w"> </span><span class="o">/&gt;</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>

<h2>Backend Integration</h2>
<h3>Smart Contract Event Sync</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// backend/src/services/smartContractSync.ts</span>
<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">SmartContractSyncService</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">syncUserAccount</span><span class="p">(</span><span class="nx">userWalletAddress</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Get user account from blockchain</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">accountState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getUserAccountFromBlockchain</span><span class="p">(</span><span class="nx">userWalletAddress</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Update database</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">updateUserInDatabase</span><span class="p">(</span><span class="nx">userWalletAddress</span><span class="p">,</span><span class="w"> </span><span class="nx">accountState</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">syncPositions</span><span class="p">(</span><span class="nx">userWalletAddress</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Get positions from blockchain</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">positions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getPositionsFromBlockchain</span><span class="p">(</span><span class="nx">userWalletAddress</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Update database</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">updatePositionsInDatabase</span><span class="p">(</span><span class="nx">userWalletAddress</span><span class="p">,</span><span class="w"> </span><span class="nx">positions</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">syncOrders</span><span class="p">(</span><span class="nx">userWalletAddress</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Get orders from blockchain</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">orders</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getOrdersFromBlockchain</span><span class="p">(</span><span class="nx">userWalletAddress</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Update database</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">updateOrdersInDatabase</span><span class="p">(</span><span class="nx">userWalletAddress</span><span class="p">,</span><span class="w"> </span><span class="nx">orders</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3>API Endpoints</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// backend/src/routes/smartContract.ts</span>
<span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/account-state/:walletAddress&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">walletAddress</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">;</span>

<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Get from blockchain</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">blockchainState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">smartContractSync</span><span class="p">.</span><span class="nx">getUserAccountFromBlockchain</span><span class="p">(</span><span class="nx">walletAddress</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Get from database</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">databaseState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">accountStateService</span><span class="p">.</span><span class="nx">getUserAccountState</span><span class="p">(</span><span class="nx">walletAddress</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Merge states</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">mergedState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="p">...</span><span class="nx">databaseState</span><span class="p">,</span>
<span class="w">      </span><span class="nx">blockchain</span><span class="o">:</span><span class="w"> </span><span class="kt">blockchainState</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="o">:</span><span class="w"> </span><span class="kt">mergedState</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">error.message</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">});</span>
</code></pre></div>

<h2>Testing Strategy</h2>
<h3>Unit Tests</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// tests/smart-contract-integration.test.ts</span>
<span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;Smart Contract Integration&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">test</span><span class="p">(</span><span class="s1">&#39;should create user account&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">wallet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Wallet</span><span class="p">();</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">createUserAccount</span><span class="p">(</span><span class="nx">wallet</span><span class="p">);</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">accountExists</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">checkUserAccount</span><span class="p">(</span><span class="nx">wallet</span><span class="p">.</span><span class="nx">publicKey</span><span class="p">.</span><span class="nx">toString</span><span class="p">());</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">accountExists</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="nx">test</span><span class="p">(</span><span class="s1">&#39;should deposit collateral&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">wallet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Wallet</span><span class="p">();</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">createUserAccount</span><span class="p">(</span><span class="nx">wallet</span><span class="p">);</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">addCollateral</span><span class="p">(</span><span class="nx">wallet</span><span class="p">,</span><span class="w"> </span><span class="nx">CollateralType</span><span class="p">.</span><span class="nx">USDC</span><span class="p">,</span><span class="w"> </span><span class="mf">1000</span><span class="p">);</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getUserAccountState</span><span class="p">(</span><span class="nx">wallet</span><span class="p">.</span><span class="nx">publicKey</span><span class="p">.</span><span class="nx">toString</span><span class="p">());</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">totalCollateral</span><span class="p">).</span><span class="nx">toBeGreaterThan</span><span class="p">(</span><span class="mf">0</span><span class="p">);</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">});</span>
</code></pre></div>

<h3>Integration Tests</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// tests/account-lifecycle.test.ts</span>
<span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;Account Lifecycle&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">test</span><span class="p">(</span><span class="s1">&#39;complete user journey&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">wallet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Wallet</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// 1. Connect wallet</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="k">await</span><span class="w"> </span><span class="nx">checkUserAccount</span><span class="p">(</span><span class="nx">wallet</span><span class="p">.</span><span class="nx">publicKey</span><span class="p">.</span><span class="nx">toString</span><span class="p">())).</span><span class="nx">toBe</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 2. Create account</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">createUserAccount</span><span class="p">(</span><span class="nx">wallet</span><span class="p">);</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="k">await</span><span class="w"> </span><span class="nx">checkUserAccount</span><span class="p">(</span><span class="nx">wallet</span><span class="p">.</span><span class="nx">publicKey</span><span class="p">.</span><span class="nx">toString</span><span class="p">())).</span><span class="nx">toBe</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 3. Deposit funds</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">addCollateral</span><span class="p">(</span><span class="nx">wallet</span><span class="p">,</span><span class="w"> </span><span class="nx">CollateralType</span><span class="p">.</span><span class="nx">USDC</span><span class="p">,</span><span class="w"> </span><span class="mf">1000</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getUserAccountState</span><span class="p">(</span><span class="nx">wallet</span><span class="p">.</span><span class="nx">publicKey</span><span class="p">.</span><span class="nx">toString</span><span class="p">());</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">canTrade</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 4. Place order</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">placeOrder</span><span class="p">(</span><span class="nx">wallet</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;BTC/USDT&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">OrderType</span><span class="p">.</span><span class="nx">Market</span><span class="p">,</span><span class="w"> </span><span class="nx">PositionSide</span><span class="p">.</span><span class="nx">Long</span><span class="p">,</span><span class="w"> </span><span class="mf">100</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 5. Check position</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">positions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getPositions</span><span class="p">(</span><span class="nx">wallet</span><span class="p">.</span><span class="nx">publicKey</span><span class="p">.</span><span class="nx">toString</span><span class="p">());</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">positions</span><span class="p">.</span><span class="nx">length</span><span class="p">).</span><span class="nx">toBeGreaterThan</span><span class="p">(</span><span class="mf">0</span><span class="p">);</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">});</span>
</code></pre></div>

<h2>Deployment Checklist</h2>
<h3>Smart Contract Deployment</h3>
<ul>
<li>[ ] Deploy user account program</li>
<li>[ ] Deploy market program</li>
<li>[ ] Deploy collateral program</li>
<li>[ ] Deploy oracle program</li>
<li>[ ] Update program IDs in frontend</li>
<li>[ ] Test all programs on devnet</li>
</ul>
<h3>Frontend Integration</h3>
<ul>
<li>[ ] Implement wallet connection</li>
<li>[ ] Implement account creation flow</li>
<li>[ ] Implement deposit flow</li>
<li>[ ] Implement trading interface</li>
<li>[ ] Implement position management</li>
<li>[ ] Test all user flows</li>
</ul>
<h3>Backend Integration</h3>
<ul>
<li>[ ] Implement smart contract sync</li>
<li>[ ] Implement API endpoints</li>
<li>[ ] Implement event handling</li>
<li>[ ] Test data synchronization</li>
<li>[ ] Monitor performance</li>
</ul>
<h3>Testing</h3>
<ul>
<li>[ ] Unit tests for smart contracts</li>
<li>[ ] Integration tests for frontend</li>
<li>[ ] End-to-end tests for complete flow</li>
<li>[ ] Performance tests</li>
<li>[ ] Security audit</li>
</ul>
<h2>Security Considerations</h2>
<h3>Smart Contract Security</h3>
<ul>
<li>[ ] Authority checks on all functions</li>
<li>[ ] Input validation and sanitization</li>
<li>[ ] Reentrancy protection</li>
<li>[ ] Oracle price validation</li>
<li>[ ] Position limit enforcement</li>
</ul>
<h3>Frontend Security</h3>
<ul>
<li>[ ] Wallet integration security</li>
<li>[ ] Transaction signing validation</li>
<li>[ ] State validation</li>
<li>[ ] Error boundary handling</li>
</ul>
<h3>Backend Security</h3>
<ul>
<li>[ ] API authentication</li>
<li>[ ] Rate limiting</li>
<li>[ ] Input validation</li>
<li>[ ] Audit logging</li>
</ul>
<hr />
<p><em>This integration guide provides the foundation for building a complete Solana perpetual DEX with proper account lifecycle management.</em></p>
    </div>
</body>
</html>