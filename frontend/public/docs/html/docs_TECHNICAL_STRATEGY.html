<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Technical Strategy - QuantDesk Documentation</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <style>
        body {
            font-family: 'JetBrains Mono', 'Monaco', 'Consolas', monospace;
            line-height: 1.6;
            color: #ffffff;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #000000;
            font-size: 14px;
        }
        .container {
            background: #000000;
            padding: 30px;
            border-radius: 8px;
            border: 1px solid #333333;
        }
        .back-link {
            margin-bottom: 20px;
        }
        .back-link a {
            color: #3b82f6;
            text-decoration: none;
            font-weight: bold;
            transition: color 0.3s ease;
        }
        .back-link a:hover {
            color: #60a5fa;
            text-decoration: underline;
        }
        h1, h2, h3, h4, h5, h6 {
            color: #ffffff;
            margin-top: 30px;
            margin-bottom: 15px;
            font-weight: 600;
        }
        h1 {
            border-bottom: 2px solid #333333;
            padding-bottom: 10px;
        }
        h2 {
            border-bottom: 1px solid #333333;
            padding-bottom: 8px;
        }
        code {
            background: #1a1a1a;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'JetBrains Mono', 'Monaco', 'Consolas', monospace;
            color: #ffffff;
            border: 1px solid #333333;
        }
        pre {
            background: #0a0a0a;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            border: 1px solid #333333;
            margin: 20px 0;
        }
        pre code {
            background: none;
            padding: 0;
            color: #ffffff;
            border: none;
        }
        blockquote {
            border-left: 4px solid #3b82f6;
            margin: 0;
            padding-left: 20px;
            color: #d9d9d9;
            background: #1a1a1a;
            padding: 15px 20px;
            border-radius: 0 8px 8px 0;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
            border: 1px solid #333333;
        }
        th, td {
            border: 1px solid #333333;
            padding: 12px;
            text-align: left;
        }
        th {
            background: #1a1a1a;
            font-weight: bold;
            color: #ffffff;
        }
        td {
            color: #d9d9d9;
        }
        ul, ol {
            color: #d9d9d9;
        }
        li {
            margin-bottom: 8px;
        }
        a {
            color: #3b82f6;
            text-decoration: none;
        }
        a:hover {
            color: #60a5fa;
            text-decoration: underline;
        }
        /* Syntax Highlighting Overrides */
        pre[class*="language-"] {
            background: #0a0a0a !important;
            border: 1px solid #333333 !important;
            border-radius: 8px !important;
            padding: 20px !important;
            margin: 20px 0 !important;
            font-family: 'JetBrains Mono', 'Monaco', 'Consolas', monospace !important;
            font-size: 13px !important;
            line-height: 1.5 !important;
        }
        .token.comment { color: #6a9955 !important; }
        .token.keyword { color: #569cd6 !important; }
        .token.string { color: #ce9178 !important; }
        .token.number { color: #b5cea8 !important; }
        .token.function { color: #dcdcaa !important; }
        .token.class-name { color: #4ec9b0 !important; }
        .token.operator { color: #d4d4d4 !important; }
        .token.punctuation { color: #d4d4d4 !important; }
        .token.variable { color: #9cdcfe !important; }
        .token.constant { color: #4fc1ff !important; }
    </style>
</head>
<body>
    <div class="container">
        <div class="back-link">
            <a href="/docs">&larr; Back to Documentation</a>
        </div>
        <h1>ðŸ”¬ Technical Trading Strategy Implementation</h1>
<p><em>What is this doc?</em><br />
This document explains how the trading strategy works, how signals are generated, and how risk is managed. It's for anyone who wants to understand or modify the system's decision-making logic.</p>
<p><a href="INDICATORS.html">Indicators</a> | <a href="ML_MODEL.html">ML Model</a> | <a href="../README.html">Project README</a></p>
<h2>Table of Contents</h2>
<ol>
<li><a href="#strategy-overview">Strategy Overview</a></li>
<li><a href="#core-components">Core Components</a></li>
<li><a href="#technical-indicators">Technical Indicators</a></li>
<li><a href="#signal-generation">Signal Generation</a></li>
<li><a href="#position-management">Position Management</a></li>
<li><a href="#implementation-details">Implementation Details</a></li>
</ol>
<h2>Strategy Overview</h2>
<p>This strategy combines machine learning with traditional technical analysis to create a robust trading system. The core components work in harmony to identify, validate, and execute trades.</p>
<h3>Signal Hierarchy</h3>
<div class="codehilite"><pre><span></span><code><span class="n">graph</span><span class="w"> </span><span class="n">TD</span>
<span class="w">    </span><span class="n">A</span><span class="p">[</span><span class="n">Lorentzian</span><span class="w"> </span><span class="n">Classifier</span><span class="p">]</span><span class="w"> </span><span class="o">--&gt;|</span><span class="n">Primary</span><span class="w"> </span><span class="n">Signal</span><span class="o">|</span><span class="w"> </span><span class="n">D</span><span class="p">[</span><span class="n">Trade</span><span class="w"> </span><span class="n">Decision</span><span class="p">]</span>
<span class="w">    </span><span class="n">B</span><span class="p">[</span><span class="n">Logistic</span><span class="w"> </span><span class="n">Regression</span><span class="p">]</span><span class="w"> </span><span class="o">--&gt;|</span><span class="n">Confirmation</span><span class="o">|</span><span class="w"> </span><span class="n">D</span>
<span class="w">    </span><span class="n">C</span><span class="p">[</span><span class="n">Chandelier</span><span class="w"> </span><span class="n">Exit</span><span class="p">]</span><span class="w"> </span><span class="o">--&gt;|</span><span class="n">Risk</span><span class="w"> </span><span class="n">Management</span><span class="o">|</span><span class="w"> </span><span class="n">D</span>
</code></pre></div>

<h2>Core Components</h2>
<h3>1. Lorentzian Classification</h3>
<p>Primary signal generator using K-Nearest Neighbors with Lorentzian distance metric.</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">lorentzian_distance</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x2</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">calculate_lorentzian_score</span><span class="p">(</span><span class="n">data_window</span><span class="p">,</span> <span class="n">neighbors</span><span class="o">=</span><span class="mi">8</span><span class="p">):</span>
    <span class="n">distances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="n">lorentzian_distance</span><span class="p">(</span><span class="n">data_window</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="p">)</span> 
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data_window</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="p">])</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">distances</span><span class="p">)[:</span><span class="n">neighbors</span><span class="p">])</span>
</code></pre></div>

<h4>Feature Set</h4>
<div class="codehilite"><pre><span></span><code><span class="n">features</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;rsi_14_1&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;length&#39;</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span> <span class="s1">&#39;smooth&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
    <span class="s1">&#39;wavetrend&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;channel_length&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;avg_length&#39;</span><span class="p">:</span> <span class="mi">11</span><span class="p">},</span>
    <span class="s1">&#39;cci_20_1&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;length&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s1">&#39;smooth&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
    <span class="s1">&#39;adx_20_2&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;length&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s1">&#39;smooth&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
    <span class="s1">&#39;rsi_9_1&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;length&#39;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span> <span class="s1">&#39;smooth&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3>2. Logistic Regression</h3>
<p>Probability-based signal confirmation using enhanced feature set.</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">LogisticConfirmation</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.7</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span>
            <span class="n">C</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
            <span class="n">class_weight</span><span class="o">=</span><span class="s1">&#39;balanced&#39;</span><span class="p">,</span>
            <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">confirm_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">signal</span><span class="p">):</span>
        <span class="n">prob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">features</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">prob</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="ow">and</span> <span class="n">signal</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> \
               <span class="p">(</span><span class="n">prob</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">)</span> <span class="ow">and</span> <span class="n">signal</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</code></pre></div>

<h3>3. Chandelier Exit</h3>
<p>ATR-based trailing stop system for position management.</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">calculate_chandelier_exit</span><span class="p">(</span><span class="n">high</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">close</span><span class="p">,</span> <span class="n">atr_period</span><span class="o">=</span><span class="mi">22</span><span class="p">,</span> <span class="n">multiplier</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span>
    <span class="n">atr</span> <span class="o">=</span> <span class="n">calculate_atr</span><span class="p">(</span><span class="n">high</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">close</span><span class="p">,</span> <span class="n">atr_period</span><span class="p">)</span>

    <span class="n">long_stop</span> <span class="o">=</span> <span class="n">high</span> <span class="o">-</span> <span class="p">(</span><span class="n">multiplier</span> <span class="o">*</span> <span class="n">atr</span><span class="p">)</span>
    <span class="n">short_stop</span> <span class="o">=</span> <span class="n">low</span> <span class="o">+</span> <span class="p">(</span><span class="n">multiplier</span> <span class="o">*</span> <span class="n">atr</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">long_stop</span><span class="p">,</span> <span class="n">short_stop</span>
</code></pre></div>

<h2>Technical Indicators</h2>
<h3>1. Wave Trend</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">calculate_wave_trend</span><span class="p">(</span><span class="n">close</span><span class="p">,</span> <span class="n">channel_length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">avg_length</span><span class="o">=</span><span class="mi">11</span><span class="p">):</span>
    <span class="n">esa</span> <span class="o">=</span> <span class="n">ema</span><span class="p">(</span><span class="n">close</span><span class="p">,</span> <span class="n">channel_length</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">ema</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">close</span> <span class="o">-</span> <span class="n">esa</span><span class="p">),</span> <span class="n">channel_length</span><span class="p">)</span>
    <span class="n">ci</span> <span class="o">=</span> <span class="p">(</span><span class="n">close</span> <span class="o">-</span> <span class="n">esa</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">0.015</span> <span class="o">*</span> <span class="n">d</span><span class="p">)</span>
    <span class="n">wt1</span> <span class="o">=</span> <span class="n">ema</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span> <span class="n">avg_length</span><span class="p">)</span>
    <span class="n">wt2</span> <span class="o">=</span> <span class="n">sma</span><span class="p">(</span><span class="n">wt1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">wt1</span><span class="p">,</span> <span class="n">wt2</span>
</code></pre></div>

<h3>2. Enhanced RSI</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">calculate_enhanced_rsi</span><span class="p">(</span><span class="n">close</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">rsi</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">RSI</span><span class="p">(</span><span class="n">close</span><span class="p">,</span> <span class="n">timeperiod</span><span class="o">=</span><span class="n">length</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">smooth</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">rsi</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">EMA</span><span class="p">(</span><span class="n">rsi</span><span class="p">,</span> <span class="n">timeperiod</span><span class="o">=</span><span class="n">smooth</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rsi</span>
</code></pre></div>

<h3>3. Custom CCI</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">calculate_custom_cci</span><span class="p">(</span><span class="n">high</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">close</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">typical_price</span> <span class="o">=</span> <span class="p">(</span><span class="n">high</span> <span class="o">+</span> <span class="n">low</span> <span class="o">+</span> <span class="n">close</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span>
    <span class="n">sma_tp</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">SMA</span><span class="p">(</span><span class="n">typical_price</span><span class="p">,</span> <span class="n">timeperiod</span><span class="o">=</span><span class="n">length</span><span class="p">)</span>
    <span class="n">mean_deviation</span> <span class="o">=</span> <span class="n">mean_dev</span><span class="p">(</span><span class="n">typical_price</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
    <span class="n">cci</span> <span class="o">=</span> <span class="p">(</span><span class="n">typical_price</span> <span class="o">-</span> <span class="n">sma_tp</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">0.015</span> <span class="o">*</span> <span class="n">mean_deviation</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">smooth</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">cci</span> <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">EMA</span><span class="p">(</span><span class="n">cci</span><span class="p">,</span> <span class="n">timeperiod</span><span class="o">=</span><span class="n">smooth</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cci</span>
</code></pre></div>

<h2>Signal Generation</h2>
<h3>Feature Calculation</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">calculate_features</span><span class="p">(</span><span class="n">ohlcv_data</span><span class="p">):</span>
    <span class="n">features</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Price action features</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;close_change&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">ohlcv_data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">])</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;volume_change&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">ohlcv_data</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">])</span>

    <span class="c1"># Technical indicators</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;wt1&#39;</span><span class="p">],</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;wt2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calculate_wave_trend</span><span class="p">(</span>
        <span class="n">ohlcv_data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calculate_enhanced_rsi</span><span class="p">(</span>
        <span class="n">ohlcv_data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;cci&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calculate_custom_cci</span><span class="p">(</span>
        <span class="n">ohlcv_data</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">],</span>
        <span class="n">ohlcv_data</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">],</span>
        <span class="n">ohlcv_data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">features</span>
</code></pre></div>

<h3>Signal Combination</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">generate_signal</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">lorentzian_signal</span><span class="p">,</span> <span class="n">logistic_prob</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Combine signals from different components</span>

<span class="sd">    Returns:</span>
<span class="sd">        1: Long signal</span>
<span class="sd">        -1: Short signal</span>
<span class="sd">        0: No trade</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">lorentzian_signal</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">logistic_prob</span> <span class="o">&gt;</span> <span class="mf">0.7</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">lorentzian_signal</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">logistic_prob</span> <span class="o">&lt;</span> <span class="mf">0.3</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">return</span> <span class="mi">0</span>
</code></pre></div>

<h2>Position Management</h2>
<h3>ðŸš¨ CRITICAL: Leverage-Based Position Sizing</h3>
<p><strong>ALL STRATEGIES MUST USE THE LEVERAGE-BASED POSITION SIZING SYSTEM</strong></p>
<p>This is defined in <code>/configs/leverage_position_sizing_config.yaml</code> and implemented in <code>src/utils/position_sizing.py</code>.</p>
<h4>Core Philosophy</h4>
<ul>
<li><strong>High leverage (25-125x) with small allocations (1-10%)</strong></li>
<li><strong>Never use decreasing capital position sizing</strong></li>
<li><strong>Fixed allocation percentages based on leverage</strong></li>
</ul>
<h4>Implementation Requirements</h4>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">src.utils.position_sizing</span> <span class="kn">import</span> <span class="n">PositionSizer</span>
<span class="kn">from</span> <span class="nn">configs.leverage_position_sizing_config</span> <span class="kn">import</span> <span class="n">load_config</span>

<span class="c1"># REQUIRED: Load leverage configuration</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">load_config</span><span class="p">(</span><span class="s1">&#39;leverage_position_sizing_config.yaml&#39;</span><span class="p">)</span>
<span class="n">sizer</span> <span class="o">=</span> <span class="n">PositionSizer</span><span class="p">(</span><span class="n">portfolio_value</span><span class="o">=</span><span class="mf">500.0</span><span class="p">)</span>  <span class="c1"># $500 USDT</span>

<span class="c1"># REQUIRED: Calculate position size based on leverage</span>
<span class="n">leverage</span> <span class="o">=</span> <span class="mi">75</span>  <span class="c1"># 75x leverage</span>
<span class="n">market_conditions</span> <span class="o">=</span> <span class="n">MarketConditions</span><span class="p">(</span>
    <span class="n">volume_ratio</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span>
    <span class="n">sentiment_score</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
    <span class="n">is_bullish</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="n">min_size</span><span class="p">,</span> <span class="n">max_size</span> <span class="o">=</span> <span class="n">sizer</span><span class="o">.</span><span class="n">calculate_position_size</span><span class="p">(</span><span class="n">leverage</span><span class="p">,</span> <span class="n">market_conditions</span><span class="p">)</span>
<span class="n">position_size</span> <span class="o">=</span> <span class="n">min_size</span> <span class="o">*</span> <span class="n">portfolio_value</span>  <span class="c1"># Use minimum allocation</span>
</code></pre></div>

<h4>Leverage Allocation Rules</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># From leverage_position_sizing_config.yaml</span>
<span class="n">leverage_ranges</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;50-125x&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;allocation&quot;</span><span class="p">:</span> <span class="s2">&quot;1-10%&quot;</span><span class="p">},</span>   <span class="c1"># Ultra high leverage</span>
    <span class="s2">&quot;20-49x&quot;</span><span class="p">:</span>  <span class="p">{</span><span class="s2">&quot;allocation&quot;</span><span class="p">:</span> <span class="s2">&quot;10-20%&quot;</span><span class="p">},</span>  <span class="c1"># High leverage  </span>
    <span class="s2">&quot;1-19x&quot;</span><span class="p">:</span>   <span class="p">{</span><span class="s2">&quot;allocation&quot;</span><span class="p">:</span> <span class="s2">&quot;20-100%&quot;</span><span class="p">}</span>  <span class="c1"># Medium leverage</span>
<span class="p">}</span>
</code></pre></div>

<h3>Entry Rules</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">validate_entry</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">current_price</span><span class="p">,</span> <span class="n">volatility</span><span class="p">,</span> <span class="n">leverage</span><span class="p">):</span>
    <span class="n">min_volatility</span> <span class="o">=</span> <span class="n">calculate_min_volatility</span><span class="p">()</span>
    <span class="n">max_volatility</span> <span class="o">=</span> <span class="n">calculate_max_volatility</span><span class="p">()</span>

    <span class="n">volatility_valid</span> <span class="o">=</span> <span class="n">min_volatility</span> <span class="o">&lt;=</span> <span class="n">volatility</span> <span class="o">&lt;=</span> <span class="n">max_volatility</span>

    <span class="c1"># REQUIRED: Validate leverage is within acceptable range</span>
    <span class="n">leverage_valid</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">leverage</span> <span class="o">&lt;=</span> <span class="mi">125</span>

    <span class="k">return</span> <span class="n">signal</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">volatility_valid</span> <span class="ow">and</span> <span class="n">leverage_valid</span>
</code></pre></div>

<h3>Position Sizing (UPDATED)</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">calculate_position_size</span><span class="p">(</span>
    <span class="n">portfolio_value</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">leverage</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">market_conditions</span><span class="p">:</span> <span class="n">MarketConditions</span><span class="p">,</span>
    <span class="n">strategy_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;lorentzian&quot;</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    REQUIRED: Use leverage-based position sizing</span>

<span class="sd">    Args:</span>
<span class="sd">        portfolio_value: Total portfolio value ($500 USDT)</span>
<span class="sd">        leverage: Intended leverage (25-125x)</span>
<span class="sd">        market_conditions: Current market conditions</span>
<span class="sd">        strategy_type: Strategy name for overrides</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sizer</span> <span class="o">=</span> <span class="n">PositionSizer</span><span class="p">(</span><span class="n">portfolio_value</span><span class="p">)</span>
    <span class="n">min_size</span><span class="p">,</span> <span class="n">max_size</span> <span class="o">=</span> <span class="n">sizer</span><span class="o">.</span><span class="n">calculate_position_size</span><span class="p">(</span><span class="n">leverage</span><span class="p">,</span> <span class="n">market_conditions</span><span class="p">)</span>

    <span class="c1"># Apply strategy-specific overrides</span>
    <span class="k">if</span> <span class="n">strategy_type</span> <span class="o">==</span> <span class="s2">&quot;lorentzian&quot;</span><span class="p">:</span>
        <span class="c1"># Use 2-5% allocation for Lorentzian with 75x leverage</span>
        <span class="n">allocation</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">max_size</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">strategy_type</span> <span class="o">==</span> <span class="s2">&quot;chandelier_exit&quot;</span><span class="p">:</span>
        <span class="c1"># Use 1-3% allocation for Chandelier with 100x leverage</span>
        <span class="n">allocation</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">max_size</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">portfolio_value</span> <span class="o">*</span> <span class="n">allocation</span>
</code></pre></div>

<h3>Stop Loss Management</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">update_stops</span><span class="p">(</span>
    <span class="n">position</span><span class="p">,</span>
    <span class="n">current_price</span><span class="p">,</span>
    <span class="n">long_stop</span><span class="p">,</span>
    <span class="n">short_stop</span>
<span class="p">):</span>
    <span class="k">if</span> <span class="n">position</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Long position</span>
        <span class="k">return</span> <span class="n">long_stop</span>
    <span class="k">elif</span> <span class="n">position</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Short position</span>
        <span class="k">return</span> <span class="n">short_stop</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div>

<h2>Implementation Details</h2>
<h3>Data Pipeline</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">TradingPipeline</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">FeatureCalculator</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signals</span> <span class="o">=</span> <span class="n">SignalGenerator</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">risk</span> <span class="o">=</span> <span class="n">RiskManager</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">process_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ohlcv</span><span class="p">):</span>
        <span class="c1"># Calculate features</span>
        <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">ohlcv</span><span class="p">)</span>

        <span class="c1"># Generate signals</span>
        <span class="n">signals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>

        <span class="c1"># Manage risk</span>
        <span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">risk</span><span class="o">.</span><span class="n">manage_position</span><span class="p">(</span>
            <span class="n">signals</span><span class="p">,</span>
            <span class="n">features</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">position</span>
</code></pre></div>

<h3>Model Training</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">train_models</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="c1"># Train Lorentzian Classifier</span>
    <span class="n">lorentzian</span> <span class="o">=</span> <span class="n">LorentzianClassifier</span><span class="p">(</span>
        <span class="n">n_neighbors</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">n_neighbors</span><span class="p">,</span>
        <span class="n">chronological_split</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">lorentzian</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

    <span class="c1"># Train Logistic Confirmation</span>
    <span class="n">logistic</span> <span class="o">=</span> <span class="n">LogisticConfirmation</span><span class="p">(</span>
        <span class="n">threshold</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">threshold</span>
    <span class="p">)</span>
    <span class="n">logistic</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">lorentzian</span><span class="p">,</span> <span class="n">logistic</span>
</code></pre></div>

<h3>Performance Monitoring</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">PerformanceMonitor</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">log_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trade</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trade</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_metrics</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">update_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;win_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_win_rate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;profit_factor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_profit_factor</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_sharpe_ratio</span><span class="p">()</span>
</code></pre></div>

<h2>Configuration</h2>
<h3>Example config.yaml</h3>
<div class="codehilite"><pre><span></span><code><span class="nt">model</span><span class="p">:</span>
<span class="w">  </span><span class="nt">lorentzian</span><span class="p">:</span>
<span class="w">    </span><span class="nt">n_neighbors</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8</span>
<span class="w">    </span><span class="nt">chronological_split</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">feature_set</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rsi_14_1</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">wavetrend</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cci_20_1</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">adx_20_2</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rsi_9_1</span>

<span class="w">  </span><span class="nt">logistic</span><span class="p">:</span>
<span class="w">    </span><span class="nt">threshold</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.7</span>
<span class="w">    </span><span class="nt">class_weight</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">balanced</span>
<span class="w">    </span><span class="nt">max_iter</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1000</span>

<span class="nt">risk</span><span class="p">:</span>
<span class="w">  </span><span class="nt">max_position_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.1</span><span class="w">  </span><span class="c1"># 10% of account</span>
<span class="w">  </span><span class="nt">risk_per_trade</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.02</span><span class="w">   </span><span class="c1"># 2% risk per trade</span>
<span class="w">  </span><span class="nt">max_leverage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">125</span><span class="w">  </span><span class="c1"># UPDATED: Use full leverage capacity</span>
</code></pre></div>

<hr />
<h2>ðŸš¨ CRITICAL: Files That MUST Implement Leverage-Based Position Sizing</h2>
<p><strong>The following files MUST be updated to use the leverage-based position sizing system:</strong></p>
<h3>Core Trading Files</h3>
<ul>
<li><code>src/ml/paper_trading_framework.py</code> - <strong>CRITICAL</strong>: Main backtesting framework</li>
<li><code>src/ml/strategy_backtest.py</code> - Strategy backtesting</li>
<li><code>scripts/example_paper_trading.py</code> - Example paper trading</li>
<li><code>scripts/systematic_multi_timeframe_test.py</code> - Multi-timeframe testing</li>
</ul>
<h3>Strategy Implementation Files</h3>
<ul>
<li><code>src/ml/models/strategy/lorentzian_classifier.py</code> - Lorentzian strategy</li>
<li><code>src/ml/models/strategy/logistic_regression_torch.py</code> - Logistic regression strategy</li>
<li><code>src/ml/models/strategy/chandelier_exit.py</code> - Chandelier exit strategy</li>
<li><code>src/ml/models/strategy/lag_based_strategy.py</code> - Lag-based strategy</li>
</ul>
<h3>Live Trading Files</h3>
<ul>
<li><code>src/trading/bitget/portfolio.py</code> - Portfolio management</li>
<li><code>src/cli/trading/lag_live_trader.py</code> - Live trading CLI</li>
<li><code>src/exchanges/bitget/bitget_trader.py</code> - Bitget trading interface</li>
</ul>
<h3>Configuration Files</h3>
<ul>
<li><code>configs/leverage_position_sizing_config.yaml</code> - <strong>MASTER CONFIG</strong> (already created)</li>
<li><code>configs/automated_trading_config.json</code> - Needs update</li>
<li><code>configs/lag_strategy_config.yaml</code> - Needs update</li>
</ul>
<h3>Required Implementation Steps</h3>
<ol>
<li><strong>Import the position sizing module</strong>:</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">src.utils.position_sizing</span> <span class="kn">import</span> <span class="n">PositionSizer</span><span class="p">,</span> <span class="n">MarketConditions</span>
</code></pre></div>

<ol>
<li><strong>Load the configuration</strong>:</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">yaml</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;configs/leverage_position_sizing_config.yaml&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</code></pre></div>

<ol>
<li><strong>Replace existing position sizing</strong>:</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># OLD (BROKEN):</span>
<span class="n">position_size</span> <span class="o">=</span> <span class="n">capital</span> <span class="o">*</span> <span class="n">risk_per_trade</span>

<span class="c1"># NEW (REQUIRED):</span>
<span class="n">sizer</span> <span class="o">=</span> <span class="n">PositionSizer</span><span class="p">(</span><span class="n">portfolio_value</span><span class="o">=</span><span class="mf">500.0</span><span class="p">)</span>
<span class="n">min_size</span><span class="p">,</span> <span class="n">max_size</span> <span class="o">=</span> <span class="n">sizer</span><span class="o">.</span><span class="n">calculate_position_size</span><span class="p">(</span><span class="n">leverage</span><span class="p">,</span> <span class="n">market_conditions</span><span class="p">)</span>
<span class="n">position_size</span> <span class="o">=</span> <span class="n">min_size</span> <span class="o">*</span> <span class="n">portfolio_value</span>
</code></pre></div>

<ol>
<li><strong>Use realistic fees</strong>:</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># OLD (BROKEN):</span>
<span class="n">total_fees</span> <span class="o">=</span> <span class="mf">0.003</span>  <span class="c1"># 0.3%</span>

<span class="c1"># NEW (REQUIRED):</span>
<span class="n">maker_fee</span> <span class="o">=</span> <span class="mf">0.0002</span>  <span class="c1"># 0.02%</span>
<span class="n">taker_fee</span> <span class="o">=</span> <span class="mf">0.0006</span>  <span class="c1"># 0.06%</span>
</code></pre></div>

<h3>Validation Checklist</h3>
<p>Before any backtest or live trading, ensure:
- [ ] Position sizing uses leverage-based allocation
- [ ] Fees are realistic (0.02-0.06%, not 0.3%)
- [ ] Initial capital is $500 USDT
- [ ] Leverage is 25-125x
- [ ] No decreasing capital position sizing
- [ ] Chandelier exit is enabled
- [ ] Liquidation protection is active</p>
<h2>See Also</h2>
<ul>
<li><a href="../README.html">Project README</a> â€” Project overview and structure</li>
<li><a href="ML_MODEL.html">ML Model Architecture</a> â€” How the model integrates with the strategy</li>
<li><a href="INDICATORS.html">Technical Indicators</a> â€” Details on all custom indicators</li>
<li><a href="TRADING_PHILOSOPHY.html">Trading Philosophy</a> â€” The intuition behind the strategy</li>
<li><a href="../configs/leverage_position_sizing_config.yaml">Leverage Position Sizing Config</a> â€” <strong>MASTER CONFIG</strong></li>
<li><a href="../src/utils/position_sizing.py">Position Sizing Module</a> â€” Implementation details</li>
<li><a href="../src/models/strategy/">src/models/strategy/</a> â€” Strategy code (e.g., <a href="../src/models/strategy/lorentzian_classifier.py">lorentzian_classifier.py</a>, <a href="../src/models/strategy/logistic_regression_torch.py">logistic_regression_torch.py</a>)</li>
<li><a href="../src/features/">src/features/</a> â€” Indicator code</li>
</ul>
<p><em>This document provides the technical implementation details of our trading strategy. It serves as a reference for development and maintenance of the trading system.</em> </p>
    </div>
</body>
</html>