<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi Account System - QuantDesk Documentation</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <style>
        body {
            font-family: 'JetBrains Mono', 'Monaco', 'Consolas', monospace;
            line-height: 1.6;
            color: #ffffff;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #000000;
            font-size: 14px;
        }
        .container {
            background: #000000;
            padding: 30px;
            border-radius: 8px;
            border: 1px solid #333333;
        }
        .back-link {
            margin-bottom: 20px;
        }
        .back-link a {
            color: #3b82f6;
            text-decoration: none;
            font-weight: bold;
            transition: color 0.3s ease;
        }
        .back-link a:hover {
            color: #60a5fa;
            text-decoration: underline;
        }
        h1, h2, h3, h4, h5, h6 {
            color: #ffffff;
            margin-top: 30px;
            margin-bottom: 15px;
            font-weight: 600;
        }
        h1 {
            border-bottom: 2px solid #333333;
            padding-bottom: 10px;
        }
        h2 {
            border-bottom: 1px solid #333333;
            padding-bottom: 8px;
        }
        code {
            background: #1a1a1a;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'JetBrains Mono', 'Monaco', 'Consolas', monospace;
            color: #ffffff;
            border: 1px solid #333333;
        }
        pre {
            background: #0a0a0a;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            border: 1px solid #333333;
            margin: 20px 0;
        }
        pre code {
            background: none;
            padding: 0;
            color: #ffffff;
            border: none;
        }
        blockquote {
            border-left: 4px solid #3b82f6;
            margin: 0;
            padding-left: 20px;
            color: #d9d9d9;
            background: #1a1a1a;
            padding: 15px 20px;
            border-radius: 0 8px 8px 0;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
            border: 1px solid #333333;
        }
        th, td {
            border: 1px solid #333333;
            padding: 12px;
            text-align: left;
        }
        th {
            background: #1a1a1a;
            font-weight: bold;
            color: #ffffff;
        }
        td {
            color: #d9d9d9;
        }
        ul, ol {
            color: #d9d9d9;
        }
        li {
            margin-bottom: 8px;
        }
        a {
            color: #3b82f6;
            text-decoration: none;
        }
        a:hover {
            color: #60a5fa;
            text-decoration: underline;
        }
        /* Syntax Highlighting Overrides */
        pre[class*="language-"] {
            background: #0a0a0a !important;
            border: 1px solid #333333 !important;
            border-radius: 8px !important;
            padding: 20px !important;
            margin: 20px 0 !important;
            font-family: 'JetBrains Mono', 'Monaco', 'Consolas', monospace !important;
            font-size: 13px !important;
            line-height: 1.5 !important;
        }
        .token.comment { color: #6a9955 !important; }
        .token.keyword { color: #569cd6 !important; }
        .token.string { color: #ce9178 !important; }
        .token.number { color: #b5cea8 !important; }
        .token.function { color: #dcdcaa !important; }
        .token.class-name { color: #4ec9b0 !important; }
        .token.operator { color: #d4d4d4 !important; }
        .token.punctuation { color: #d4d4d4 !important; }
        .token.variable { color: #9cdcfe !important; }
        .token.constant { color: #4fc1ff !important; }
    </style>
</head>
<body>
    <div class="container">
        <div class="back-link">
            <a href="/">&larr; Back to Documentation</a>
        </div>
        <h1>üè¶ Multi-Account Management System</h1>
<h2>üìã <strong>Overview</strong></h2>
<p>QuantDesk's proprietary account management system allows users to:
1. <strong>Create multiple sub-accounts</strong> under a single wallet address
2. <strong>Isolate margin trading</strong> across different sub-accounts
3. <strong>Delegate trading permissions</strong> to other accounts
4. <strong>Manage cross-collateral</strong> across all sub-accounts</p>
<h2>üèóÔ∏è <strong>Account Architecture</strong></h2>
<h3><strong>1. Master Account (User Account)</strong></h3>
<ul>
<li><strong>Primary wallet address</strong> - The main Solana wallet</li>
<li><strong>Account authority</strong> - Full control over all trading accounts</li>
<li><strong>Cross-collateral management</strong> - Can transfer funds between trading accounts</li>
</ul>
<h3><strong>2. Trading Accounts</strong></h3>
<ul>
<li><strong>Multiple trading accounts</strong> per master account (typically 1-10)</li>
<li><strong>Independent positions</strong> - Each trading account can hold up to 8 perpetual and 8 spot positions</li>
<li><strong>Isolated margin</strong> - Each trading account has its own margin requirements</li>
<li><strong>32 open orders</strong> per trading account</li>
</ul>
<h3><strong>3. Delegated Accounts</strong></h3>
<ul>
<li><strong>Limited permissions</strong> - Can deposit, place orders, cancel orders</li>
<li><strong>No withdrawal rights</strong> - Cannot withdraw funds or change settings</li>
<li><strong>Professional trading</strong> - Useful for managed accounts</li>
</ul>
<h2>üîß <strong>Implementation for QuantDesk</strong></h2>
<h3><strong>Database Schema Updates</strong></h3>
<div class="codehilite"><pre><span></span><code><span class="c1">-- Main user account (extends existing users table)</span>
<span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="k">COLUMN</span><span class="w"> </span><span class="n">main_account_id</span><span class="w"> </span><span class="n">UUID</span><span class="p">;</span>
<span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="k">COLUMN</span><span class="w"> </span><span class="n">account_type</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;main&#39;</span><span class="p">;</span><span class="w"> </span><span class="c1">-- main, sub, delegated</span>

<span class="c1">-- Trading accounts table</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">trading_accounts</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">uuid_generate_v4</span><span class="p">(),</span>
<span class="w">    </span><span class="n">master_account_id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">users</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">CASCADE</span><span class="p">,</span>
<span class="w">    </span><span class="n">account_index</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">name</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
<span class="w">    </span><span class="n">is_active</span><span class="w"> </span><span class="nb">BOOLEAN</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">true</span><span class="p">,</span>
<span class="w">    </span><span class="n">created_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="k">TIME</span><span class="w"> </span><span class="k">ZONE</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<span class="w">    </span><span class="n">updated_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="k">TIME</span><span class="w"> </span><span class="k">ZONE</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<span class="w">    </span><span class="k">UNIQUE</span><span class="p">(</span><span class="n">master_account_id</span><span class="p">,</span><span class="w"> </span><span class="n">account_index</span><span class="p">)</span>
<span class="p">);</span>

<span class="c1">-- Delegated accounts table</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">delegated_accounts</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">uuid_generate_v4</span><span class="p">(),</span>
<span class="w">    </span><span class="n">master_account_id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">users</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">CASCADE</span><span class="p">,</span>
<span class="w">    </span><span class="n">delegate_wallet_address</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">permissions</span><span class="w"> </span><span class="n">JSONB</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;{&quot;deposit&quot;: true, &quot;trade&quot;: true, &quot;cancel&quot;: true, &quot;withdraw&quot;: false}&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="n">is_active</span><span class="w"> </span><span class="nb">BOOLEAN</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">true</span><span class="p">,</span>
<span class="w">    </span><span class="n">created_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="k">TIME</span><span class="w"> </span><span class="k">ZONE</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<span class="w">    </span><span class="n">updated_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="k">TIME</span><span class="w"> </span><span class="k">ZONE</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<span class="p">);</span>

<span class="c1">-- Update positions table to include trading account</span>
<span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">positions</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="k">COLUMN</span><span class="w"> </span><span class="n">trading_account_id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">trading_accounts</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
<span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="k">COLUMN</span><span class="w"> </span><span class="n">trading_account_id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">trading_accounts</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
<span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">user_balances</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="k">COLUMN</span><span class="w"> </span><span class="n">trading_account_id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">trading_accounts</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
</code></pre></div>

<h3><strong>API Endpoints</strong></h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// Trading account management</span>
<span class="nx">POST</span><span class="w"> </span><span class="o">/</span><span class="nx">api</span><span class="o">/</span><span class="nx">accounts</span><span class="o">/</span><span class="nx">trading</span><span class="o">-</span><span class="nx">accounts</span><span class="w">      </span><span class="c1">// Create new trading account</span>
<span class="nx">GET</span><span class="w">  </span><span class="o">/</span><span class="nx">api</span><span class="o">/</span><span class="nx">accounts</span><span class="o">/</span><span class="nx">trading</span><span class="o">-</span><span class="nx">accounts</span><span class="w">      </span><span class="c1">// List user&#39;s trading accounts</span>
<span class="nx">PUT</span><span class="w">  </span><span class="o">/</span><span class="nx">api</span><span class="o">/</span><span class="nx">accounts</span><span class="o">/</span><span class="nx">trading</span><span class="o">-</span><span class="nx">accounts</span><span class="o">/:</span><span class="nx">id</span><span class="w">  </span><span class="c1">// Update trading account</span>
<span class="nx">DELETE</span><span class="w"> </span><span class="o">/</span><span class="nx">api</span><span class="o">/</span><span class="nx">accounts</span><span class="o">/</span><span class="nx">trading</span><span class="o">-</span><span class="nx">accounts</span><span class="o">/:</span><span class="nx">id</span><span class="w"> </span><span class="c1">// Deactivate trading account</span>

<span class="c1">// Delegated accounts</span>
<span class="nx">POST</span><span class="w"> </span><span class="o">/</span><span class="nx">api</span><span class="o">/</span><span class="nx">accounts</span><span class="o">/</span><span class="nx">delegates</span><span class="w">             </span><span class="c1">// Add delegate</span>
<span class="nx">GET</span><span class="w">  </span><span class="o">/</span><span class="nx">api</span><span class="o">/</span><span class="nx">accounts</span><span class="o">/</span><span class="nx">delegates</span><span class="w">             </span><span class="c1">// List delegates</span>
<span class="nx">PUT</span><span class="w">  </span><span class="o">/</span><span class="nx">api</span><span class="o">/</span><span class="nx">accounts</span><span class="o">/</span><span class="nx">delegates</span><span class="o">/:</span><span class="nx">id</span><span class="w">         </span><span class="c1">// Update permissions</span>
<span class="nx">DELETE</span><span class="w"> </span><span class="o">/</span><span class="nx">api</span><span class="o">/</span><span class="nx">accounts</span><span class="o">/</span><span class="nx">delegates</span><span class="o">/:</span><span class="nx">id</span><span class="w">       </span><span class="c1">// Remove delegate</span>

<span class="c1">// Cross-collateral transfers</span>
<span class="nx">POST</span><span class="w"> </span><span class="o">/</span><span class="nx">api</span><span class="o">/</span><span class="nx">accounts</span><span class="o">/</span><span class="nx">transfer</span><span class="w">              </span><span class="c1">// Transfer between trading accounts</span>
<span class="nx">GET</span><span class="w">  </span><span class="o">/</span><span class="nx">api</span><span class="o">/</span><span class="nx">accounts</span><span class="o">/</span><span class="nx">balances</span><span class="w">              </span><span class="c1">// Get all trading account balances</span>
</code></pre></div>

<h3><strong>Frontend Components</strong></h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// Trading account selector</span>
<span class="o">&lt;</span><span class="nx">TradingAccountSelector</span><span class="w"> </span>
<span class="w">  </span><span class="nx">accounts</span><span class="o">=</span><span class="p">{</span><span class="nx">tradingAccounts</span><span class="p">}</span>
<span class="w">  </span><span class="nx">selectedAccount</span><span class="o">=</span><span class="p">{</span><span class="nx">currentAccount</span><span class="p">}</span>
<span class="w">  </span><span class="nx">onAccountChange</span><span class="o">=</span><span class="p">{</span><span class="nx">handleAccountChange</span><span class="p">}</span>
<span class="err">/&gt;</span>

<span class="c1">// Account management panel</span>
<span class="o">&lt;</span><span class="nx">AccountManagementPanel</span>
<span class="w">  </span><span class="nx">masterAccount</span><span class="o">=</span><span class="p">{</span><span class="nx">masterAccount</span><span class="p">}</span>
<span class="w">  </span><span class="nx">tradingAccounts</span><span class="o">=</span><span class="p">{</span><span class="nx">tradingAccounts</span><span class="p">}</span>
<span class="w">  </span><span class="nx">delegates</span><span class="o">=</span><span class="p">{</span><span class="nx">delegates</span><span class="p">}</span>
<span class="w">  </span><span class="nx">onCreateTradingAccount</span><span class="o">=</span><span class="p">{</span><span class="nx">handleCreateTradingAccount</span><span class="p">}</span>
<span class="w">  </span><span class="nx">onAddDelegate</span><span class="o">=</span><span class="p">{</span><span class="nx">handleAddDelegate</span><span class="p">}</span>
<span class="err">/&gt;</span>
</code></pre></div>

<h2>üöÄ <strong>Implementation Steps</strong></h2>
<h3><strong>Phase 1: Database &amp; Backend</strong></h3>
<ol>
<li>‚úÖ Update database schema</li>
<li>‚úÖ Create trading account management endpoints</li>
<li>‚úÖ Implement cross-collateral transfers</li>
<li>‚úÖ Add delegate account system</li>
</ol>
<h3><strong>Phase 2: Frontend Integration</strong></h3>
<ol>
<li>‚úÖ Add trading account selector to trading interface</li>
<li>‚úÖ Create account management dashboard</li>
<li>‚úÖ Implement account switching</li>
<li>‚úÖ Add delegate management UI</li>
</ol>
<h3><strong>Phase 3: Smart Contract Integration</strong></h3>
<ol>
<li>‚úÖ Deploy account management contracts</li>
<li>‚úÖ Implement on-chain trading account creation</li>
<li>‚úÖ Add cross-collateral on-chain logic</li>
<li>‚úÖ Test with devnet</li>
</ol>
<h2>üìä <strong>User Experience Flow</strong></h2>
<h3><strong>Account Creation</strong></h3>
<ol>
<li>User connects wallet ‚Üí Master account created</li>
<li>User clicks "Add Trading Account" ‚Üí New trading account created</li>
<li>User names trading account ‚Üí "Trading Account 1"</li>
<li>User deposits collateral ‚Üí Funds allocated to trading account</li>
</ol>
<h3><strong>Trading</strong></h3>
<ol>
<li>User selects trading account from dropdown</li>
<li>User places trade ‚Üí Trade executed on selected trading account</li>
<li>User switches trading account ‚Üí Different positions/balances shown</li>
<li>User can transfer funds between trading accounts</li>
</ol>
<h3><strong>Delegation</strong></h3>
<ol>
<li>User adds delegate wallet address</li>
<li>User sets permissions (deposit, trade, cancel)</li>
<li>Delegate can now trade on behalf of user</li>
<li>User retains full control and can revoke access</li>
</ol>
<h2>üîí <strong>Security Features</strong></h2>
<ul>
<li><strong>Isolated margins</strong> - Each trading account has independent risk</li>
<li><strong>Permission controls</strong> - Granular delegate permissions</li>
<li><strong>Audit trails</strong> - All account actions logged</li>
<li><strong>Emergency controls</strong> - Master account can freeze trading accounts</li>
</ul>
<h2>üéØ <strong>Benefits</strong></h2>
<ul>
<li><strong>Risk isolation</strong> - Separate trading strategies</li>
<li><strong>Professional management</strong> - Delegate to trading teams</li>
<li><strong>Capital efficiency</strong> - Cross-collateral optimization</li>
<li><strong>User experience</strong> - Professional multi-account interface</li>
</ul>
<hr />
<p><strong>Next Steps:</strong>
1. Implement database schema changes
2. Create backend endpoints
3. Build frontend components
4. Test with devnet
5. Deploy to Railway</p>
    </div>
</body>
</html>