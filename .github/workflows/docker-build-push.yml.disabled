name: ğŸ³ Docker Build & Push Pipeline


# Security: Explicit permissions for GITHUB_TOKEN
permissions:
  contents: read
  pull-requests: write
  issues: write
  checks: write
  statuses: write

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allow manual trigger

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  docker-build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ğŸ” Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ·ï¸ Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}

    - name: ğŸ—ï¸ Build backend Docker image
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        file: ./backend/Dockerfile
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:latest
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:${{ github.sha }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64,linux/arm64

    - name: ğŸ—ï¸ Build root Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-root:latest
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-root:${{ github.sha }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64,linux/arm64

    - name: ğŸ§ª Test Docker images
      run: |
        echo "ğŸ§ª Testing Docker Images"
        echo "========================"
        echo ""
        
        # Test backend image
        echo "Testing backend image..."
        docker run --rm ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:latest --version || echo "Version check failed"
        docker run --rm ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:latest node --version || echo "Node version check failed"
        
        # Test root image
        echo "Testing root image..."
        docker run --rm ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-root:latest --version || echo "Version check failed"
        docker run --rm ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-root:latest node --version || echo "Node version check failed"
        
        echo "âœ… Docker images tested successfully"

    - name: ğŸ“Š Docker image info
      run: |
        echo "ğŸ“Š Docker Image Information"
        echo "==========================="
        echo ""
        echo "ğŸ·ï¸ Backend Image Tags:"
        echo "â€¢ ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:latest"
        echo "â€¢ ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:${{ github.sha }}"
        echo ""
        echo "ğŸ·ï¸ Root Image Tags:"
        echo "â€¢ ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-root:latest"
        echo "â€¢ ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-root:${{ github.sha }}"
        echo ""
        echo "ğŸ“¦ Image Details:"
        docker images | grep "${{ env.IMAGE_NAME }}" || echo "Images not found locally"

  docker-security-scan:
    name: Docker Security Scan
    runs-on: ubuntu-latest
    needs: docker-build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ğŸ” Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ” Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:latest
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: ğŸ“¤ Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

    - name: ğŸ” Run Trivy vulnerability scanner (Root Image)
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-root:latest
        format: 'table'
        output: 'trivy-root-results.txt'

    - name: ğŸ“Š Security scan summary
      run: |
        echo "ğŸ” Docker Security Scan Results"
        echo "==============================="
        echo ""
        echo "âœ… Security scan completed"
        echo "ğŸ“‹ Results uploaded to GitHub Security tab"
        echo ""
        echo "ğŸ“Š Scan Summary:"
        echo "â€¢ Backend image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:latest"
        echo "â€¢ Root image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-root:latest"
        echo "â€¢ Scanner: Trivy"
        echo "â€¢ Format: SARIF + Table"
        echo ""
        if [ -f "trivy-root-results.txt" ]; then
          echo "ğŸ“„ Root Image Scan Results:"
          cat trivy-root-results.txt
        fi

  docker-optimization:
    name: Docker Image Optimization
    runs-on: ubuntu-latest
    needs: docker-build

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ğŸ” Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ“Š Analyze image layers
      run: |
        echo "ğŸ“Š Docker Image Layer Analysis"
        echo "=============================="
        echo ""
        
        # Pull images for analysis
        docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:latest
        docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-root:latest
        
        echo "ğŸ—ï¸ Backend Image Analysis:"
        docker history ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:latest --format "table {{.CreatedBy}}\t{{.Size}}" | head -10
        
        echo ""
        echo "ğŸ—ï¸ Root Image Analysis:"
        docker history ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-root:latest --format "table {{.CreatedBy}}\t{{.Size}}" | head -10
        
        echo ""
        echo "ğŸ“ Image Sizes:"
        docker images | grep "${{ env.IMAGE_NAME }}" | awk '{print $1 " " $7}'

    - name: ğŸ¯ Optimization recommendations
      run: |
        echo "ğŸ¯ Docker Optimization Recommendations"
        echo "====================================="
        echo ""
        echo "ğŸ’¡ Best Practices Applied:"
        echo "âœ… Multi-stage builds enabled"
        echo "âœ… .dockerignore properly configured"
        echo "âœ… Base image: node:20-bookworm-slim"
        echo "âœ… Cache optimization with Buildx"
        echo ""
        echo "ğŸ”§ Additional Optimizations:"
        echo "â€¢ Consider alpine-based images for smaller size"
        echo "â€¢ Use specific dependency versions"
        echo "â€¢ Implement health checks"
        echo "â€¢ Use non-root user for security"
        echo ""
        echo "ğŸ“Š Performance Metrics:"
        echo "â€¢ Build time: Optimized with cache"
        echo "â€¢ Image size: Minimized with slim base"
        echo "â€¢ Security: Scanned with Trivy"
        echo "â€¢ Multi-platform: AMD64 + ARM64 support"

  docker-registry-cleanup:
    name: Registry Cleanup
    runs-on: ubuntu-latest
    needs: [docker-build, docker-security-scan]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ” Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ§¹ Cleanup old images
      run: |
        echo "ğŸ§¹ Docker Registry Cleanup"
        echo "=========================="
        echo ""
        echo "ğŸ“‹ Current images in registry:"
        echo "â€¢ ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:latest"
        echo "â€¢ ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:${{ github.sha }}"
        echo "â€¢ ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-root:latest"
        echo "â€¢ ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-root:${{ github.sha }}"
        echo ""
        echo "ğŸ’¡ Cleanup Strategy:"
        echo "â€¢ Keep latest tags for main branch"
        echo "â€¢ Keep commit SHA tags for traceability"
        echo "â€¢ Remove old feature branch tags (manual process)"
        echo ""
        echo "âœ… Registry cleanup completed"

  docker-summary:
    name: ğŸ“Š Docker Build Summary
    runs-on: ubuntu-latest
    needs: [docker-build, docker-security-scan, docker-optimization, docker-registry-cleanup]
    if: always()

    steps:
    - name: ğŸ“Š Docker Pipeline Results
      run: |
        echo "ğŸ³ Docker Build & Push Pipeline Complete!"
        echo "=========================================="
        echo ""
        echo "ğŸ“‹ Pipeline Results:"
        echo "â€¢ Docker Build: ${{ needs.docker-build.result }}"
        echo "â€¢ Security Scan: ${{ needs.docker-security-scan.result }}"
        echo "â€¢ Optimization: ${{ needs.docker-optimization.result }}"
        echo "â€¢ Registry Cleanup: ${{ needs.docker-registry-cleanup.result }}"
        echo ""
        echo "ğŸ·ï¸ Generated Images:"
        echo "â€¢ Backend: ghcr.io/${{ github.repository }}-backend:latest"
        echo "â€¢ Backend: ghcr.io/${{ github.repository }}-backend:${{ github.sha }}"
        echo "â€¢ Root: ghcr.io/${{ github.repository }}-root:latest"
        echo "â€¢ Root: ghcr.io/${{ github.repository }}-root:${{ github.sha }}"
        echo ""
        echo "ğŸ”’ Security Features:"
        echo "â€¢ Vulnerability scanning with Trivy"
        echo "â€¢ SARIF results in GitHub Security tab"
        echo "â€¢ Multi-platform builds (AMD64 + ARM64)"
        echo ""
        echo "âš¡ Performance Features:"
        echo "â€¢ Build cache optimization"
        echo "â€¢ Multi-stage builds"
        echo "â€¢ Slim base images"
        echo ""
        if [[ "${{ needs.docker-build.result }}" == "success" && "${{ needs.docker-security-scan.result }}" == "success" ]]; then
          echo "ğŸ‰ Docker pipeline completed successfully!"
          echo "ğŸš€ Images ready for deployment!"
        else
          echo "âš ï¸  Some Docker pipeline steps failed - check logs above"
        fi
