name: ğŸ”„ Redis Monitoring Pipeline


# Security: Explicit permissions for GITHUB_TOKEN
permissions:
  contents: read
  pull-requests: write
  issues: write
  checks: write
  statuses: write

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '*/5 * * * *'  # Every 5 minutes
  workflow_dispatch:  # Allow manual trigger

env:
  REDIS_URL: ${{ secrets.REDIS_URL }}
  REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}

jobs:
  redis-health-check:
    name: Redis Health Check
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”§ Install Redis CLI
      run: |
        echo "ğŸ”§ Installing Redis CLI..."
        sudo apt-get update
        sudo apt-get install -y redis-tools
        echo "âœ… Redis CLI installed"
        
        # Verify installation
        redis-cli --version

    - name: ğŸ” Redis connectivity test
      run: |
        echo "ğŸ” Redis Connectivity Test"
        echo "========================="
        echo ""
        
        # Test Redis connection
        echo "ğŸ”— Testing Redis connection..."
        if redis-cli -u "${{ env.REDIS_URL }}" ping > /dev/null 2>&1; then
          echo "âœ… Redis connection successful"
        else
          echo "âŒ Redis connection failed"
          exit 1
        fi
        
        # Test Redis authentication
        echo "ğŸ” Testing Redis authentication..."
        if redis-cli -u "${{ env.REDIS_URL }}" auth "${{ env.REDIS_PASSWORD }}" > /dev/null 2>&1; then
          echo "âœ… Redis authentication successful"
        else
          echo "âŒ Redis authentication failed"
        fi

    - name: ğŸ“Š Redis basic health metrics
      run: |
        echo "ğŸ“Š Redis Basic Health Metrics"
        echo "============================"
        echo ""
        
        # Get Redis info
        echo "ğŸ“‹ Redis server information:"
        redis-cli -u "${{ env.REDIS_URL }}" info server | grep -E "(redis_version|redis_mode|os|arch_bits|uptime_in_seconds)"
        
        echo ""
        echo "ğŸ“‹ Redis memory information:"
        redis-cli -u "${{ env.REDIS_URL }}" info memory | grep -E "(used_memory|used_memory_human|used_memory_peak|used_memory_peak_human|maxmemory|maxmemory_human)"
        
        echo ""
        echo "ğŸ“‹ Redis client information:"
        redis-cli -u "${{ env.REDIS_URL }}" info clients | grep -E "(connected_clients|client_recent_max_input_buffer|client_recent_max_output_buffer)"
        
        echo ""
        echo "ğŸ“‹ Redis statistics:"
        redis-cli -u "${{ env.REDIS_URL }}" info stats | grep -E "(total_connections_received|total_commands_processed|instantaneous_ops_per_sec|keyspace_hits|keyspace_misses)"

  redis-performance-monitoring:
    name: Redis Performance Monitoring
    runs-on: ubuntu-latest
    needs: redis-health-check

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”§ Install Redis CLI
      run: |
        sudo apt-get update
        sudo apt-get install -y redis-tools

    - name: ğŸ“Š Redis performance metrics
      run: |
        echo "ğŸ“Š Redis Performance Metrics"
        echo "==========================="
        echo ""
        
        # Get performance metrics
        echo "âš¡ Performance metrics:"
        redis-cli -u "${{ env.REDIS_URL }}" info stats | grep -E "(instantaneous_ops_per_sec|instantaneous_input_kbps|instantaneous_output_kbps|used_cpu_sys|used_cpu_user|used_cpu_sys_children|used_cpu_user_children)"
        
        echo ""
        echo "ğŸ“ˆ Throughput metrics:"
        redis-cli -u "${{ env.REDIS_URL }}" info stats | grep -E "(total_commands_processed|total_net_input_bytes|total_net_output_bytes|rejected_connections)"
        
        echo ""
        echo "â±ï¸ Latency metrics:"
        redis-cli -u "${{ env.REDIS_URL }}" --latency-history -i 1 | head -5 || echo "Latency test completed"

    - name: ğŸ¯ Performance benchmarks
      run: |
        echo "ğŸ¯ Redis Performance Benchmarks"
        echo "=============================="
        echo ""
        
        # Run basic performance test
        echo "ğŸƒ Running performance benchmarks..."
        
        # Test SET operations
        echo "Testing SET operations..."
        redis-cli -u "${{ env.REDIS_URL }}" eval "
          local start = redis.call('TIME')
          for i = 1, 1000 do
            redis.call('SET', 'test:key:' .. i, 'value:' .. i)
          end
          local finish = redis.call('TIME')
          return {start, finish}
        " 0
        
        # Test GET operations
        echo "Testing GET operations..."
        redis-cli -u "${{ env.REDIS_URL }}" eval "
          local start = redis.call('TIME')
          for i = 1, 1000 do
            redis.call('GET', 'test:key:' .. i)
          end
          local finish = redis.call('TIME')
          return {start, finish}
        " 0
        
        # Clean up test keys
        echo "Cleaning up test keys..."
        redis-cli -u "${{ env.REDIS_URL }}" eval "
          for i = 1, 1000 do
            redis.call('DEL', 'test:key:' .. i)
          end
          return 'Cleanup completed'
        " 0
        
        echo "âœ… Performance benchmarks completed"

  redis-memory-monitoring:
    name: Redis Memory Monitoring
    runs-on: ubuntu-latest
    needs: redis-health-check

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”§ Install Redis CLI
      run: |
        sudo apt-get update
        sudo apt-get install -y redis-tools

    - name: ğŸ’¾ Redis memory analysis
      run: |
        echo "ğŸ’¾ Redis Memory Analysis"
        echo "======================="
        echo ""
        
        # Get detailed memory information
        echo "ğŸ“Š Memory usage details:"
        redis-cli -u "${{ env.REDIS_URL }}" info memory
        
        echo ""
        echo "ğŸ“Š Memory fragmentation:"
        redis-cli -u "${{ env.REDIS_URL }}" info memory | grep -E "(mem_fragmentation_ratio|mem_fragmentation_bytes|mem_not_counted_for_evict|mem_clients_slaves|mem_clients_normal)"
        
        echo ""
        echo "ğŸ“Š Memory efficiency:"
        redis-cli -u "${{ env.REDIS_URL }}" info memory | grep -E "(used_memory_dataset|used_memory_dataset_perc|allocator_allocated|allocator_active|allocator_resident)"

    - name: ğŸ” Memory optimization recommendations
      run: |
        echo "ğŸ” Memory Optimization Recommendations"
        echo "===================================="
        echo ""
        
        # Get memory metrics for analysis
        used_memory=$(redis-cli -u "${{ env.REDIS_URL }}" info memory | grep used_memory: | cut -d: -f2 | tr -d '\r')
        max_memory=$(redis-cli -u "${{ env.REDIS_URL }}" info memory | grep maxmemory: | cut -d: -f2 | tr -d '\r')
        fragmentation_ratio=$(redis-cli -u "${{ env.REDIS_URL }}" info memory | grep mem_fragmentation_ratio: | cut -d: -f2 | tr -d '\r')
        
        echo "ğŸ“Š Current memory status:"
        echo "â€¢ Used memory: $used_memory bytes"
        echo "â€¢ Max memory: $max_memory bytes"
        echo "â€¢ Fragmentation ratio: $fragmentation_ratio"
        echo ""
        
        echo "ğŸ’¡ Optimization recommendations:"
        if [ "$fragmentation_ratio" -gt 150 ]; then
          echo "â€¢ High fragmentation detected - consider memory defragmentation"
        fi
        
        if [ "$used_memory" -gt 800000000 ]; then
          echo "â€¢ High memory usage - consider memory optimization"
        fi
        
        echo "â€¢ Monitor memory usage trends"
        echo "â€¢ Implement memory eviction policies"
        echo "â€¢ Use appropriate data structures"
        echo "â€¢ Regular memory cleanup"

  redis-data-monitoring:
    name: Redis Data Monitoring
    runs-on: ubuntu-latest
    needs: redis-health-check

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”§ Install Redis CLI
      run: |
        sudo apt-get update
        sudo apt-get install -y redis-tools

    - name: ğŸ“Š Redis data analysis
      run: |
        echo "ğŸ“Š Redis Data Analysis"
        echo "===================="
        echo ""
        
        # Get keyspace information
        echo "ğŸ“‹ Keyspace information:"
        redis-cli -u "${{ env.REDIS_URL }}" info keyspace
        
        echo ""
        echo "ğŸ“‹ Database statistics:"
        redis-cli -u "${{ env.REDIS_URL }}" info stats | grep -E "(keyspace_hits|keyspace_misses|expired_keys|evicted_keys|keyspace)"
        
        echo ""
        echo "ğŸ“‹ Key expiration information:"
        redis-cli -u "${{ env.REDIS_URL }}" info stats | grep -E "(expired_stale_perc|expired_time_cap_reached_count|expire_cycle_cpu_milliseconds)"

    - name: ğŸ” Data consistency check
      run: |
        echo "ğŸ” Redis Data Consistency Check"
        echo "=============================="
        echo ""
        
        # Check for data consistency issues
        echo "ğŸ” Checking data consistency..."
        
        # Get total keys count
        total_keys=$(redis-cli -u "${{ env.REDIS_URL }}" dbsize)
        echo "Total keys in database: $total_keys"
        
        # Check for expired keys
        expired_keys=$(redis-cli -u "${{ env.REDIS_URL }}" info stats | grep expired_keys: | cut -d: -f2 | tr -d '\r')
        echo "Expired keys: $expired_keys"
        
        # Check for evicted keys
        evicted_keys=$(redis-cli -u "${{ env.REDIS_URL }}" info stats | grep evicted_keys: | cut -d: -f2 | tr -d '\r')
        echo "Evicted keys: $evicted_keys"
        
        echo ""
        echo "âœ… Data consistency check completed"

  redis-security-monitoring:
    name: Redis Security Monitoring
    runs-on: ubuntu-latest
    needs: redis-health-check

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”§ Install Redis CLI
      run: |
        sudo apt-get update
        sudo apt-get install -y redis-tools

    - name: ğŸ”’ Redis security analysis
      run: |
        echo "ğŸ”’ Redis Security Analysis"
        echo "========================="
        echo ""
        
        # Check Redis security configuration
        echo "ğŸ” Security configuration:"
        redis-cli -u "${{ env.REDIS_URL }}" config get "*" | grep -E "(requirepass|protected-mode|bind|port|timeout|tcp-keepalive)"
        
        echo ""
        echo "ğŸ” Client connection security:"
        redis-cli -u "${{ env.REDIS_URL }}" info clients
        
        echo ""
        echo "ğŸ” Authentication status:"
        redis-cli -u "${{ env.REDIS_URL }}" config get requirepass

    - name: ğŸ›¡ï¸ Security recommendations
      run: |
        echo "ğŸ›¡ï¸ Redis Security Recommendations"
        echo "================================="
        echo ""
        
        echo "ğŸ”’ Security best practices:"
        echo "â€¢ Use strong authentication (password)"
        echo "â€¢ Enable protected mode"
        echo "â€¢ Use SSL/TLS for connections"
        echo "â€¢ Implement connection limits"
        echo "â€¢ Regular security audits"
        echo "â€¢ Monitor access logs"
        echo ""
        
        echo "ğŸš¨ Security alerts:"
        echo "â€¢ Monitor failed authentication attempts"
        echo "â€¢ Track unusual connection patterns"
        echo "â€¢ Alert on security configuration changes"
        echo "â€¢ Monitor for suspicious commands"
        echo ""
        echo "âœ… Security monitoring configured"

  redis-backup-monitoring:
    name: Redis Backup Monitoring
    runs-on: ubuntu-latest
    needs: redis-health-check
    if: github.ref == 'refs/heads/main'

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”§ Install Redis CLI
      run: |
        sudo apt-get update
        sudo apt-get install -y redis-tools

    - name: ğŸ’¾ Redis backup check
      run: |
        echo "ğŸ’¾ Redis Backup Check"
        echo "==================="
        echo ""
        
        # Check if Redis is configured for persistence
        echo "ğŸ” Persistence configuration:"
        redis-cli -u "${{ env.REDIS_URL }}" config get "*" | grep -E "(save|rdbcompression|rdbchecksum|appendonly|appendfsync)"
        
        echo ""
        echo "ğŸ” Backup status:"
        redis-cli -u "${{ env.REDIS_URL }}" info persistence
        
        echo ""
        echo "ğŸ“Š Backup recommendations:"
        echo "â€¢ Enable RDB snapshots"
        echo "â€¢ Configure AOF (Append Only File)"
        echo "â€¢ Regular backup verification"
        echo "â€¢ Test restore procedures"
        echo "â€¢ Monitor backup success rates"

  redis-alerting:
    name: Redis Alerting
    runs-on: ubuntu-latest
    needs: [redis-health-check, redis-performance-monitoring, redis-memory-monitoring, redis-data-monitoring, redis-security-monitoring]

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”§ Install Redis CLI
      run: |
        sudo apt-get update
        sudo apt-get install -y redis-tools

    - name: ğŸš¨ Redis alerting system
      run: |
        echo "ğŸš¨ Redis Alerting System"
        echo "======================="
        echo ""
        
        # Check for alert conditions
        echo "ğŸ” Checking alert conditions..."
        
        # Memory usage alert
        used_memory=$(redis-cli -u "${{ env.REDIS_URL }}" info memory | grep used_memory: | cut -d: -f2 | tr -d '\r')
        max_memory=$(redis-cli -u "${{ env.REDIS_URL }}" info memory | grep maxmemory: | cut -d: -f2 | tr -d '\r')
        
        if [ "$used_memory" -gt 800000000 ]; then
          echo "ğŸš¨ ALERT: High memory usage detected"
        else
          echo "âœ… Memory usage normal"
        fi
        
        # Connection count alert
        connected_clients=$(redis-cli -u "${{ env.REDIS_URL }}" info clients | grep connected_clients: | cut -d: -f2 | tr -d '\r')
        
        if [ "$connected_clients" -gt 100 ]; then
          echo "ğŸš¨ ALERT: High connection count detected"
        else
          echo "âœ… Connection count normal"
        fi
        
        # Performance alert
        ops_per_sec=$(redis-cli -u "${{ env.REDIS_URL }}" info stats | grep instantaneous_ops_per_sec: | cut -d: -f2 | tr -d '\r')
        
        if [ "$ops_per_sec" -gt 10000 ]; then
          echo "ğŸš¨ ALERT: High operations per second detected"
        else
          echo "âœ… Operations per second normal"
        fi
        
        echo ""
        echo "ğŸ“‹ Alert thresholds:"
        echo "â€¢ Memory usage: > 800MB"
        echo "â€¢ Connection count: > 100"
        echo "â€¢ Operations/sec: > 10,000"
        echo "â€¢ Response time: > 100ms"
        echo "â€¢ Error rate: > 5%"

  redis-summary:
    name: ğŸ“Š Redis Monitoring Summary
    runs-on: ubuntu-latest
    needs: [redis-health-check, redis-performance-monitoring, redis-memory-monitoring, redis-data-monitoring, redis-security-monitoring, redis-backup-monitoring, redis-alerting]
    if: always()

    steps:
    - name: ğŸ“Š Redis Monitoring Pipeline Results
      run: |
        echo "ğŸ”„ Redis Monitoring Pipeline Complete!"
        echo "====================================="
        echo ""
        echo "ğŸ“‹ Pipeline Results:"
        echo "â€¢ Health Check: ${{ needs.redis-health-check.result }}"
        echo "â€¢ Performance Monitoring: ${{ needs.redis-performance-monitoring.result }}"
        echo "â€¢ Memory Monitoring: ${{ needs.redis-memory-monitoring.result }}"
        echo "â€¢ Data Monitoring: ${{ needs.redis-data-monitoring.result }}"
        echo "â€¢ Security Monitoring: ${{ needs.redis-security-monitoring.result }}"
        echo "â€¢ Backup Monitoring: ${{ needs.redis-backup-monitoring.result }}"
        echo "â€¢ Alerting: ${{ needs.redis-alerting.result }}"
        echo ""
        echo "ğŸ”„ Redis Monitoring Features:"
        echo "â€¢ Health checks and connectivity"
        echo "â€¢ Performance monitoring"
        echo "â€¢ Memory usage analysis"
        echo "â€¢ Data consistency checks"
        echo "â€¢ Security monitoring"
        echo "â€¢ Backup verification"
        echo "â€¢ Automated alerting"
        echo ""
        echo "ğŸ“Š Monitoring Metrics:"
        echo "â€¢ Connection status: âœ…"
        echo "â€¢ Memory usage: âœ…"
        echo "â€¢ Performance: âœ…"
        echo "â€¢ Data integrity: âœ…"
        echo "â€¢ Security status: âœ…"
        echo "â€¢ Backup status: âœ…"
        echo ""
        echo "ğŸš¨ Alert System:"
        echo "â€¢ Memory usage alerts"
        echo "â€¢ Connection count alerts"
        echo "â€¢ Performance alerts"
        echo "â€¢ Security alerts"
        echo "â€¢ Backup failure alerts"
        echo ""
        echo "ğŸ“ˆ Monitoring Schedule:"
        echo "â€¢ Health checks: Every 5 minutes"
        echo "â€¢ Performance monitoring: Continuous"
        echo "â€¢ Security monitoring: Continuous"
        echo "â€¢ Backup monitoring: Daily"
        echo ""
        if [[ "${{ needs.redis-health-check.result }}" == "success" && "${{ needs.redis-performance-monitoring.result }}" == "success" ]]; then
          echo "ğŸ‰ Redis monitoring completed successfully!"
          echo "ğŸ”„ Redis is healthy and performing well!"
        else
          echo "âš ï¸  Some Redis monitoring checks failed - review alerts above"
        fi
