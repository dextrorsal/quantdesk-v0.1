# QuantDesk Hybrid Points System - Supabase Implementation Guide

## ðŸŽ¯ **Supabase-First Implementation Approach**

**Generated by:** @dev  
**Date:** December 25, 2024  
**Status:** ðŸ”„ **SUPABASE IMPLEMENTATION** - Hybrid Approach

---

## ðŸŽ¯ **Implementation Strategy**

### **âœ… Hybrid Approach:**
- **SQL Files** - Keep for reference and documentation
- **Supabase Dashboard** - Primary implementation method
- **Focus** - Build directly in Supabase for immediate results
- **Documentation** - Use SQL files as comprehensive reference

### **ðŸš€ Benefits:**
- âœ… **Immediate Results** - Changes apply instantly
- âœ… **Visual Management** - Easy to see relationships
- âœ… **Reference Documentation** - SQL files show complete schema
- âœ… **Version Control** - Track what was built
- âœ… **Team Collaboration** - Everyone can see the reference

---

## ðŸ“‹ **Supabase Implementation Checklist**

### **Phase 1: Core Tables (Start Here)**

#### **1. Points Allocation Periods**
```sql
-- Copy this into Supabase SQL Editor
CREATE TABLE points_allocation_periods (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    period_name VARCHAR(100) NOT NULL,
    period_type VARCHAR(50) NOT NULL,
    start_date TIMESTAMP NOT NULL,
    end_date TIMESTAMP NOT NULL,
    total_points_pool BIGINT NOT NULL,
    points_distributed BIGINT DEFAULT 0,
    points_remaining BIGINT GENERATED ALWAYS AS (total_points_pool - points_distributed) STORED,
    is_active BOOLEAN DEFAULT false,
    created_at TIMESTAMP DEFAULT NOW(),
    metadata JSONB DEFAULT '{}'
);

-- Add constraints
ALTER TABLE points_allocation_periods 
ADD CONSTRAINT check_positive_points_pool 
CHECK (total_points_pool > 0);

ALTER TABLE points_allocation_periods 
ADD CONSTRAINT check_valid_dates 
CHECK (end_date > start_date);

ALTER TABLE points_allocation_periods 
ADD CONSTRAINT check_points_not_exceeded 
CHECK (points_distributed <= total_points_pool);
```

#### **2. Activity Multipliers**
```sql
-- Copy this into Supabase SQL Editor
CREATE TABLE activity_multipliers (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    period_id UUID REFERENCES points_allocation_periods(id) ON DELETE CASCADE,
    activity_type VARCHAR(50) NOT NULL,
    base_multiplier DECIMAL(5,2) NOT NULL DEFAULT 1.00,
    early_user_bonus DECIMAL(5,2) NOT NULL DEFAULT 1.00,
    active_user_bonus DECIMAL(5,2) NOT NULL DEFAULT 1.00,
    community_bonus DECIMAL(5,2) NOT NULL DEFAULT 1.00,
    created_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(period_id, activity_type)
);

-- Add constraints
ALTER TABLE activity_multipliers 
ADD CONSTRAINT check_positive_multipliers 
CHECK (base_multiplier > 0 AND early_user_bonus > 0 
       AND active_user_bonus > 0 AND community_bonus > 0);

ALTER TABLE activity_multipliers 
ADD CONSTRAINT check_reasonable_multipliers 
CHECK (base_multiplier <= 10 AND early_user_bonus <= 10 
       AND active_user_bonus <= 10 AND community_bonus <= 10);
```

#### **3. Trading Metrics**
```sql
-- Copy this into Supabase SQL Editor
CREATE TABLE trading_metrics (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    total_trading_volume DECIMAL(20,2) DEFAULT 0.00,
    maker_volume DECIMAL(20,2) DEFAULT 0.00,
    taker_volume DECIMAL(20,2) DEFAULT 0.00,
    total_deposits DECIMAL(20,2) DEFAULT 0.00,
    total_withdrawals DECIMAL(20,2) DEFAULT 0.00,
    net_deposits DECIMAL(20,2) DEFAULT 0.00,
    staking_amount DECIMAL(20,2) DEFAULT 0.00,
    insurance_fund_stake DECIMAL(20,2) DEFAULT 0.00,
    total_trades INTEGER DEFAULT 0,
    active_trading_days INTEGER DEFAULT 0,
    last_trade_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(user_id)
);
```

#### **4. Trading Activity Log**
```sql
-- Copy this into Supabase SQL Editor
CREATE TABLE trading_activity_log (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    period_id UUID REFERENCES points_allocation_periods(id) ON DELETE CASCADE,
    activity_type VARCHAR(50) NOT NULL,
    amount DECIMAL(20,2) NOT NULL,
    market_symbol VARCHAR(20),
    side VARCHAR(10),
    leverage DECIMAL(5,2),
    points_earned INTEGER DEFAULT 0,
    multiplier_applied DECIMAL(5,2) DEFAULT 1.00,
    bonus_type VARCHAR(50),
    created_at TIMESTAMP DEFAULT NOW(),
    metadata JSONB DEFAULT '{}'
);

-- Add constraints
ALTER TABLE trading_activity_log 
ADD CONSTRAINT check_valid_activity_type 
CHECK (activity_type IN ('trade', 'deposit', 'withdrawal', 'staking', 'insurance_fund'));

ALTER TABLE trading_activity_log 
ADD CONSTRAINT check_valid_side 
CHECK (side IS NULL OR side IN ('long', 'short', 'buy', 'sell', 'maker', 'taker'));

ALTER TABLE trading_activity_log 
ADD CONSTRAINT check_positive_amount 
CHECK (amount > 0);

ALTER TABLE trading_activity_log 
ADD CONSTRAINT check_reasonable_leverage 
CHECK (leverage IS NULL OR (leverage >= 1 AND leverage <= 100));
```

### **Phase 2: Security Tables**

#### **5. Rate Limiting**
```sql
-- Copy this into Supabase SQL Editor
CREATE TABLE user_rate_limits (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    activity_type VARCHAR(50) NOT NULL,
    window_start TIMESTAMP NOT NULL,
    activity_count INTEGER DEFAULT 0,
    last_activity TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(user_id, activity_type, window_start)
);
```

#### **6. Fraud Detection**
```sql
-- Copy this into Supabase SQL Editor
CREATE TABLE fraud_detection_log (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    activity_type VARCHAR(50) NOT NULL,
    amount DECIMAL(20,2) NOT NULL,
    suspicion_score DECIMAL(5,2) NOT NULL,
    detection_reason TEXT NOT NULL,
    is_flagged BOOLEAN DEFAULT false,
    reviewed_by UUID REFERENCES users(id),
    reviewed_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW()
);
```

#### **7. System Configuration**
```sql
-- Copy this into Supabase SQL Editor
CREATE TABLE system_config (
    config_key VARCHAR(100) PRIMARY KEY,
    config_value JSONB NOT NULL,
    description TEXT,
    updated_at TIMESTAMP DEFAULT NOW()
);

-- Insert default configurations
INSERT INTO system_config (config_key, config_value, description) VALUES
('point_calculation_percentages', '{"trade": 0.01, "deposit": 0.02, "staking": 0.03, "insurance_fund": 0.05}', 'Base percentages for point calculation'),
('rate_limits', '{"max_activities_per_hour": 100, "max_activities_per_day": 1000}', 'Rate limiting configuration'),
('fraud_detection', '{"suspicious_multiplier": 10, "min_activity_amount": 1, "max_suspicion_score": 4.0}', 'Fraud detection thresholds'),
('multiplier_limits', '{"max_base_multiplier": 10, "max_bonus_multiplier": 10}', 'Maximum allowed multipliers');
```

### **Phase 3: Indexes (Performance)**

#### **8. Performance Indexes**
```sql
-- Copy this into Supabase SQL Editor
-- Core indexes
CREATE INDEX idx_trading_metrics_user_id ON trading_metrics(user_id);
CREATE INDEX idx_trading_metrics_trading_volume ON trading_metrics(total_trading_volume DESC);
CREATE INDEX idx_trading_metrics_net_deposits ON trading_metrics(net_deposits DESC);
CREATE INDEX idx_trading_metrics_staking_amount ON trading_metrics(staking_amount DESC);
CREATE INDEX idx_trading_metrics_insurance_fund_stake ON trading_metrics(insurance_fund_stake DESC);

-- Activity log indexes
CREATE INDEX idx_trading_activity_log_user_id ON trading_activity_log(user_id);
CREATE INDEX idx_trading_activity_log_activity_type ON trading_activity_log(activity_type);
CREATE INDEX idx_trading_activity_log_created_at ON trading_activity_log(created_at);
CREATE INDEX idx_trading_activity_log_period_id ON trading_activity_log(period_id);

-- Period indexes
CREATE INDEX idx_points_allocation_periods_is_active ON points_allocation_periods(is_active);
CREATE INDEX idx_points_allocation_periods_period_type ON points_allocation_periods(period_type);

-- Multiplier indexes
CREATE INDEX idx_activity_multipliers_period_id ON activity_multipliers(period_id);
CREATE INDEX idx_activity_multipliers_activity_type ON activity_multipliers(activity_type);

-- Security indexes
CREATE INDEX idx_user_rate_limits_user_id ON user_rate_limits(user_id);
CREATE INDEX idx_user_rate_limits_activity_type ON user_rate_limits(activity_type);
CREATE INDEX idx_user_rate_limits_window_start ON user_rate_limits(window_start);
CREATE INDEX idx_fraud_detection_user_id ON fraud_detection_log(user_id);
CREATE INDEX idx_fraud_detection_flagged ON fraud_detection_log(is_flagged);
CREATE INDEX idx_fraud_detection_score ON fraud_detection_log(suspicion_score DESC);
```

---

## ðŸ”§ **Supabase Functions (Copy & Paste)**

### **Core Functions**

#### **1. Active User Detection**
```sql
-- Copy this into Supabase SQL Editor
CREATE OR REPLACE FUNCTION is_active_user(user_uuid UUID)
RETURNS BOOLEAN AS $$
DECLARE
    recent_activity_count INTEGER;
    days_since_last_activity INTEGER;
BEGIN
    -- Check if user has activity in last 30 days
    SELECT COUNT(*) INTO recent_activity_count
    FROM trading_activity_log 
    WHERE user_id = user_uuid 
    AND created_at > NOW() - INTERVAL '30 days';
    
    -- Check days since last activity
    SELECT EXTRACT(DAYS FROM NOW() - MAX(created_at)) INTO days_since_last_activity
    FROM trading_activity_log 
    WHERE user_id = user_uuid;
    
    -- User is active if they have recent activity OR joined recently
    RETURN recent_activity_count > 0 OR days_since_last_activity IS NULL OR days_since_last_activity <= 7;
END;
$$ LANGUAGE plpgsql;
```

#### **2. Rate Limiting**
```sql
-- Copy this into Supabase SQL Editor
CREATE OR REPLACE FUNCTION check_rate_limit(
    user_uuid UUID,
    activity_type_param VARCHAR(50),
    max_activities_per_hour INTEGER DEFAULT 100,
    max_activities_per_day INTEGER DEFAULT 1000
)
RETURNS BOOLEAN AS $$
DECLARE
    hourly_count INTEGER;
    daily_count INTEGER;
    current_hour TIMESTAMP;
    current_day TIMESTAMP;
BEGIN
    -- Get current hour and day boundaries
    current_hour := date_trunc('hour', NOW());
    current_day := date_trunc('day', NOW());
    
    -- Check hourly rate limit
    SELECT COALESCE(SUM(activity_count), 0) INTO hourly_count
    FROM user_rate_limits
    WHERE user_id = user_uuid
    AND activity_type = activity_type_param
    AND window_start >= current_hour;
    
    -- Check daily rate limit
    SELECT COALESCE(SUM(activity_count), 0) INTO daily_count
    FROM user_rate_limits
    WHERE user_id = user_uuid
    AND activity_type = activity_type_param
    AND window_start >= current_day;
    
    -- Return false if limits exceeded
    RETURN hourly_count < max_activities_per_hour AND daily_count < max_activities_per_day;
END;
$$ LANGUAGE plpgsql;
```

#### **3. Fraud Detection**
```sql
-- Copy this into Supabase SQL Editor
CREATE OR REPLACE FUNCTION detect_suspicious_activity(
    user_uuid UUID,
    activity_type_param VARCHAR(50),
    activity_amount DECIMAL(20,2)
)
RETURNS DECIMAL(5,2) AS $$
DECLARE
    avg_amount DECIMAL(20,2);
    max_amount DECIMAL(20,2);
    recent_count INTEGER;
    suspicion_score DECIMAL(5,2) := 0;
    detection_reason TEXT := '';
BEGIN
    -- Get user's average activity amount
    SELECT AVG(amount), MAX(amount), COUNT(*) INTO avg_amount, max_amount, recent_count
    FROM trading_activity_log 
    WHERE user_id = user_uuid
    AND activity_type = activity_type_param
    AND created_at > NOW() - INTERVAL '30 days';
    
    -- If no recent activity, set baseline
    IF avg_amount IS NULL THEN
        avg_amount := 100; -- Default baseline
        max_amount := 1000; -- Default max
        recent_count := 0;
    END IF;
    
    -- Calculate suspicion score
    -- Score 1: Amount significantly above average
    IF activity_amount > (avg_amount * 10) THEN
        suspicion_score := suspicion_score + 3.0;
        detection_reason := detection_reason || 'Amount 10x above average; ';
    ELSIF activity_amount > (avg_amount * 5) THEN
        suspicion_score := suspicion_score + 2.0;
        detection_reason := detection_reason || 'Amount 5x above average; ';
    ELSIF activity_amount > (avg_amount * 2) THEN
        suspicion_score := suspicion_score + 1.0;
        detection_reason := detection_reason || 'Amount 2x above average; ';
    END IF;
    
    -- Score 2: Amount above historical max
    IF activity_amount > max_amount THEN
        suspicion_score := suspicion_score + 2.0;
        detection_reason := detection_reason || 'Above historical max; ';
    END IF;
    
    -- Score 3: High frequency activity
    IF recent_count > 50 THEN
        suspicion_score := suspicion_score + 1.0;
        detection_reason := detection_reason || 'High frequency activity; ';
    END IF;
    
    -- Score 4: Very large amounts
    IF activity_amount > 100000 THEN -- $100k+
        suspicion_score := suspicion_score + 2.0;
        detection_reason := detection_reason || 'Very large amount; ';
    END IF;
    
    -- Log suspicious activity if score > 2
    IF suspicion_score > 2.0 THEN
        INSERT INTO fraud_detection_log (
            user_id, activity_type, amount, suspicion_score, detection_reason, is_flagged
        ) VALUES (
            user_uuid, activity_type_param, activity_amount, suspicion_score, 
            TRIM(detection_reason), suspicion_score > 4.0
        );
    END IF;
    
    RETURN suspicion_score;
END;
$$ LANGUAGE plpgsql;
```

---

## ðŸš€ **Supabase Implementation Steps**

### **Step 1: Access Supabase Dashboard**
1. Go to your Supabase project dashboard
2. Navigate to **SQL Editor**
3. Create a new query

### **Step 2: Create Tables (Phase 1)**
1. Copy and paste each table creation SQL
2. Execute each query individually
3. Verify tables are created in **Table Editor**

### **Step 3: Add Constraints**
1. Copy and paste constraint SQL
2. Execute each constraint individually
3. Verify constraints in **Table Editor**

### **Step 4: Create Functions (Phase 2)**
1. Copy and paste each function SQL
2. Execute each function individually
3. Verify functions in **Database Functions**

### **Step 5: Add Indexes (Phase 3)**
1. Copy and paste index SQL
2. Execute indexes individually
3. Verify performance in **Table Editor**

### **Step 6: Test the System**
1. Insert test data
2. Test functions
3. Verify constraints work

---

## ðŸ“Š **Testing in Supabase**

### **Test Data Insertion**
```sql
-- Copy this into Supabase SQL Editor to test
-- Insert test period
INSERT INTO points_allocation_periods (
    period_name, period_type, start_date, end_date, total_points_pool, is_active
) VALUES (
    'Test Season 1', 'foundation', NOW(), NOW() + INTERVAL '3 months', 1000000, true
);

-- Insert test multipliers
INSERT INTO activity_multipliers (period_id, activity_type, base_multiplier, early_user_bonus, active_user_bonus, community_bonus)
SELECT id, 'trading_volume', 1.00, 2.00, 1.50, 1.20
FROM points_allocation_periods WHERE period_name = 'Test Season 1';

-- Test function
SELECT is_active_user('00000000-0000-0000-0000-000000000000'::UUID);
```

---

## ðŸŽ¯ **Benefits of This Approach**

### **âœ… Immediate Results:**
- **Instant Changes** - No migration files to apply
- **Visual Feedback** - See tables and relationships immediately
- **Easy Testing** - Test functions directly in SQL Editor
- **Quick Iteration** - Make changes and test immediately

### **âœ… Reference Documentation:**
- **Complete Schema** - SQL files show everything
- **Version Control** - Track what was built
- **Team Collaboration** - Everyone can see the reference
- **Deployment Ready** - Can apply to other environments

### **âœ… Best of Both Worlds:**
- **Supabase Speed** - Immediate implementation
- **SQL Documentation** - Complete reference
- **Flexibility** - Can switch approaches later
- **Professional** - Proper version control

---

## ðŸŽ‰ **Implementation Summary**

**This hybrid approach gives you:**

1. **Immediate Implementation** - Build directly in Supabase
2. **Complete Documentation** - SQL files as reference
3. **Version Control** - Track all changes
4. **Team Collaboration** - Everyone sees the same schema
5. **Deployment Ready** - Can apply to other environments
6. **Professional Approach** - Best practices maintained

**Ready to start building in Supabase!** ðŸš€

---

**QuantDesk Hybrid Points System - Supabase Implementation**  
**Generated by @dev**  
**Date:** December 25, 2024  
**Status:** ðŸ”„ **SUPABASE IMPLEMENTATION READY** - Hybrid Approach
